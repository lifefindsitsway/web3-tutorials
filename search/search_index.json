{"config":{"lang":["en"],"separator":"[\\s\\u200b\\u3000\\-\u3001\u3002\uff0c\uff0e\uff1f\uff01\uff1b]+","pipeline":["stemmer"]},"docs":[{"location":"","title":"Welcome to My Blog","text":"<p>Hi! Nice to see you! I'm a Web3 developer.</p> <ul> <li>X (Twitter)\uff1a@lifefind_itsway</li> <li>Github\uff1aLifefindsitsway</li> <li>Notion Page\uff1aWeb3 Tutorials</li> </ul> File Name Description Crypto Laws \u6574\u7406 Crypto \u9886\u57df\u7684\u6cd5\u5f8b\u6cd5\u89c4\u4fe1\u606f\u3001\u53f8\u6cd5\u6848\u4f8b Blockchain &amp; Crypto &amp; Web3 \u6574\u7406 Blockchain &amp; Crypto &amp; Web3 \u76f8\u5173\u8d44\u6599 DeFi &amp; DAPP Development Tutorials DAPP\u3001DeFi \u76f8\u5173\u8d44\u6599 Web3 Entrepreneurship Web3 \u521b\u4e1a\u76f8\u5173 Meme Meme \u4f18\u8d28\u8d44\u6599"},{"location":"changelog/","title":"\u66f4\u65b0\u65e5\u5fd7","text":"<ul> <li>2025-12-30\uff1aSolidity \u4ee3\u7406\u5408\u7ea6\u4e0e\u53ef\u5347\u7ea7\u5408\u7ea6\u7cfb\u5217\uff08\u4e8c\uff09\uff1a\u900f\u660e\u4ee3\u7406 vs UUPS</li> <li>2025-12-29\uff1aSolidity \u4ee3\u7406\u5408\u7ea6\u4e0e\u53ef\u5347\u7ea7\u5408\u7ea6\u7cfb\u5217\uff08\u4e00\uff09\uff1a\u4e3a\u4ec0\u4e48\u9700\u8981\u53ef\u5347\u7ea7\uff1f</li> <li>2025-12-27\uff1aSolidity \u5408\u7ea6\u95f4\u8c03\u7528\uff08\u4e09\uff09\uff1a\u521b\u5efa\u5408\u7ea6\u7684\u4e24\u79cd\u65b9\u5f0f\uff1acreate \u4e0e create2</li> <li>2025-12-23\uff1aSolidity \u5408\u7ea6\u95f4\u8c03\u7528\uff08\u4e8c\uff09\uff1a\u5e95\u5c42\u8c03\u7528\u4e0e calldata \u8be6\u89e3</li> <li>2025-12-21\uff1aSolidity \u5408\u7ea6\u95f4\u8c03\u7528\uff08\u4e00\uff09\uff1a\u56db\u79cd\u65b9\u5f0f\u8c03\u7528\u5df2\u90e8\u7f72\u5408\u7ea6</li> <li>2025-11-25\uff1aSolidity \u5730\u5740\u7c7b\u578b &amp; \u5e38\u89c1\u7528\u6cd5\u5168\u653b\u7565</li> <li>2025-11-20\uff1a\u4e3a\u4ec0\u4e48\u4ee5\u592a\u574a\u5730\u5740\u662f 20 \u5b57\u8282\uff1f\u4ece\u79c1\u94a5\u5230\u5730\u5740\u7684\u5168\u89e3\u6790</li> <li>2024-07-10\uff1aUniswap V2 \u4ef7\u683c\u7cbe\u5ea6\u89e3\u6790</li> <li>2024-04-15\uff1aHardhat \u5165\u95e8\u6307\u5357\uff0825\u5e74\u66f4\u65b0\u7248\uff09</li> <li>2024-02-13\uff1a\u6bd4\u7279\u5e01\u7684\u8bde\u751f\u5386\u7a0b</li> </ul>"},{"location":"blockchain/the_evolution_of_bitcoin_240213/","title":"\u6bd4\u7279\u5e01\u7684\u8bde\u751f\u5386\u7a0b","text":"<p>\u6bd4\u7279\u5e01\u5e76\u975e\u6a2a\u7a7a\u51fa\u4e16\u7684\u5355\u70b9\u521b\u65b0\uff0c\u800c\u662f\u5c06\u6570\u5341\u5e74\u95f4\u5173\u4e8e\u79c1\u4eba\u8d27\u5e01\u3001\u5bc6\u7801\u5b66\u9690\u79c1\u5de5\u5177\u3001\u70b9\u5bf9\u70b9\u7f51\u7edc\u4e0e\u5de5\u4f5c\u91cf\u8bc1\u660e\u7b49\u591a\u6761\u6f14\u8fdb\u8def\u5f84\uff0c\u5728 2008-2009 \u5e74\u7684\u5386\u53f2\u7a97\u53e3\u671f\u5185\uff0c\u7ec4\u5408\u4e3a\u4e00\u4e2a\u53ef\u8fd0\u884c\u7684\u3001\u5f00\u653e\u53c2\u4e0e\u3001\u6297\u5ba1\u67e5\u7684\u7535\u5b50\u73b0\u91d1\u7cfb\u7edf\u3002</p> <p>\u6839\u636e \"Bitcoin 101: past, present and future\" \u6574\u7406\u5982\u4e0b\uff1a</p> <p>1933 \u5e74\uff0c\u5bcc\u5170\u514b\u6797\u00b7\u7f57\u65af\u798f\uff08Franklin Roosevelt\uff09\u603b\u7edf\u7b7e\u7f72\u4e86 6102 \u53f7\u884c\u653f\u4ee4\uff0c\u7981\u6b62\u79c1\u4eba\u4f7f\u7528\u76f4\u63a5\u5f62\u5f0f\u7684\u8d27\u5e01\uff08\u4f8b\u5982\u91d1\u675c\u5e03\u9686\uff08doubloons\uff09\u548c\u91d1\u5e01\uff09\u548c\u95f4\u63a5\u5f62\u5f0f\u7684\u8d27\u5e01\uff08\u4f8b\u5982\u4ee3\u8868\u62b5\u62bc\u54c1\u7684\u94f6\u884c\u7968\u636e\u548c\u91d1\u5757\uff09\uff0c\u653f\u5e9c\u6ca1\u6536\u4e86\u6240\u6709\u516c\u6c11\u7684\u9ec4\u91d1\uff0c\u8fd9\u4ef6\u4e8b\u5bf9\u7406\u89e3\u6bd4\u7279\u5e01\u7684\u5386\u53f2\u6781\u4e3a\u91cd\u8981\uff0c\u56e0\u4e3a\u8fd9\u4ef6\u4e8b\u60c5\u53d1\u751f\u5728\u88ab\u8ba4\u4e3a\u662f\u201c\u81ea\u7531\u5927\u9646\u201d\u3001\u5baa\u653f\u81ea\u7531\u6c11\u4e3b\u653f\u4f53\u7684\u6545\u4e61\uff1b</p> <p>\u4e00\u4e2a\u5947\u602a\u7684\u4e8b\u5b9e\u662f\uff0c\u4e2d\u672c\u806a\u5c06\u81ea\u5df1\u7684\u51fa\u751f\u65e5\u671f\u5199\u4e3a 1975 \u5e74\u7684 4 \u6708 5 \u65e5\uff1a4 \u6708 5 \u65e5\u6b63\u662f\u7f57\u65af\u798f\u7b7e\u7f72 6102 \u53f7\u884c\u653f\u4ee4\u7684\u65f6\u95f4\uff0c\u800c 1975 \u5e74\u662f Gerald Ford\uff08\u6770\u62c9\u5c14\u5fb7\u00b7\u798f\u7279\uff09\u603b\u7edf\u53d6\u6d88\u8fd9\u4e00\u884c\u653f\u4ee4\u7684\u65f6\u95f4\u3002</p> <p>\u6bd4\u7279\u5e01\u7684\u96be\u5ea6\u8c03\u6574\u7b97\u6cd5\u662f\u6bcf 2016 \u4e2a\u533a\u5757\u53d1\u751f\u4e00\u6b21\uff0c\u8fd9\u4e2a\u6570\u5b57\u6b63\u662f\u4e0a\u8ff0\u884c\u653f\u4ee4\u7684\u7f16\u53f7\uff086102\uff09\u7684\u5012\u5e8f\u3002 </p> <p>1936 \u5e74\uff0cAlan Turing\uff08\u963f\u5170\u00b7\u56fe\u7075\uff09\u53d1\u8868\u300a\u8bba\u53ef\u8ba1\u7b97\u7684\u6570\u5b57\u4ee5\u53ca\u53ef\u5224\u5b9a\u6027\u7684\u8fd0\u7528\u300b\uff0c\u4e3a\u4fe1\u606f\u9769\u547d\u5960\u5b9a\u4e86\u7406\u8bba\u57fa\u7840\uff1b</p> <p>1971 \u5e74\uff0c\u5c3c\u514b\u677e\u6682\u505c\u7f8e\u5143\u4e0e\u9ec4\u91d1\u7684\u6c47\u5151\uff1b</p> <p>1976 \u5e74\uff0c\u7814\u7a76\u5458 Diffie\uff08\u8fea\u83f2\uff09\u548c Hellman\uff08\u8d6b\u5c14\u66fc\uff09\u53d1\u8868\u300a\u5bc6\u7801\u5b66\u7684\u65b0\u65b9\u5411\u300b\uff0c\u975e\u5bf9\u79f0\u5bc6\u7801\u5b66\u7406\u8bba\u8bde\u751f\uff1b</p> <p>1978 \u5e74</p> <ul> <li>Rivest\uff08\u674e\u7ef4\u65af\u7279\uff09\u3001Shamir\uff08\u6c99\u7c73\u5c14\uff09\u548c Adleman\uff08\u963f\u5fb7\u5c14\u66fc\uff09\u53d1\u8868\u300a\u4e00\u79cd\u83b7\u5f97\u6570\u5b57\u7b7e\u540d\u548c\u516c\u94a5\u5bc6\u7801\u7cfb\u7edf\u7684\u65b9\u6cd5\u300b\uff0c\u4f7f\u975e\u5bf9\u79f0\u5bc6\u7801\u5b66\u6210\u4e3a\u73b0\u5b9e\uff1b</li> <li>Hayek\uff08\u54c8\u8036\u514b\uff09\u51fa\u7248\u300a\u8d27\u5e01\u7684\u53bb\u56fd\u5bb6\u5316\u300b\uff0c\u53cd\u5bf9\u56fd\u5bb6\u5bf9\u8d27\u5e01\u7684\u5784\u65ad\uff1b</li> </ul> <p>1979 \u5e74\uff0cRalph Merkle\uff08\u62c9\u5c14\u592b\u00b7\u9ed8\u514b\u5c14\uff0cMerkle Tree \u7684\u63d0\u51fa\u8005\uff09\u4e3a Merkle Tree \u7684\u60f3\u6cd5\u7533\u8bf7\u4e13\u5229\uff1b</p> <p>1980 \u5e74\uff0cSamuel Konkin III \u53d1\u8868\u300a\u65b0\u81ea\u7531\u610f\u5fd7\u4e3b\u4e49\u5ba3\u8a00\u300b\uff0c\u5021\u5bfc\u4e00\u79cd\u6fc0\u8fdb\u7684\u601d\u60f3\uff1a\u201c\u5149\u53d9\u8bf4\u81ea\u7531\u7684\u7f8e\u4e3d\u548c\u7edf\u6cbb\u7684\u4e11\u964b\u662f\u4e0d\u591f\u7684\uff0c\u6211\u4eec\u8fd8\u5fc5\u987b\u91c7\u53d6\u52a1\u5b9e\u7684\u884c\u52a8\uff0c\u5f00\u53d1\u51fa\u80fd\u591f\u62b5\u5fa1\u7edf\u6cbb\u7684\u6280\u672f\u5de5\u5177\u3002\u201d\uff0c\u8fd9\u79cd\u601d\u60f3\u540e\u6765\u88ab\u201c\u5bc6\u7801\u670b\u514b\u201d\u8fd0\u52a8\u7ee7\u627f\u4e86\uff1b</p> <p>1981 \u5e74</p> <ul> <li>\u4e92\u8054\u7f51\u534f\u8bae\uff08IP\uff09\u53d1\u884c\u4e86\u7b2c\u56db\u7248\uff08IPv4\uff09\uff1b</li> <li>David Chaum\uff08\u5927\u536b\u00b7\u4e54\u59c6\uff09\u8bbe\u60f3\u4e86\u4e00\u79cd\u4f7f\u7528\u6570\u5b57\u5047\u540d\u3001\u65e0\u6cd5\u8ffd\u8e2a\u7684\u7535\u5b50\u90ae\u4ef6\u534f\u8bae\uff0c\u5e76\u51fa\u7248\u4e86\u300a\u4e0d\u53ef\u8ffd\u8e2a\u7684\u7535\u5b50\u90ae\u4ef6\u3001\u8fd4\u56de\u5730\u5740\u4ee5\u53ca\u7535\u5b50\u5047\u540d\u300b\uff0c\u6807\u5fd7\u7740\u4f7f\u7528\u975e\u5bf9\u79f0\u5bc6\u7801\u5b66\u6765\u7b7e\u540d\u6d88\u606f\uff08\u800c\u975e\u52a0\u5bc6\u6587\u672c\uff09\u7684\u7528\u6cd5\u7684\u5f00\u7aef\uff1b</li> </ul> <p>1982 \u5e74\uff0c\u300a\u81ea\u7531\u7684\u4f26\u7406\u300b\u5efa\u8bae\u5e9f\u9664\u7f8e\u56fd\u8054\u90a6\u50a8\u5907\u59d4\u5458\u4f1a\uff0c\u56de\u5230\u5e02\u573a\u5316\u8d27\u5e01\u6a21\u5f0f\uff1b</p> <p>1983 \u5e74\uff0cDavid Chaum \u51fa\u7248\u300a\u7528\u4e8e\u4e0d\u53ef\u8ffd\u8e2a\u7684\u652f\u4ed8\u7684\u76f2\u7b7e\u540d\u300b\uff0c\u7b2c\u4e00\u6b21\u63d0\u51fa\u4f7f\u7528\u5bc6\u7801\u5b66\u7b7e\u540d\u7cfb\u7edf\u6765\u6784\u9020\u4e0d\u53ef\u8ffd\u8e2a\u7684\u7535\u5b50\u652f\u4ed8\u7684\u60f3\u6cd5\uff1b</p> <p>1985 \u5e74\uff0c\u51fa\u7248\u300a\u692d\u5706\u66f2\u7ebf\u5bc6\u7801\u5b66\u300b\uff0c\u63d0\u51fa\u4e86\u4e00\u79cd\u57fa\u4e8e\u6709\u9650\u57df\u692d\u5706\u66f2\u7ebf\u3001\u66ff\u4ee3 RSA \u7684\u516c\u94a5\u7b7e\u540d\u7b97\u6cd5\uff1b</p> <p>1988 \u5e74\uff0cTimothy May\uff08\u8482\u83ab\u897f\u00b7\u6885\uff09\u53d1\u8868\u300a\u5bc6\u7801\u65e0\u653f\u5e9c\u4e3b\u4e49\u5ba3\u8a00\u300b\uff0c\u603b\u7ed3\u90e8\u5206\u5199\u9053\uff1a\u201c\u5728\u7269\u7406\u4e16\u754c\u4e2d\uff0c\u56fd\u5bb6\u63a7\u5236\u7740\u6211\u4eec\uff0c\u4f46\u5728\u4e92\u8054\u7f51\u7684\u7535\u5b50\u4e16\u754c\u4e2d\uff0c\u611f\u8c22\u5bc6\u7801\u5b66\uff0c\u53ea\u8981\u6211\u4eec\u5f00\u53d1\u51fa\u4e86\u6b63\u786e\u7684\u5de5\u5177\uff0c\u56fd\u5bb6\u5c31\u65e0\u6cd5\u63a7\u5236\u6211\u4eec\u3002\u6211\u4eec\u53ef\u4ee5\u521b\u9020\u5047\u540d\u3001\u4ea4\u6362\u601d\u60f3\u670d\u52a1\u548c\u4ea7\u54c1\uff0c\u800c\u4e0d\u5fc5\u5fcd\u53d7\u76d1\u89c6\u201d\uff1b</p> <p>1989 \u5e74\uff0cDavid Chaum \u57fa\u4e8e\u975e\u5bf9\u79f0\u5bc6\u7801\u5b66\u548c\u76f2\u7b7e\u540d\u5f00\u53d1\u4e86 DigiCash\uff0c\u5b83\u57fa\u4e8e\u7535\u5b50\u8d27\u5e01 Ecash\uff0cEcash \u53ef\u4ee5\u5728\u7f51\u7edc\u4e2d\u4f20\u8f93\u3001\u7528\u4e8e\u5b8c\u6210\u5728\u7ebf\u652f\u4ed8\uff0c\u7528\u6237\u53ef\u4ee5\u4ece\u94f6\u884c\u548c\u5176\u5b83\u91d1\u878d\u673a\u6784\u8d2d\u4e70 Ecash\uff0c\u5b9e\u73b0\u5feb\u901f\u548c\u5b89\u5168\u7684\u652f\u4ed8\uff1b</p> <p>\u8fd9\u8fd8\u4e0d\u662f\u6bd4\u7279\u5e01\uff0c\u4f46\u6211\u4eec\u79bb\u5b83\u66f4\u8fd1\u4e86\u3002 </p> <p>1990 \u5e74\uff0cClaus Schnorr\uff08\u514b\u52b3\u65af\u00b7\u65bd\u8bfa\u5c14\uff09\u4e3a\u4e00\u79cd\u4f7f\u7528\u692d\u5706\u66f2\u7ebf\u5bc6\u7801\u5b66\u7684\u7b7e\u540d\u7b97\u6cd5\u7533\u8bf7\u4e86\u4e13\u5229\uff0c\u5bf9\u6bd4\u7279\u5e01\u7684\u65e5\u540e\u6539\u8fdb\uff08\u4f8b\u5982 taproot\uff09\u975e\u5e38\u91cd\u8981\uff1b</p> <p>\u5728 2008 \u5e74\uff0cSatoshi Nakamoto\uff08\u4e2d\u672c\u806a\uff09\u5e76\u6ca1\u6709\u4f7f\u7528 Schnorr \u7b7e\u540d\uff0c\u867d\u7136\u90a3\u4e2a\u65f6\u5019 Schnorr \u7684\u4e13\u5229\u5df2\u7ecf\u5230\u671f\u4e86\uff0c\u4f46\u4e2d\u672c\u806a\u8ba4\u4e3a\u5c06\u8fd9\u4e48\u91cd\u8981\u7684\u7cfb\u7edf\u6784\u7b51\u5728\u4e00\u79cd\u65b0\u7684\u3001\u672a\u7ecf\u751f\u4ea7\u73af\u5883\u8003\u9a8c\u3001\u7f3a\u4e4f\u5ba1\u8ba1\u3001\u6d4b\u8bd5\u548c\u540c\u884c\u8bc4\u8bae\u7684\u6280\u672f\u4e0a\uff0c\u53ef\u80fd\u6709\u5371\u9669\u3002\u76f8\u53cd\uff0c\u4ed6\u9009\u62e9\u4e86\u4e0d\u90a3\u4e48\u9ad8\u6548\u7684 ECDSA \u7684\u7b97\u6cd5\uff0cECDSA \u8fd8\u4e0d\u50cf Schnorr \u7b7e\u540d\u90a3\u6837\u652f\u6301\u7b7e\u540d\u805a\u5408\u3002 </p> <p>1991 \u5e74</p> <ul> <li>Phil Zimmermann\uff08\u83f2\u5c14\u00b7\u9f50\u9ed8\u5c14\u66fc\uff09\u53d1\u660e\u4e86 PGP (Pretty Good Privacy) \u8f6f\u4ef6\uff0c\u5b83\u7684\u4f5c\u7528\u5c31\u662f\u4e3a\u7528\u6237\u751f\u6210\u4e00\u5bf9\u516c\u79c1\u94a5\u3002\u516c\u94a5\u7528\u6765\u52a0\u5bc6\u8981\u53d1\u7ed9\u5176\u6240\u6709\u8005\u7684\u6d88\u606f\uff0c\u800c\u5176\u4eba\u7684\u79c1\u94a5\u5219\u7528\u6765\u89e3\u5bc6\u8fd9\u6837\u7684\u4fe1\u606f\u548c\u6587\u6863\uff1b</li> <li>\u7814\u7a76\u5458 Haber \u548c Stornetta \u53d1\u8868\u8bba\u6587\u300a\u5982\u4f55\u4e3a\u7535\u5b50\u6587\u6863\u6dfb\u52a0\u65f6\u95f4\u6233\u300b\uff08\u4e2d\u672c\u806a\u5728\u6bd4\u7279\u5e01\u8bba\u6587\u4e2d\u4e5f\u5f15\u7528\u4e86\u8fd9\u7bc7\u6587\u7ae0\uff09\uff0c\u5728\u8be5\u6587\u4e2d\uff0c\u4e24\u4f4d\u7814\u7a76\u5458\u53d1\u6398\u4e86\u8bc1\u660e\u4e00\u4efd\u6587\u6863\u5728\u7ed9\u5b9a\u65f6\u95f4\u5c31\u5df2\u5b58\u5728\u7684\u6280\u672f\uff0c\u4f46\u6bd4\u7279\u5e01\u5fc5\u987b\u505a\u5230\u66f4\u591a\uff1a\u5728\u76f8\u540c\u7684\u65f6\u95f4\u95f4\u9694\u540c\u65f6\u8bc1\u660e\u201c\u5b58\u5728\u6027\u201d\u548c\u201c\u552f\u4e00\u6027\u201d\uff1b</li> </ul> <p>1992 \u5e74\uff0c\u5bc6\u7801\u670b\u514b\u56e2\u4f53\u5728\u65e7\u91d1\u5c71\u8bde\u751f\uff0c\u81ea\u7531\u610f\u5fd7\u4e3b\u4e49\u7684\u79ef\u6781\u5206\u5b50\u4e3b\u5f20\u5927\u91cf\u8fd0\u7528\u8ba1\u7b97\u673a\u5bc6\u7801\u5b66\uff0c\u4f5c\u4e3a\u793e\u4f1a\u548c\u653f\u6cbb\u53d8\u9769\u7684\u8def\u5f84\uff1b</p> <p>\u8457\u540d\u8bb0\u8005 Julian Assange\uff08\u6731\u5229\u5b89\u00b7\u963f\u6851\u5947\uff09\u4e5f\u662f\u8fd9\u4e2a\u56e2\u4f53\u7684\u6210\u5458\u3002 </p> <p>1993 \u5e74\uff0c\u300a\u5bc6\u7801\u670b\u514b\u5ba3\u8a00\u300b\u51fa\u7248\uff0c\u5bc6\u7801\u670b\u514b\u548c\u5bc6\u7801\u65e0\u653f\u5e9c\u4e3b\u4e49\u7684\u533a\u522b\u5728\u4e8e\uff0c\u540e\u8005\u4e3b\u5f20\u4f7f\u7528\u5bc6\u7801\u5b66\u6280\u672f\uff0c\u4f5c\u4e3a\u5728\u793e\u4f1a\u4e2d\u652f\u6301\u65e0\u653f\u5e9c\u4e3b\u4e49\u548c\u4e2a\u4eba\u6ce8\u610f\u7684\u5de5\u5177\uff0c\u4f46\u5bc6\u7801\u670b\u514b\u662f\u4f7f\u7528\u5bc6\u7801\u5b66\u6765\u53d8\u9769\u793e\u4f1a\u548c\u653f\u6cbb\u7684\u6d3b\u52a8\u5bb6\uff1b</p> <p>1994 \u5e74\uff0cTimothy May \u51fa\u7248\u300aThe cyphernomicon\u300b\uff08\u76f4\u8bd1\u4e3a \u201c\u5bc6\u7801\u5b66\u201d\uff09\uff0c\u63a2\u8ba8\u4e86\u5bc6\u7801\u5b66\u6280\u672f\u53ef\u4ee5\u5982\u4f55\u7528\u6765\u4fdd\u62a4\u4e2a\u4eba\u6570\u636e\u7684\u9690\u79c1\u6027\u3001\u521b\u5efa\u7528\u4e8e\u4ea4\u6362\u5546\u54c1\u548c\u670d\u52a1\u7684\u7f51\u7edc\u800c\u65e0\u9700\u653f\u5e9c\u673a\u6784\u7684\u63a7\u5236\u3001\u5728\u65e5\u76ca\u76f8\u4e92\u8fde\u63a5\u7684\u4e16\u754c\u4e2d\u4fdd\u62a4\u8a00\u8bba\u81ea\u7531\uff1b</p> <p>90 \u5e74\u4ee3\u7684\u5bc6\u7801\u5b66\u6218\u4e89\uff08Crypto Wars\uff09\uff1a\u7f8e\u56fd\u653f\u5e9c\u5c06\u5f3a\u52a0\u5bc6\u6280\u672f\u89c6\u4e3a\u519b\u7528\u7269\u54c1\uff0c\u51fa\u53e3\u53d7\u5230\u4e25\u683c\u9650\u5236\uff0c\u6781\u5927\u5730\u9650\u5236\u4e86\u52a0\u5bc6\u6280\u672f\u5728\u5168\u4e16\u754c\u7684\u63a8\u5e7f\u3002</p> <p>1997 \u5e74</p> <ul> <li>Adam Back\uff08\u4e9a\u5f53\u00b7\u8d1d\u514b\uff09\u4e3a\u89e3\u51b3\u5783\u573e\u90ae\u4ef6\u8f70\u70b8\u800c\u63d0\u51fa\u4e86 HashCash\uff0c\u8fd9\u5c31\u662f\u6bd4\u7279\u5e01\u7684\u5de5\u4f5c\u91cf\u8bc1\u660e\uff1b</li> <li>Nick\u00b7Szabo\uff08\u5c3c\u514b\u00b7\u8428\u535a\uff09\u63d0\u51fa\u667a\u80fd\u5408\u7ea6\uff1b</li> <li>\u300a\u4e3b\u6743\u4e2a\u4eba\u300b\u51fa\u7248\uff1b</li> </ul> <p>\u4e2d\u672c\u806a\u5728\u8bba\u6587\u4e2d\u5f15\u7528\u4e86\u4e9a\u5f53\u00b7\u8d1d\u514b\u548c\u4ed6\u7684 HashCash \u8bba\u6587\uff0c\u4f5c\u4e3a\u521b\u9020\u6bd4\u7279\u5e01\u7684\u57fa\u7840\u3002</p> <p>\u4e0d\u8fc7\uff0c\u51fa\u7248\u4e8e 1992 \u5e74\u7684\u8bba\u6587\u300a\u901a\u8fc7\u8fd0\u7b97\u6765\u5b9a\u4ef7\uff0c\u6253\u8d25\u5783\u573e\u90ae\u4ef6\u300b\u5df2\u7ecf\u63d0\u51fa\u4e86\u7c7b\u4f3c\u7684\u60f3\u6cd5\u3002</p> <p>1998 \u5e74</p> <ul> <li>Nick\u00b7Szabo \u53d1\u660e BitGold\uff082005 \u5e74\u624d\u5b8c\u6574\u516c\u5f00\uff09\uff1b</li> <li>Wei Dai \u53d1\u8868\u8bba\u6587 B-Money\uff1b</li> <li>Peter Thiel\uff08\u5f7c\u5f97\u00b7\u8482\u5c14\uff09\u521b\u5efa\u4e86 Confinity\uff0c\u4e00\u79cd\u7528\u4e8e\u7535\u5b50\u5546\u52a1\u7684\u5728\u7ebf\u652f\u4ed8\u7cfb\u7edf\uff0c\u4f46\u4ed6\u7684\u613f\u666f\u7c7b\u4f3c\u4e8e\u6bd4\u7279\u5e01\uff1a\u201c\u5728\u73b0\u5b9e\u4e16\u754c\u4e2d\uff0c\u4f60\u9700\u8981\u8ddf\u4f60\u6240\u5728\u56fd\u5ea6\u7684\u8d27\u5e01\u6253\u4ea4\u9053\uff0c\u4f46\u5230\u4e86\u4e92\u8054\u7f51\u4e0a\uff0c\u4f60\u5c31\u662f\u8d5b\u535a\u7a7a\u95f4\u7684\u516c\u6c11\uff0c\u56e0\u6b64\u662f\u65e0\u56fd\u754c\u7684\u3001\u65e0\u5b98\u50da\u4e3b\u4e49\u7684\uff0c\u4f60\u5c06\u7528 confinty \u8d27\u5e01\u6765\u652f\u4ed8\u3002\u201d\uff1b</li> </ul> <p>Nick\u00b7Szabo \u548c Wei Dai \u7684\u8bbe\u60f3\u90fd\u53d7\u56f0\u4e8e\u540c\u4e00\u4e2a\u95ee\u9898\uff1a\u8d44\u91d1\u53ef\u80fd\u88ab\u91cd\u590d\u82b1\u8d39\uff08Double Spending Attack\uff09\u3002</p> <p>1999 \u5e74</p> <ul> <li>Elon Musk\uff08\u4f0a\u9686\u00b7\u9a6c\u65af\u514b\uff09\u521b\u5efa\u4e86 X.com\uff1b</li> <li>Milton Friedman\uff08\u7c73\u5c14\u987f\u00b7\u5f17\u91cc\u5fb7\u66fc\uff09\u9884\u8a00\uff1a\u201c\u6211\u8ba4\u4e3a\uff0c\u4e92\u8054\u7f51\u5c06\u662f\u524a\u5f31\u653f\u5e9c\u6743\u529b\u5bf9\u4eba\u4eec\u751f\u6d3b\u7684\u5f71\u54cd\u7684\u91cd\u5927\u529b\u91cf\u3002\u4f46\u8fd8\u5c11\u4e86\u4e00\u6837\u4e1c\u897f \u2014\u2014 \u6211\u89c9\u5f97\u5f88\u5feb\u5c31\u4f1a\u6709\u4eba\u53d1\u660e\u51fa\u6765 \u2014\u2014 \u4e00\u79cd\u4e92\u8054\u7f51\u7535\u5b50\u8d27\u5e01\uff0c\u5141\u8bb8 A \u5c06\u8d44\u91d1\u8f6c\u79fb\u7ed9 B \u4e14 B \u4e0d\u5fc5\u8ba4\u8bc6 A\u3002\u8fd9\u6837\u7684\u7cfb\u7edf\u8fd8\u4e0d\u5b58\u5728\uff0c\u4f46\u4e00\u5b9a\u4f1a\u51fa\u73b0\u7684\uff0c\u800c\u4e14\u5b83\u4f1a\u8ba9\u4e92\u8054\u7f51\u53d8\u6210\u6700\u4f1f\u5927\u7684\u53d8\u9769\u3002\u201d</li> </ul> <p>2000 \u5e74\uff0cElon Musk \u7684 X.com \u548c Peter Thiel \u7684 Confinity \u5408\u5e76\u4e86\uff0cPayPal \u7531\u6b64\u8bde\u751f\uff0c\u76d1\u7ba1\u4ecb\u5165\uff0cPayPal \u653e\u5f03\u4e86\u4e92\u8054\u7f51\u8d27\u5e01\u7684\u60f3\u6cd5\uff0c\u8f6c\u800c\u6210\u4e3a\u4e86\u4f20\u7edf\u8d27\u5e01\u7684\u4e00\u4e2a\u652f\u4ed8\u7f51\u7edc\uff1b</p> <p>2001 \u5e74</p> <ul> <li>Bram Cohen\uff08\u5e03\u83b1\u59c6\u00b7\u79d1\u4ea8\uff09\u521b\u5efa BitTorrent\uff0c\u4e00\u79cd\u70b9\u5bf9\u70b9\u7684\u7f51\u7edc\u534f\u8bae\uff0c\u51fa\u73b0\u4e86\u53ef\u4ee5\u4f20\u8f93\u97f3\u4e50\u3001\u89c6\u9891\u548c\u7535\u5b50\u6587\u4ef6\u7684 Napster\uff0c\u4f46\u5b83\u662f\u4ee5\u4e2d\u5fc3\u5316\u7684\u8303\u5f0f\u8fd0\u884c\u7684\uff1b</li> <li>\u7f8e\u56fd\u53d1\u751f 911 \u6050\u6016\u88ad\u51fb\u540e\uff0c\u51fa\u53f0\u4e25\u683c\u7684\u91d1\u878d\u7ba1\u5236\uff08\u5728\u53cd\u6050\u7684\u53e3\u53f7\u4e0b\uff09\uff0c\u5b98\u5458\u8981\u6c42\u6709\u6743\u77e5\u9053\u6bcf\u4e00\u4e2a\u4eba\u7684\u6bcf\u4e00\u7b14\u8d44\u91d1\u52a8\u5411\u4ee5\u53ca\u7406\u7531\uff08\u65e0\u8bba\u662f\u5426\u8eab\u5904\u7f8e\u56fd\u53f8\u6cd5\u8f96\u533a\uff09\uff1b</li> <li>Adam Back \u5411 16 \u5c81\u7684 Peter Todd\uff08\u5f7c\u7279\u00b7\u9676\u5fb7\uff09 \u89e3\u91ca\uff0cHashCash \u4e0d\u4ec5\u53ef\u4ee5\u7528\u4e8e\u5bf9\u6297\u5783\u573e\u90ae\u4ef6\uff0c\u8fd8\u53ef\u4ee5\u4f5c\u4e3a\u7535\u5b50\u73b0\u91d1\u8d27\u5e01\u7cfb\u7edf\u7684\u57fa\u7840\u3002Peter \u5411 Adam \u6307\u51fa\u4e86\u4e00\u4e2a\u95ee\u9898\uff1a\u5982\u679c\u8fd9\u79cd\u5de5\u4f5c\u91cf\u8bc1\u660e\u662f\u53ef\u4ee5\u5728\u4e3b\u4f53\u95f4\u8f6c\u79fb\u7684\uff0c\u90a3\u4e48\u5b83\u5c06\u4f1a\u6076\u6027\u901a\u80c0\uff1b\u63a8\u7406\u8fc7\u7a0b\u662f\uff0c\u4f7f\u7528\u5de5\u4f5c\u91cf\u8bc1\u660e\u53ef\u4ee5\u8bc1\u660e\u4e86\u4f60\u4ed8\u51fa\u4e86\u4e00\u4e9b\u8ba1\u7b97\u4ee3\u4ef7\uff08\u673a\u5668\u7684\u65f6\u95f4\u548c\u80fd\u91cf\uff09\uff0c\u800c\u5173\u952e\u662f\u8ba9\u5de5\u4f5c\u91cf\u8bc1\u660e\u53ef\u4ee5\u8f6c\u79fb\uff0c\u4e5f\u5c31\u662f\u8bc1\u660e\u4e86\u67d0\u4eba\u82b1\u8d39\u4e86\u65f6\u95f4\u548c\u6295\u5165\u4e86\u673a\u5668\uff0c\u800c\u6211\u53ea\u662f\u590d\u7528\u4e86\u5df2\u7ecf\u53d1\u751f\u7684\u8ba1\u7b97\u4ee3\u4ef7\uff1a</li> </ul> <p>\u5728 2001 \u5e74\u5b8c\u6210\u7684\u4e00\u4e2a\u5de5\u4f5c\u91cf\u8bc1\u660e\uff0c\u5c06\u8ddf 2022 \u5e74\u5b8c\u6210\u7684\u5de5\u4f5c\u91cf\u8bc1\u660e\u622a\u7136\u4e0d\u540c\uff0c\u56e0\u4e3a\u673a\u5668\u7684\u8ba1\u7b97\u529b\u662f\u6307\u6570\u589e\u957f\u7684\uff0c\u6240\u4ee5 2001 \u5e74\u7684\u5de5\u4f5c\u91cf\u8bc1\u660e\u4f1a\u53d8\u5f97\u6beb\u65e0\u610f\u4e49\uff1b</p> <p>\u5982\u679c\u4eba\u4eec\u5bf9 \u201c\u7535\u5b50\u8d27\u5e01\u201d \u6709\u5f88\u5927\u7684\u9700\u6c42\uff0c\u90a3\u4e48\u5b83\u7684\u4ef7\u683c\u4f1a\u4e0a\u5347\uff0c\u5176\u76c8\u5229\u7a7a\u95f4\u4e5f\u4f1a\u589e\u52a0\uff0c\u66f4\u591a\u4eba\u4f1a\u5c1d\u8bd5\u52a0\u5165\uff0c\u4ece\u800c\u521b\u9020\u66f4\u591a\u4f9b\u7ed9\u91cf\u3002\u800c\u4f9b\u7ed9\u91cf\u7684\u589e\u52a0\u4f1a\u8ba9\u4ef7\u683c\u56de\u843d\uff1b\u56e0\u6b64\uff0c\u7cdf\u7cd5\u7684\u7ecf\u6d4e\u5468\u671f\u4f1a\u51fa\u73b0\uff0c\u5c31\u50cf\u6cd5\u5e01\u7cfb\u7edf\u4e00\u6837\uff1b</p> <p>\u89e3\u51b3\u65b9\u6848\u5c31\u662f\u81ea\u52a8\u5316\u7684\u96be\u5ea6\u8c03\u6574\uff0c\u8fd9\u5c06\u7531\u4e2d\u672c\u806a\u6765\u5b9e\u73b0\u3002 </p> <p>2003 \u5e74\uff0c\u89c6\u9891\u6e38\u620f Second Life \u7206\u706b\uff0c\u6e38\u620f\u4e2d\u7684 Linden Dollar \u8d27\u5e01\u53ef\u4ee5\u5728\u573a\u5185\u5916\u4ea4\u6362\uff0c\u5355\u4f4d\u4ef7\u503c\u5927\u5927\u8d85\u8fc7\u4e86\u5355\u4f4d\u7f8e\u5143\uff0c\u7ed3\u679c\u62db\u6765\u76d1\u7ba1\u6253\u51fb\uff0c\u88ab\u8feb\u8ba9 Linden Dollar \u8ddf\u7f8e\u5143\u4fdd\u6301 1\uff1a1 \u7684\u951a\u5b9a\u4ef7\u683c\uff1b</p> <p>2004 \u5e74\uff0c\u5bc6\u7801\u670b\u514b Hal Finney\uff08\u54c8\u5c14\u00b7\u82ac\u5c3c\uff0cPGP 2.0 \u7684\u4f5c\u8005\uff09\u53d1\u660e\u201c\u53ef\u590d\u7528\u7684\u5de5\u4f5c\u91cf\u8bc1\u660e\uff08RPOW\uff09\u201d\uff0c\u6700\u7ec8\u8ba9 HashCash \u7684\u5de5\u4f5c\u91cf\u8bc1\u660e\u53d8\u5f97\u53ef\u4ee5\u8f6c\u79fb\uff0c\u4f46\u91cd\u590d\u82b1\u8d39\u95ee\u9898\u4f9d\u7136\u5b58\u5728\uff1b</p> <p>2005 \u5e74\uff0cNick\u00b7Szabo \u5b8c\u6574\u516c\u5f00\u4e86 BitGold\uff08\u6784\u601d\u4e8e 1998 \u5e74\u7684\u7535\u5b50\u8d27\u5e01\uff09\uff0c\u800c\u4e14\u53ef\u4ee5\u8ba4\u4e3a\u5176\u901a\u8fc7\u521b\u5efa\u8d27\u5e01\u4ee5\u53ca\u5bf9\u4ea4\u6613\u5386\u53f2\u6295\u7968\uff0c\u89e3\u51b3\u4e86\u91cd\u590d\u82b1\u8d39\u95ee\u9898\uff1b</p> <p>\u5df2\u7ecf\u975e\u5e38\u63a5\u8fd1\u6bd4\u7279\u5e01\u7684\u60f3\u6cd5\u3002 </p> <p>2008 \u5e74</p> <ul> <li>Schnorr \u7b7e\u540d\u7b97\u6cd5\u7684\u4e13\u5229\u8fc7\u671f\u4e86\uff08\u867d\u7136\u4e2d\u672c\u806a\u6ca1\u6709\u9009\u62e9\u5b83\uff09\uff1b</li> <li>\u6b21\u8d37\u5371\u673a\u5f15\u53d1\u5168\u7403\u91d1\u878d\u5371\u673a\uff1b</li> <li>2008 \u5e74 10 \u6708 31 \u65e5\uff08UTC\uff09\uff0c\u4e2d\u672c\u806a\u53d1\u5e03\u6bd4\u7279\u5e01\u8bba\u6587\u3002</li> </ul> <p></p> <p>2009 \u5e74 1 \u6708 3 \u65e5\uff0c\u7b2c\u4e00\u4e2a\u6bd4\u7279\u5e01\u533a\u5757\u6316\u51fa\u3002</p>"},{"location":"web3/dapp/address_251125/","title":"Solidity \u5730\u5740\u7c7b\u578b & \u5e38\u89c1\u7528\u6cd5\u5168\u653b\u7565","text":""},{"location":"web3/dapp/address_251125/#1-solidity","title":"1. Solidity \u5730\u5740\u7c7b\u578b","text":"<p>\u5730\u5740\u7c7b\u578b\uff08<code>address</code>\uff09\u7528\u4e8e\u5b58\u50a8\u4e00\u4e2a 20 \u5b57\u8282\u7684\u503c\uff08\u4ee5\u592a\u574a\u5730\u5740\u7684\u5927\u5c0f\uff09\u3002\u5b83\u4e0d\u4ec5\u4ec5\u662f\u4e00\u4e2a\u5b58\u50a8\u5355\u4f4d\uff0c\u8fd8\u63d0\u4f9b\u4e86\u4e0e\u4ee5\u592a\u574a\u8d26\u6237\u4ea4\u4e92\u7684\u591a\u79cd\u65b9\u5f0f\uff0c\u5bf9\u4e8e\u7f16\u5199\u667a\u80fd\u5408\u7ea6\u81f3\u5173\u91cd\u8981\u3002</p> <p>\u6ce8\uff1a\u8fd9\u4e9b\u8d26\u6237\u53ef\u4ee5\u662f\u5916\u90e8\u8d26\u6237\uff08\u7531\u7528\u6237\u63a7\u5236\u7684\u8d26\u6237\uff0c\u62e5\u6709\u79c1\u94a5\uff09\u6216\u5408\u7ea6\u8d26\u6237\uff08\u7531\u5408\u7ea6\u4ee3\u7801\u63a7\u5236\u7684\u8d26\u6237\uff09\u3002</p> <p>Solidity \u4e2d\u6709\u4e24\u79cd\u5730\u5740\u7c7b\u578b\uff1a</p> <ul> <li>address\uff1a\u666e\u901a\u5730\u5740\uff0c\u4e0d\u80fd\u63a5\u6536 ETH\uff0c\u5373\u4e0d\u80fd\u8c03\u7528 <code>transfer</code> / <code>send</code> / <code>call{value: ...}</code> \u7b49\u65b9\u6cd5\uff1b</li> <li>address payable\uff1a\u80fd\u63a5\u6536 ETH\uff0c\u652f\u6301\u8c03\u7528 <code>transfer</code> / <code>send</code> / <code>call{value: ...}</code> \u7b49\u65b9\u6cd5\uff1b</li> </ul> <p>\u6ce8\uff1a\u4e0e ETH \u76f8\u5173\u7684\u64cd\u4f5c\uff08\u8f6c\u8d26\u3001\u6536\u6b3e\uff09\uff0c\u90fd\u5fc5\u987b\u4f7f\u7528 address payable\u3002</p> <p>\u5bf9\u4e8e <code>address</code> \u7c7b\u578b\uff0c\u5e38\u7528\u7684\u5c5e\u6027\u5305\u62ec\uff1a</p> <ul> <li><code>balance</code>\uff1a\u83b7\u53d6\u5730\u5740\u4e2d\u7684 ETH \u4f59\u989d\uff1b</li> <li><code>code</code>\uff08Solidity ^0.8.0\uff09\uff1a\u83b7\u53d6\u5730\u5740\u4e2d\u5b58\u50a8\u7684\u5408\u7ea6\u4ee3\u7801\uff08\u5982\u679c\u6709\u7684\u8bdd\uff09\uff0c\u6b64\u5c5e\u6027\u5728 Solidity 0.8.0 \u4ee5\u540e\u7248\u672c\u4e2d\u65b0\u589e\uff1b</li> <li><code>codehash</code>\uff08Solidity ^0.8.0\uff09\uff1a\u83b7\u53d6\u5730\u5740\u7684\u5408\u7ea6\u4ee3\u7801\u7684\u54c8\u5e0c\u503c\uff08\u5982\u679c\u5730\u5740\u4e3a\u5408\u7ea6\u5730\u5740\uff09\uff0c\u5982\u679c\u5730\u5740\u662f\u5916\u90e8\u8d26\u6237\u6216\u5408\u7ea6\u4e2d\u6ca1\u6709\u4ee3\u7801\uff0c\u5219\u8fd4\u56de\u96f6\u54c8\u5e0c\uff1b</li> </ul> <p>\u5bf9\u4e8e <code>address payable</code> \u7c7b\u578b\uff0c\u9664 <code>address</code> \u7c7b\u578b\u7684\u5c5e\u6027\u5916\uff0c\u8fd8\u5305\u62ec\u4e09\u79cd\u4e0e ETH \u8f6c\u8d26\u76f8\u5173\u7684\u65b9\u6cd5\uff1a</p> <ul> <li><code>transfer(uint256 amount)</code>\uff1a\u56fa\u5b9a 2300 gas \u4f9b\u5bf9\u65b9 fallback/receive \u4f7f\u7528\uff0c\u5931\u8d25\u4f1a\u76f4\u63a5 <code>revert</code>\uff0c\u65b0\u7248\u672c\u91cc\u56e0\u4e3a gas \u653f\u7b56\u4e0d\u7a33\u5b9a\uff0c\u5b98\u65b9\u5df2\u7ecf\u4e0d\u63a8\u8350\u7528 <code>transfer</code> \u548c <code>send</code> \u4e86\uff1b</li> <li><code>send(uint256 amount) returns (bool)</code>\uff1a2300 gas \u9650\u5236\uff0c\u8fd4\u56de\u4e00\u4e2a\u5e03\u5c14\u503c\u8868\u793a\u6210\u529f\u4e0e\u5426\uff0c\u4e0d\u4f1a\u5728\u5931\u8d25\u65f6 <code>revert</code>\uff0c\u81ea\u5df1\u51b3\u5b9a\u8981\u4e0d\u8981 <code>require</code>\uff1b</li> <li><code>call(bytes memory data) returns (bool, bytes memory)</code>\uff1a\u5411\u5730\u5740\u53d1\u9001 ETH\uff0c\u53ef\u540c\u65f6\u8c03\u7528\u5176\u5408\u7ea6\u51fd\u6570\uff0c\u8fd4\u56de\u4e00\u4e2a\u5e03\u5c14\u503c\u8868\u793a\u6210\u529f\u4e0e\u5426\u548c\u8fd4\u56de\u6570\u636e\u3002</li> </ul> \u51fd\u6570 \u662f\u5426\u63a8\u8350 \u5931\u8d25\u662f\u5426 revert Gas \u9650\u5236 <code>transfer</code> \u274c \u4e0d\u63a8\u8350 \u2714\ufe0f \u81ea\u52a8 revert 2300 gas <code>send</code> \u274c \u4e0d\u63a8\u8350 \u274c \u8fd4\u56de false 2300 gas <code>call{value:...}</code> \u2714\ufe0f \u63a8\u8350\u6807\u51c6 \u274c \u9700\u624b\u52a8 require \u65e0\u9650\u5236 <p>\u9700\u8981\u8f6c\u8d26\u65f6\uff0c\u5efa\u8bae\u4f7f\u7528 <code>call</code> \u65b9\u6cd5\uff0c\u56e0\u4e3a <code>transfer</code> \u4e0e <code>send</code> \u65b9\u6cd5\u5b58\u5728 Gas \u9650\u5236\uff08\u53ea\u63d0\u4f9b2300 Gas\uff0c\u8fd9\u8db3\u4ee5\u8bb0\u5f55\u4e8b\u4ef6\uff0c\u4f46\u4e0d\u8db3\u4ee5\u8fdb\u884c\u66f4\u590d\u6742\u7684\u64cd\u4f5c\uff09\uff0c\u800c <code>call</code> \u6bd4\u8f83\u7075\u6d3b\u3002</p>"},{"location":"web3/dapp/address_251125/#2","title":"2. \u5730\u5740\u4e0e\u5916\u90e8\u5408\u7ea6\u4ea4\u4e92\uff08\u63a5\u53e3\u7c7b\u578b\u8f6c\u6362\uff09","text":""},{"location":"web3/dapp/address_251125/#21","title":"2.1 \u4e3a\u4ec0\u4e48\u8f6c\u6362\u6210\u63a5\u53e3\u7c7b\u578b\uff1f","text":"<p>\u4ee5\u592a\u574a\u4e16\u754c\u91cc\uff1a</p> <ul> <li>\u6bcf\u4e2a\u5408\u7ea6 = \u4e00\u6bb5\u90e8\u7f72\u5728\u94fe\u4e0a\u7684\u4ee3\u7801</li> <li>\u6bcf\u4e2a\u5408\u7ea6 = \u4e00\u4e2a\u72ec\u7acb\u7684\u5730\u5740\uff08address\uff09</li> </ul> <p>\u4f46 <code>address</code> \u672c\u8d28\u53ea\u662f 20 \u5b57\u8282\u6570\u5b57\uff0c\u5e76\u6ca1\u6709\u201c\u51fd\u6570\u4fe1\u606f\u201d\uff0c\u56e0\u6b64\uff1a</p> <p>\u274c address \u4e0d\u77e5\u9053\u8fd9\u4e2a\u5730\u5740\u5bf9\u5e94\u54ea\u79cd\u5408\u7ea6</p> <p>\u274c address \u4e0d\u77e5\u9053\u91cc\u9762\u6709\u54ea\u4e9b\u51fd\u6570</p> <p>\u274c address \u4e0d\u80fd\u76f4\u63a5\u8c03\u7528 transfer\u3001approve\u3001swap \u7b49\u51fd\u6570</p> <p>\u4f8b\u5982\uff1a</p> <pre><code>address token = 0x...;\ntoken.transfer(to, amount); // \u274c \u7f16\u8bd1\u9519\u8bef\n</code></pre> <p>\u56e0\u4e3a <code>address</code> \u7c7b\u578b\u6ca1\u6709 <code>transfer</code> \u65b9\u6cd5\u3002</p> <p>Solidity \u662f\u5f3a\u7c7b\u578b\u8bed\u8a00\uff0c\u5fc5\u987b\u660e\u786e\u544a\u8bc9\u5b83\uff1a\u8fd9\u4e2a address \u662f\u4ec0\u4e48\u7c7b\u578b\u7684\u5408\u7ea6\uff01</p> <p>\u6240\u4ee5\u6211\u4eec\u624d\u9700\u8981\uff1a</p> <p>\u2705 \u5148\u5b9a\u4e49\u63a5\u53e3\uff08Interface\uff09\u2014\u2014\u63cf\u8ff0\u5408\u7ea6\u51fd\u6570</p> <p>\u2705 \u518d\u628a <code>address</code> \u5f3a\u5236\u8f6c\u6362\u6210\u63a5\u53e3\u7c7b\u578b</p> <p>\u2705 \u6700\u540e\u7528\u63a5\u53e3\u6765\u8c03\u7528\u51fd\u6570</p>"},{"location":"web3/dapp/address_251125/#22","title":"2.2 \u5730\u5740\u8f6c\u63a5\u53e3\u5e76\u8c03\u7528\u51fd\u6570\uff08\u6838\u5fc3\u8bed\u6cd5\uff09","text":"<p>\u5178\u578b\u5199\u6cd5\uff1a<code>IERC20(tokenAddress).transfer(to, amount)</code></p> <p>\u4ee3\u7801\u542b\u4e49\uff1a</p> <ol> <li><code>tokenAddress</code> \u2014\u2014 \u8fd9\u662f ERC20 \u5408\u7ea6\u90e8\u7f72\u5728\u94fe\u4e0a\u7684\u5730\u5740\uff1b</li> <li><code>IERC20(tokenAddress)</code> \u2014\u2014 \u544a\u8bc9 Solidity\uff1a\u6309 ERC20 \u63a5\u53e3\u7684\u89c4\u8303\u8bbf\u95ee\u8fd9\u4e2a <code>address</code>\uff1b</li> <li><code>.transfer(...)</code> \u2014\u2014 \u7f16\u8bd1\u5668\u68c0\u67e5\u53c2\u6570\u7c7b\u578b\u3001\u8fd4\u56de\u503c\uff1b</li> <li>\u7f16\u8bd1\u540e\u6267\u884c\u4f4e\u7ea7 call\uff08ABI \u7f16\u7801\uff0cEVM \u6267\u884c\uff09\uff1b</li> </ol>"},{"location":"web3/dapp/address_251125/#23-address","title":"2.3 \u6700\u5e38\u7528\u573a\u666f\uff1a\u628a address \u50a8\u5b58\u8d77\u6765\uff0c\u7136\u540e\u4ea4\u4e92","text":"<p>\u4f8b\u5982 DEX\u3001Vault\u3001Staking \u5408\u7ea6\u90fd\u8fd9\u4e48\u5199\uff1a</p> <pre><code>contract Test {\n  address public token; // \u4fdd\u5b58\u4ee3\u5e01\u5408\u7ea6\u5730\u5740\n\n  function setToken(address _token) external {\n    token = _token;\n  }\n\n  function transferOut(address to, uint256 amount) external {\n    // address \u2192 IERC20\n    bool ok = IERC20(token).transfer(to, amount);\n    require(ok, \"transfer failed\");\n  }\n}\n</code></pre> <p>\u4e3a\u4ec0\u4e48\u4e0d\u80fd\u76f4\u63a5\u7528 <code>address</code>\uff1f\u56e0\u4e3a <code>address</code> \u6ca1\u6709 <code>transfer</code> \u51fd\u6570\u3002</p>"},{"location":"web3/dapp/address_251125/#24","title":"2.4 \u5b89\u5168\u6ce8\u610f\u4e8b\u9879","text":"<p>1\uff09\u786e\u4fdd\u8f6c\u6362\u7684 <code>address</code> \u662f\u671f\u671b\u7684\u5408\u7ea6\u5730\u5740</p> <p>\u5982\u679c\u7528\u6237\u4f20\u5165\u6076\u610f\u5730\u5740\uff1a<code>IERC20(fakeAddress).transfer(...)</code>\uff0c\u4f1a\u8c03\u5230\u9519\u8bef\u903b\u8f91 \u6216 fallback\uff0c\u89e6\u53d1\u6076\u610f\u4ee3\u7801\u3002</p> <p>\u6240\u4ee5\u5e38\u89c1\u505a\u6cd5\uff1a</p> <ul> <li>\u2714 \u767d\u540d\u5355\uff1b</li> <li>\u2714 constructor \u91cc\u5199\u6b7b\u5730\u5740\uff1b</li> <li>\u2714 \u4f7f\u7528 immutable \u5e38\u91cf\uff1b</li> <li>\u2714 \u4ec5 owner \u53ef\u4fee\u6539 token \u5730\u5740\uff1b</li> </ul> <p>2\uff09\u4f7f\u7528 <code>try/catch</code>\uff08\u9002\u5408\u5916\u90e8\u5408\u7ea6\u4e0d\u7a33\u5b9a\u65f6\uff09</p> <pre><code>try IERC20(token).transfer(to, amount) returns (bool ok) {\n  require(ok, \"failed\");\n} catch {\n  revert(\"token call failed\");\n}\n</code></pre> <p>3\uff09\u6c38\u8fdc\u4e0d\u8981\u7528 <code>address</code> \u518d\u53bb\u8c03\u7528\u672a\u77e5\u5408\u7ea6\u7684 send/transfer\uff08\u65e7\u5199\u6cd5\uff09</p> <p>\u65e7\u5199\u6cd5\u6709\u98ce\u9669\uff1a<code>payable(addr).transfer(amount);</code> // \u53ef\u80fd\u5931\u8d25</p> <p>\u6539\u7528\uff1a</p> <pre><code>(bool ok,) = payable(addr).call{value: amount}(\"\");\nrequire(ok);\n</code></pre> <p>\u603b\u7ed3\uff1a</p> \u6b65\u9aa4 \u76ee\u7684 \ud83d\udd39 \u5199\u63a5\u53e3 Interface \u544a\u8bc9 Solidity \u8fd9\u4e2a\u5408\u7ea6\u6709\u54ea\u4e9b\u51fd\u6570 \ud83d\udd39 \u7528 <code>IERC20(tokenAddress)</code> \u628a address \u8f6c\u6210\u63a5\u53e3\u7c7b\u578b \ud83d\udd39 \u7528\u63a5\u53e3\u8bbf\u95ee\u51fd\u6570 \u5b89\u5168\u3001\u7c7b\u578b\u68c0\u67e5\u3001\u81ea\u52a8 ABI \u7f16\u7801 \ud83d\udd39 \u7528\u5730\u5740\u4fdd\u5b58\u5408\u7ea6\u5730\u5740 \u5408\u7ea6\u95f4\u4ea4\u4e92"},{"location":"web3/dapp/address_251125/#3","title":"3. \u5730\u5740 + \u6620\u5c04 / \u6570\u7ec4\uff1a\u8bb0\u8d26 &amp; \u5173\u7cfb","text":""},{"location":"web3/dapp/address_251125/#31","title":"3.1 \u5730\u5740 + \u6620\u5c04","text":"<p><code>mapping(address =&gt; uint256)</code> \u662f\u6700\u5e38\u89c1\u7684\u7528\u6cd5\u4e4b\u4e00\uff0c\u4f8b\u5982 ERC20 \u7684\u4f59\u989d\u8868\uff1a</p> <pre><code>mapping(address =&gt; uint256) public balanceOf;\n\nfunction mint(uint256 amount) external {\n    balanceOf[msg.sender] += amount;\n}\n</code></pre> <p>\u591a\u5c42 mapping\uff08\u6bd4\u5982 allowance\uff09\uff1a</p> <pre><code>mapping(address =&gt; mapping(address =&gt; uint256)) public allowance;\n\nfunction approve(address spender, uint256 amount) external {\n    allowance[msg.sender][spender] = amount;\n}\n</code></pre> <p><code>mapping</code> \u91cc\u7684 key \u7528 <code>address</code> \u975e\u5e38\u81ea\u7136\uff0c\u800c\u4e14\u4f1a\u81ea\u52a8\u521d\u59cb\u5316\u4e3a 0\uff0c\u4e0d\u5b58\u5728\u5219\u8fd4\u56de\u9ed8\u8ba4\u503c\u3002</p>"},{"location":"web3/dapp/address_251125/#32","title":"3.2 \u5730\u5740 + \u6570\u7ec4","text":"<p><code>address[]</code>\uff0c\u6570\u7ec4\u91cc\u7684\u5143\u7d20\u53ef\u4ee5\u662f <code>address</code> \u6216 <code>address payable</code>\uff0c\u770b\u4f60\u8981\u4e0d\u8981\u7ed9\u4ed6\u4eec\u8f6c\u8d26\u3002</p> <p>\u6bd4\u5982\u8bb0\u5f55\u6240\u6709\u5b58\u6b3e\u8fc7\u7684\u7528\u6237\uff1a</p> <pre><code>address[] public users;\nmapping(address =&gt; bool) public hasDeposited;\n\nfunction deposit() external payable {\n    if (!hasDeposited[msg.sender]) {\n        hasDeposited[msg.sender] = true;\n        users.push(msg.sender);\n    }\n}\n</code></pre>"},{"location":"web3/dapp/address_251125/#4","title":"4. \u7279\u6b8a\u5730\u5740","text":"<p><code>msg.sender</code> \u2013 \u5f53\u524d\u5408\u7ea6\u7684\u8c03\u7528\u8005\uff0c\u53ef\u80fd\u662f\u5916\u90e8\u8d26\u6237\uff0c\u4e5f\u53ef\u80fd\u662f\u53e6\u4e00\u4e2a\u5408\u7ea6\u3002</p> <p><code>tx.origin</code> \u2013 \u4ea4\u6613\u6700\u539f\u59cb\u53d1\u8d77\u4eba\uff0c\u5bb9\u6613\u88ab\u300c\u4e2d\u95f4\u5408\u7ea6\u300d\u9a97\u8c03\u7528\uff0c\u5bfc\u81f4\u9493\u9c7c\u653b\u51fb\uff0c\u6743\u9650\u63a7\u5236\u7528 <code>msg.sender</code> \u5c31\u591f\u4e86\u3002</p> <p><code>address(this)</code> - \u5408\u7ea6\u81ea\u5df1\u7684\u5730\u5740\u3002</p>"},{"location":"web3/dapp/ethereum_address_size_251120/","title":"\u4e3a\u4ec0\u4e48\u4ee5\u592a\u574a\u5730\u5740\u662f 20 \u5b57\u8282\uff1f\u4ece\u79c1\u94a5\u5230\u5730\u5740\u7684\u5168\u89e3\u6790","text":""},{"location":"web3/dapp/ethereum_address_size_251120/#1","title":"1. \u4ee5\u592a\u574a\u5730\u5740\u591a\u5927\uff1f","text":"<p>\u4ee5\u592a\u574a\u5730\u5740\u5927\u5c0f\uff1a20 \u5b57\u8282\uff08bytes\uff09 = 160 \u4f4d\uff08bits\uff09\uff0c\u5bf9\u5916\u901a\u5e38\u5199\u6210\uff1a<code>0x</code> + 40 \u4e2a\u5341\u516d\u8fdb\u5236\u5b57\u7b26</p> <ul> <li>\u6bcf\u4e2a\u5341\u516d\u8fdb\u5236\u5b57\u7b26\u662f 4 bit</li> <li>40 \u00d7 4 = 160 bit = 20 byte</li> </ul> <p>\u4f8b\u5982\uff1a0x28816c4c4792467390c90e5b426f198570e29307\uff0c\u53bb\u6389 <code>0x</code>\uff0c\u5269\u4e0b\u7684 40 \u4e2a Hex \u5b57\u7b26\uff0c\u5c31\u662f 20 \u5b57\u8282\u7684\u4e8c\u8fdb\u5236\u5730\u5740\u3002</p>"},{"location":"web3/dapp/ethereum_address_size_251120/#2-20","title":"2. \u4ece\u5bc6\u94a5\u5230\u5730\u5740\uff1a\u4e3a\u4ec0\u4e48\u662f 20 \u5b57\u8282\uff1f","text":"<p>\u4ee5\u592a\u574a\u8d26\u6237\u7684\u751f\u6210\u6d41\u7a0b\uff08\u5916\u90e8\u8d26\u6237 EOA\uff09\u5927\u81f4\u662f\u8fd9\u6837\uff1a</p> <ol> <li>\u751f\u6210\u4e00\u4e2a \u79c1\u94a5\uff08256 bit \u968f\u673a\u6570\uff09\uff1b</li> <li>\u7528 secp256k1 \u692d\u5706\u66f2\u7ebf\u7b97\u51fa \u516c\u94a5\uff0864 \u5b57\u8282\uff1ax\u3001y \u5404 32 \u5b57\u8282\uff09\uff1b</li> <li>\u5bf9\u516c\u94a5\u505a\u4e00\u6b21 Keccak-256 \u54c8\u5e0c\uff1a\u5f97\u5230 32 \u5b57\u8282\uff1b</li> <li>\u53d6\u54c8\u5e0c\u7ed3\u679c\u7684\u540e 20 \u5b57\u8282\uff08\u53f3\u8fb9 20 \u5b57\u8282\uff09\uff0c\u4f5c\u4e3a\u5730\u5740\uff1b</li> </ol> <pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502          \u79c1\u94a5 Private Key             \u2502\n\u2502     256-bit \u968f\u673a\u6570\uff0832 \u5b57\u8282\uff09           \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                      \u2502\n                      \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502         \u516c\u94a5 Public Key               \u2502\n\u2502 secp256k1 \u692d\u5706\u66f2\u7ebf\u63a8\u5bfc\u51fa 64 \u5b57\u8282\u5750\u6807     \u2502\n\u2502  \u516c\u94a5 = (x: 32 bytes, y: 32 bytes)    \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                      \u2502\n                      \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502      Keccak-256 \u54c8\u5e0c\uff0832 \u5b57\u8282\uff09        \u2502\n\u2502 hash = keccak256(uncompressed_pubkey)\u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                      \u2502\n                      \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502       \u53d6\u54c8\u5e0c\u7ed3\u679c\u7684\u6700\u540e 20 \u5b57\u8282           \u2502\n\u2502     \uff08\u53f3 20 \u5b57\u8282 = 160 bit\uff09           \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                      \u2502\n                      \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502         \u4ee5\u592a\u574a\u5730\u5740 Ethereum Address    \u2502\n\u2502   0x + 40 \u4f4d\u5341\u516d\u8fdb\u5236\u5b57\u7b26\uff08= 20\u5b57\u8282\uff09     \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\n</code></pre> <p>\u6240\u4ee5\u5730\u5740\u672c\u8d28\u4e0a\u662f\uff1a address = last_20_bytes( keccak256( public_key ) )</p> <p>\u95ee\u9898\uff1a\u4e3a\u4ec0\u4e48\u4e0d\u7528 32 \u5b57\u8282\uff0c\u975e\u8981\u622a\u65ad\u6210 20 \u5b57\u8282\uff1f</p> <p>\u7b80\u5355\u7406\u89e3\uff1a\u622a\u65ad\u4e00\u70b9 hash\uff0c\u5f53\u5730\u5740\u7528\uff0c\u591f\u7528 + \u597d\u7528 + \u8282\u7701\u8d44\u6e90\u3002</p> <p>\uff081\uff09\u77ed\u4e00\u70b9\uff0c\u65b9\u4fbf\u5c55\u793a\u4e0e\u8f93\u5165</p> <ul> <li> <p>32 \u5b57\u8282\u5730\u5740 \u2192 64 \u4e2a Hex \u5b57\u7b26</p> </li> <li> <p>20 \u5b57\u8282\u5730\u5740 \u2192 40 \u4e2a Hex \u5b57\u7b26</p> </li> </ul> <p>\u4ece\u524d\u7aef UI\u3001\u94b1\u5305\u663e\u793a\u3001\u7528\u6237\u590d\u5236\u7c98\u8d34\u7684\u4f53\u9a8c\u6765\u770b\uff0c40 \u4e2a\u5b57\u7b26\u5df2\u7ecf\u5f88\u957f\u4e86\uff0c64 \u4e2a\u66f4\u96be\u7528\u3002</p> <p>\uff082\uff09\u5b89\u5168\u6027\u4ecd\u7136\u8db3\u591f</p> <p>\u5730\u5740\u7a7a\u95f4\u6709 2\u00b9\u2076\u2070 \u2248 1.46 \u00d7 10\u2074\u2078 \u79cd\u53ef\u80fd\uff0c\u5373\u4f7f\u5168\u5730\u7403\u7b97\u529b\u7206\u70b8\u5f0f\u63d0\u9ad8\uff0c\u8981\u300c\u78b0\u649e\u300d\u4e00\u4e2a\u6307\u5b9a\u5730\u5740\u4e5f\u51e0\u4e4e\u4e0d\u53ef\u80fd\u3002</p> <p>\u771f\u6b63\u7684\u5b89\u5168\u6027\u74f6\u9888\u662f\uff1a\u79c1\u94a5\u662f\u5426\u771f\u7684\u968f\u673a &amp; \u662f\u5426\u88ab\u6cc4\u9732\uff0c\u800c\u4e0d\u662f\u300c\u5730\u5740\u591f\u4e0d\u591f\u957f\u300d\u3002</p> <p>\uff083\uff09\u5b58\u50a8\u7a7a\u95f4\u66f4\u5c0f</p> <p>\u72b6\u6001\u6811\uff08state trie\uff09\u3001\u4ea4\u6613\u7f16\u7801\u91cc\u5730\u5740\u8981\u5b58\u5f88\u591a\u6b21\uff0c20 \u5b57\u8282 \u00d7 N \u6b21\uff0c\u6bd4 32 \u5b57\u8282 \u00d7 N \u6b21\u7701\u7a7a\u95f4\u3001\u7701\u5e26\u5bbd\u3001\u7701\u5b58\u50a8\u3002</p>"},{"location":"web3/dapp/ethereum_address_size_251120/#3-solidity-address","title":"3. Solidity \u91cc\u7684 address \u5b9e\u9645\u5360\u591a\u5c11\u5b57\u8282\uff1f","text":"<p>\u8fd9\u91cc\u8981\u5206 \u201c\u6982\u5ff5\u4e0a\u7684\u5927\u5c0f\u201d \u548c \u201cEVM \u5b9e\u9645\u5b58\u50a8\u7684\u5927\u5c0f\u201d \u4e24\u5c42\u770b\u3002</p> <p>\u6982\u5ff5\u4e0a\uff1aaddress = 20 \u5b57\u8282</p> <p>\u5728 Solidity \u7c7b\u578b\u7cfb\u7edf\u91cc\uff1a</p> <pre><code>address         // 20 \u5b57\u8282\naddress payable // \u4e5f\u662f 20 \u5b57\u8282\uff0c\u53ea\u662f\u591a\u4e86\u8f6c\u8d26\u51fd\u6570\n</code></pre> <p>\u5b58\u50a8\u5728 EVM storage \u91cc\uff1a\u5360\u7528 32 \u5b57\u8282\u69fd\u4f4d</p> <p>EVM \u7684\u6700\u5c0f\u5b58\u50a8\u5355\u4f4d\u662f \u4e00\u4e2a storage slot = 32 \u5b57\u8282\uff08256 bit\uff09\uff0c\u5373\u4f7f\u53ea\u5b58\u4e00\u4e2a bool / uint8 / address\uff0c\u5b83\u9ed8\u8ba4\u4e5f\u5360\u7528\u4e00\u4e2a\u5b8c\u6574 32 \u5b57\u8282\u69fd\uff08\u9664\u975e\u7f16\u8bd1\u5668\u505a\u53d8\u91cf\u6253\u5305\uff09\u3002</p> <pre><code>contract Store {\n    address public owner;    // slot 0\uff0c\u5360 32 \u5b57\u8282\n    uint256 public value;    // slot 1\uff0c\u5360 32 \u5b57\u8282\n}\n</code></pre> <p>\u867d\u7136 address \u5b9e\u9645\u53ea\u7528\u6389 20 \u5b57\u8282\uff0c\u5176\u4f59 12 \u5b57\u8282\u662f\u586b\u5145\u7684\uff08\u901a\u5e38\u4e3a 0\uff09\uff0c\u4f46\uff1a</p> <ul> <li>\u5728 storage \u5c42\u9762\uff1a1 \u4e2a address = 1 \u4e2a slot = 32 \u5b57\u8282</li> <li>\u5728 \u8bed\u4e49\u5c42\u9762\uff1aaddress \u8fd8\u662f\u4ee3\u8868 20 \u5b57\u8282\u7684\u5730\u5740</li> </ul> <p>\u8fd9\u4e5f\u5c31\u662f\u4e3a\u4ec0\u4e48\u6709\u65f6\u5019\u8bb2\u300c\u5b58\u4e00\u4e2a\u5730\u5740\uff0cgas \u5f88\u8d35\u300d\uff0c\u56e0\u4e3a\u5b83\u4f1a\u89e6\u53d1\u4e00\u6b21 <code>SSTORE</code> \u5230\u65b0\u69fd\u4f4d\u3002</p> <p>\u5982\u679c\u53d8\u91cf\u6253\u5305\uff0c\u4f8b\u5982\uff1a</p> <pre><code>contract Packed {\n    address public owner;   // 20 bytes\n    uint96  public count;   // 12 bytes\n}\n</code></pre> <ul> <li>20 + 12 = 32 \u5b57\u8282</li> <li>\u7f16\u8bd1\u5668\u4f1a\u628a <code>owner</code> \u548c <code>count</code> \u585e\u8fdb\u540c\u4e00\u4e2a slot \u2192 \u4f9d\u7136\u662f 32 \u5b57\u8282\u4e00\u4e2a\u69fd\uff0c\u4f46\u5bb9\u7eb3\u4e86\u4e24\u4e2a\u5b57\u6bb5</li> </ul> <p>\u7ed3\u8bba\uff1a</p> <ul> <li>\u5355\u72ec\u770b\u7c7b\u578b\uff1aaddress = 20 bytes\uff1b</li> <li>\u5b58\u5728 storage\uff1a\u4e00\u822c\u5360 1 \u4e2a 32-byte slot\uff08\u9664\u975e packing\uff09\uff1b</li> </ul>"},{"location":"web3/dapp/ethereum_address_size_251120/#4-abi-calldata-memory","title":"4. \u5728 ABI / calldata / memory \u91cc\u7684\u5730\u5740\u5927\u5c0f","text":"<p>Solidity \u5bf9\u5916\u7f16\u7801\uff08ABI\uff09\u65f6\u5019\uff0c\u6709\u4e00\u4e2a\u89c4\u5219\uff1a\u6240\u6709\u503c\u7c7b\u578b\u6309 32 \u5b57\u8282\u5bf9\u9f50\u3002</p> <p>\u6240\u4ee5\u5728\u4ee5\u4e0b\u573a\u666f\u4e2d\uff1a</p> <ul> <li>\u51fd\u6570\u53c2\u6570\u7684 ABI \u7f16\u7801\uff08calldata\uff09\uff1b</li> <li>\u51fd\u6570\u8fd4\u56de\u503c\u7684 ABI \u7f16\u7801\uff1b</li> <li>event topics\uff08\u65e5\u5fd7\u91cc\uff09\uff1b</li> </ul> <p>\u4e00\u4e2a address \u901a\u5e38\u662f\u8fd9\u4e48\u8868\u793a\u7684\uff1a\u524d\u9762 12 \u5b57\u8282\u8865 0 + \u540e\u9762 20 \u5b57\u8282\u5730\u5740</p> <p>\u4f8b\u5982\u5730\u5740\uff1a0x28816c4c4792467390c90e5b426f198570e29307\uff0c\u5728 ABI \u7f16\u7801\u4e2d\uff0c\u4f1a\u88ab\u653e\u8fdb 32 \u5b57\u8282\uff1a</p> <pre><code>0x00000000000000000000000028816c4c4792467390c90e5b426f198570e29307\n  \u2191                       \u2191\n12 bytes 0              20 bytes address\n</code></pre> <p>\u7f16\u7801\u65f6\uff0c\u5360 32 \u5b57\u8282\uff08\u5bf9\u9f50\u5230 256 bit\uff09\uff0c\u8bed\u4e49\u4e0a\uff0c\u6709\u6548\u8f7d\u8377\u4ecd\u7136\u662f 20 \u5b57\u8282\u3002</p>"},{"location":"web3/dapp/hardhat_tutorial_240415/","title":"Hardhat \u5165\u95e8\u6307\u5357\uff0825\u5e74\u66f4\u65b0\u7248\uff09","text":"<p>\u8bf4\u660e\uff1a\u539f\u7248\u53d1\u5e03\u4e8e 2024-04-15\uff0c\u57fa\u4e8e Node 20.x\uff0cUbuntu 20.04 \u7cfb\u7edf\u5f00\u53d1\uff0c\u6700\u65b0\u7248\u66f4\u65b0\u4e8e2025-12-12\uff0c\u57fa\u4e8e Node 22.x\uff0cUbuntu 24.04 \u7cfb\u7edf\u5f00\u53d1\u3002</p> <p>Hardhat \u662f\u4e00\u4e2a\u4ee5 Node.js/JavaScript \u751f\u6001\u4e3a\u6838\u5fc3\u7684\u4ee5\u592a\u574a\u667a\u80fd\u5408\u7ea6\u5f00\u53d1\u73af\u5883\uff0c\u5e2e\u52a9\u5f00\u53d1\u8005\u628a\u300c\u5199\u5408\u7ea6 \u2192 \u7f16\u8bd1 \u2192 \u6d4b\u8bd5 \u2192 \u672c\u5730\u8c03\u8bd5 \u2192 \u90e8\u7f72\u5230\u6d4b\u8bd5\u7f51/\u4e3b\u7f51\u300d\u8fd9\u4e00\u7cfb\u5217\u91cd\u590d\u5de5\u4f5c\u81ea\u52a8\u5316\u4e0e\u5de5\u7a0b\u5316\uff1b\u5b83\u5185\u7f6e Hardhat Network\uff08\u672c\u5730\u4ee5\u592a\u574a\u7f51\u7edc\uff09\uff0c\u7528\u4e8e\u90e8\u7f72\u3001\u8dd1\u6d4b\u8bd5\u3001\u8c03\u8bd5\u5408\u7ea6\u903b\u8f91\u3002  </p> <p>\u5728 Hardhat \u7684\u8bbe\u8ba1\u91cc\uff1a</p> <ul> <li>\u5728\u547d\u4ee4\u884c\u6bcf\u8dd1\u4e00\u6b21 <code>npx hardhat xxx</code>\uff0c\u672c\u8d28\u4e0a\u662f\u5728\u6267\u884c\u4e00\u4e2a task\uff1b</li> <li>\u5927\u90e8\u5206\u80fd\u529b\u7531 plugins \u63d0\u4f9b\uff08\u4f8b\u5982 ethers \u96c6\u6210\u3001chai-matchers\u3001Ignition \u90e8\u7f72\u7b49\uff09\uff0c\u5b98\u65b9\u63a8\u8350\u521d\u5b66\u8005\u4f7f\u7528 <code>@nomicfoundation/hardhat-toolbox</code> \u4e00\u63fd\u5b50\u63d2\u4ef6\u3002</li> </ul>"},{"location":"web3/dapp/hardhat_tutorial_240415/#_1","title":"\u4e00\u3001\u914d\u7f6e\u73af\u5883","text":"<p>\u5728 Windows \u7cfb\u7edf\u4f7f\u7528 VS Code \u914d\u7f6e Ubuntu 24.04 \u4e0a\u7684\u5f00\u53d1\u73af\u5883\u3002</p> <p>\u5b89\u88c5 22.x \u7248 Node.js\uff1a</p> <pre><code>curl -fsSL https://deb.nodesource.com/setup_22.x | sudo -E bash -\nsudo apt-get install -y nodejs\n\n# \u67e5\u770b\u5b89\u88c5\u7684\u7248\u672c\nnode -v\nnpm -v\n</code></pre>"},{"location":"web3/dapp/hardhat_tutorial_240415/#hardhat","title":"\u4e8c\u3001\u521b\u5efa Hardhat \u9879\u76ee","text":"<p>\u4f7f\u7528 Node.js \u7684\u5305\u7ba1\u7406\u5668 <code>npm</code> \u6765\u5b89\u88c5 hardhat\uff1a</p> <p>\u521d\u59cb\u5316\u9879\u76ee\u76ee\u5f55\u4e0e npm \u5de5\u7a0b\uff1a</p> <pre><code>mkdir hardhat-tutorial\ncd hardhat-tutorial\nnpm init\n</code></pre> <p>\u5b89\u88c5 Hardhat v2\uff08\u5b98\u65b9\u6559\u7a0b\u4f7f\u7528 <code>hardhat@hh2</code> \u8fd9\u4e2a\u6807\u7b7e\u6765\u9501\u5b9a v2\uff09\uff1a</p> <pre><code>npm install --save-dev hardhat@hh2 # \u8be5\u8fc7\u7a0b\u53ef\u80fd\u6bd4\u8f83\u82b1\u65f6\u95f4\n</code></pre> <p>\u521d\u59cb\u5316 Hardhat \u914d\u7f6e\u6587\u4ef6\uff1a</p> <pre><code>npx hardhat init    # \u9009\u62e9\uff1aCreate an empty hardhat.config.js\n</code></pre> <p>\u5b89\u88c5\u5b98\u65b9\u63a8\u8350\u63d2\u4ef6\u96c6\u5408 hardhat-toolbox\uff1a</p> <pre><code>npm install --save-dev @nomicfoundation/hardhat-toolbox@hh2\n</code></pre> <p>\u5728 hardhat.config.js \u6587\u4ef6\u4e2d\u6dfb\u52a0 <code>require(\"@nomicfoundation/hardhat-toolbox\");</code>\uff0c\u8fd9\u4e00\u6b65\u5b8c\u6210\u540e\uff0chardhat.config.js \u5982\u4e0b\uff1a</p> <pre><code>require(\"@nomicfoundation/hardhat-toolbox\");\n\n/** @type import('hardhat/config').HardhatUserConfig */\nmodule.exports = {\n  solidity: \"0.8.28\",\n};\n</code></pre> <p>\u8865\u5145\uff1a\u5982\u679c\u4f7f\u7528 npm install --save-dev hardhat \u5b89\u88c5 hardhat \u592a\u6162\uff0c\u53ef\u4ee5\u4f7f\u7528 yarn add --dev hardhat \u6765\u5b89\u88c5\u3002</p> <p>\u5b89\u88c5 yarn \u6307\u4ee4\u5982\u4e0b\uff1a<code>yarn</code> \u5b98\u65b9\u63d0\u4f9b\u4e86\u4e00\u4e2a APT \u4ed3\u5e93\uff0c\u53ef\u4ee5\u901a\u8fc7\u5b83\u6765\u5b89\u88c5 <code>yarn</code>\uff0c\u914d\u7f6e\u4ed3\u5e93\u5e76\u5bfc\u5165 Yarn \u7684 GPG \u516c\u94a5\uff1a</p> <pre><code>curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | sudo apt-key add -\necho \"deb https://dl.yarnpkg.com/debian/ stable main\" | sudo tee /etc/apt/sources.list.d/yarn.list\nsudo apt-get update\nsudo apt-get install yarn\nyarn --version\n</code></pre>"},{"location":"web3/dapp/hardhat_tutorial_240415/#_2","title":"\u4e09\u3001\u521b\u5efa &amp; \u7f16\u8bd1\u667a\u80fd\u5408\u7ea6","text":"<p>\u5728\u9879\u76ee\u6839\u76ee\u5f55\u4e2d\u65b0\u5efa\u4e00\u4e2a <code>contracts</code> \u76ee\u5f55\uff0c\u63a5\u4e0b\u6765\u5c31\u53ef\u4ee5\u5728 <code>contracts</code> \u76ee\u5f55\u4e2d\u7f16\u5199\u6211\u4eec\u7684\u5408\u7ea6\u4ee3\u7801\uff0c\u4ee5\u4e0b MiniToken.sol \u53c2\u8003\u81ea Hardhat \u5b98\u65b9\u6559\u7a0b\uff1a</p> <pre><code>// SPDX-License-Identifier:MIT\npragma solidity ^0.8.28;\nimport \"hardhat/console.sol\";\n\ncontract MiniToken {\n    string public name = \"Mini Hardhat Token\";\n    string public symbol = \"MHT\";\n    uint256 public totalSupply = 1000000;\n\n    address public owner;\n    mapping(address =&gt; uint256) private balances;\n\n    event Transfer(address indexed from, address indexed to, uint256 value);\n\n    constructor() {\n        owner = msg.sender;\n        balances[msg.sender] = totalSupply;\n    }\n\n    function balanceOf(address account) external view returns (uint256) {\n        return balances[account];\n    }\n\n    function transfer(address to, uint256 amount) external {\n        require(balances[msg.sender] &gt;= amount, \"Not enough tokens\");\n        balances[msg.sender] -= amount;\n        balances[to] += amount;\n\n        emit Transfer(msg.sender, to, amount);\n    }\n}\n</code></pre> <p>\u6ce8\uff1a\u53ef\u4ee5\u5728 VS Code \u4e2d\u5b89\u88c5 hardhat \u7684\u6269\u5c55\u7a0b\u5e8f Solidity by Nomic Foundation\u3002</p> <p>\u5408\u7ea6\u4ee3\u7801\u7f16\u5199\u5b8c\u540e\uff0c\u4f7f\u7528 <code>npx hardhat compile</code> \u6307\u4ee4\u7f16\u8bd1\u3002</p>"},{"location":"web3/dapp/hardhat_tutorial_240415/#hardhat-network","title":"\u56db\u3001\u7f16\u5199\u6d4b\u8bd5\u5e76\u8fd0\u884c\uff08\u57fa\u4e8e Hardhat Network\uff09","text":"<p>Hardhat \u9ed8\u8ba4\u7f51\u7edc\u5c31\u662f Hardhat Network\uff0c\u8dd1\u6d4b\u8bd5\u65e0\u9700\u989d\u5916\u542f\u52a8\u8282\u70b9\u6216\u914d\u7f6e\u3002\u5b98\u65b9\u6559\u7a0b\u7528 ethers.js + Mocha + Chai \u6765\u5199\u6d4b\u8bd5\u3002</p> <p>\u5728\u6839\u76ee\u5f55\u4e2d\u65b0\u5efa\u4e00\u4e2a\u76ee\u5f55 <code>test</code>\uff0c\u6dfb\u52a0\u5982\u4e0b MiniToken.js \u6587\u4ef6\uff1a</p> <pre><code>const { expect } = require(\"chai\");\n\ndescribe(\"MiniToken\", function () {\n  it(\"\u90e8\u7f72\u540e\uff1a\u90e8\u7f72\u8005\u5e94\u62ff\u5230\u5168\u90e8 totalSupply\", async function () {\n    const [owner] = await ethers.getSigners();\n    const token = await ethers.deployContract(\"MiniToken\");\n\n    const ownerBalance = await token.balanceOf(owner.address);\n    expect(await token.totalSupply()).to.equal(ownerBalance);\n  });\n\n  it(\"\u8f6c\u8d26\uff1a\u5e94\u80fd\u5728\u4e0d\u540c\u8d26\u6237\u95f4\u8f6c\u79fb\u4f59\u989d\", async function () {\n    const [owner, addr1, addr2] = await ethers.getSigners();\n    const token = await ethers.deployContract(\"MiniToken\");\n\n    await token.transfer(addr1.address, 50);\n    expect(await token.balanceOf(addr1.address)).to.equal(50);\n\n    await token.connect(addr1).transfer(addr2.address, 50);\n    expect(await token.balanceOf(addr2.address)).to.equal(50);\n  });\n\n  it(\"\u5931\u8d25\u7528\u4f8b\uff1a\u4f59\u989d\u4e0d\u8db3\u5e94 revert\", async function () {\n    const [, addr1, addr2] = await ethers.getSigners();\n    const token = await ethers.deployContract(\"MiniToken\");\n\n    await expect(token.connect(addr1).transfer(addr2.address, 1))\n      .to.be.revertedWith(\"Not enough tokens\");\n  });\n});\n</code></pre> <p>\u6267\u884c<code>npx hardhat test</code>\u6307\u4ee4\uff0c\u6d4b\u8bd5\u7ed3\u679c\u5982\u4e0b\uff1a</p> <pre><code>test@DESKTOP-958GQ8P:~/desktop/hardhat-tutorial$ npx hardhat test\n\n\n  MiniToken\n    \u2714 \u90e8\u7f72\u540e\uff1a\u90e8\u7f72\u8005\u5e94\u62ff\u5230\u5168\u90e8 totalSupply (486ms)\n    \u2714 \u8f6c\u8d26\uff1a\u5e94\u80fd\u5728\u4e0d\u540c\u8d26\u6237\u95f4\u8f6c\u79fb\u4f59\u989d\n    \u2714 \u5931\u8d25\u7528\u4f8b\uff1a\u4f59\u989d\u4e0d\u8db3\u5e94 revert\n\n\n  3 passing (537ms)\n\n</code></pre> <p>\u5b98\u65b9\u6559\u7a0b\u8fd8\u63a8\u8350\u7528 <code>loadFixture</code> \u505a\u6d4b\u8bd5\u5939\u5177\u4e0e\u5feb\u7167\u56de\u6eda\uff0c\u63d0\u9ad8\u6d4b\u8bd5\u901f\u5ea6\u5e76\u51cf\u5c11\u91cd\u590d\u90e8\u7f72\u4ee3\u7801\u3002</p>"},{"location":"web3/dapp/hardhat_tutorial_240415/#hardhat-network_1","title":"\u4e94\u3001\u4f7f\u7528 Hardhat Network \u8c03\u8bd5","text":""},{"location":"web3/dapp/hardhat_tutorial_240415/#51-solidity-consolelog","title":"5.1 \u5728 Solidity \u91cc\u76f4\u63a5 console.log","text":"<p>Hardhat Network \u652f\u6301\u5728 Solidity \u4ee3\u7801\u4e2d\u8c03\u7528 <code>console.log()</code> \u8f93\u51fa\u65e5\u5fd7\u4fe1\u606f\u3001\u5408\u7ea6\u53d8\u91cf\uff0c\u7528\u6cd5\u662f\u5728\u5408\u7ea6\u4ee3\u7801\u4e2d\u5bfc\u5165 <code>import \"hardhat/console.sol\";</code> \u5e76\u5728\u51fd\u6570\u91cc\u6253\u5370\u3002</p> <p>\u793a\u4f8b\uff1a\u7f16\u8f91 <code>contracts/MiniToken.sol</code>\uff0c\u5728 <code>transfer()</code> \u4e2d\u52a0\u5165\u65e5\u5fd7\uff1a</p> <pre><code>import \"hardhat/console.sol\";\n\nfunction transfer(address to, uint256 amount) external {\n    require(balances[msg.sender] &gt;= amount, \"Not enough tokens\");\n\n    console.log(\n        \"Transferring from %s to %s %s tokens\",\n        msg.sender,\n        to,\n        amount\n    );\n\n    balances[msg.sender] -= amount;\n    balances[to] += amount;\n    emit Transfer(msg.sender, to, amount);\n}\n</code></pre> <p>\u518d\u8dd1\u4e00\u6b21\u6d4b\u8bd5\u6307\u4ee4<code>npx hardhat test</code>\uff0c\u4f1a\u5728\u6d4b\u8bd5\u8f93\u51fa\u4e2d\u770b\u5230\u8f6c\u8d26\u65e5\u5fd7\uff1a</p> <pre><code>test@DESKTOP-958GQ8P:~/desktop/hardhat-tutorial$ npx hardhat test\nCompiled 2 Solidity files successfully (evm target: paris).\n\n\n  MiniToken\n    \u2714 \u90e8\u7f72\u540e\uff1a\u90e8\u7f72\u8005\u5e94\u62ff\u5230\u5168\u90e8 totalSupply (471ms)\nTransferring from 0xf39fd6e51aad88f6f4ce6ab8827279cfffb92266 to 0x70997970c51812dc3a010c7d01b50e0d17dc79c8 50 tokens\nTransferring from 0x70997970c51812dc3a010c7d01b50e0d17dc79c8 to 0x3c44cdddb6a900fa2b585dd299e03d12fa4293bc 50 tokens\n    \u2714 \u8f6c\u8d26\uff1a\u5e94\u80fd\u5728\u4e0d\u540c\u8d26\u6237\u95f4\u8f6c\u79fb\u4f59\u989d\n    \u2714 \u5931\u8d25\u7528\u4f8b\uff1a\u4f59\u989d\u4e0d\u8db3\u5e94 revert\n\n\n  3 passing (520ms)\n</code></pre> <p>\u6ce8\u610f\u70b9\uff08\u6765\u81ea Hardhat Network \u53c2\u8003\u6587\u6863\uff09\uff1a</p> <ul> <li><code>console.log</code> \u53ef\u5728 call/transaction \u4e2d\u4f7f\u7528\uff0c<code>view</code> \u53ef\u7528\uff0c\u4f46 <code>pure</code> \u4e0d\u884c\uff1b</li> <li>\u9700\u8981<code>import \"hardhat/console.sol\"</code>\uff1b</li> <li><code>console.log</code> \u6700\u591a\u652f\u6301 4 \u4e2a\u53c2\u6570\uff0c\u4e14\u6709\u660e\u786e\u7684\u7c7b\u578b\u8303\u56f4\u4e0e\u82e5\u5e72\u5355\u53c2 API\u3002</li> </ul>"},{"location":"web3/dapp/hardhat_tutorial_240415/#52","title":"5.2 \u989d\u5916\u8c03\u8bd5\u6293\u624b","text":"<p>\u5931\u8d25\u5806\u6808\uff1aHardhat Network \u9ed8\u8ba4\u4f1a\u5728\u4ea4\u6613\u5931\u8d25\u65f6\u629b\u51fa\u201cJavaScript + Solidity\u201d\u7684\u7ec4\u5408\u5806\u6808\u4fe1\u606f\uff08\u4fbf\u4e8e\u5b9a\u4f4d revert \u89e6\u53d1\u70b9\uff09\u3002</p> <p>in-process vs JSON-RPC node\uff1a\u6d4b\u8bd5\u65f6\u7528\u7684\u662f in-process Hardhat Network\uff1b\u5982\u679c\u7528 <code>node</code> \u4efb\u52a1\u542f\u52a8 JSON-RPC server\uff08\u4fbf\u4e8e\u524d\u7aef/\u94b1\u5305\u8fde\u63a5\uff09\uff0c\u65e5\u5fd7\u4e0e\u884c\u4e3a\u4f1a\u7565\u6709\u4e0d\u540c\uff08\u4f8b\u5982 loggingEnabled \u9ed8\u8ba4\u503c\u5bf9 in-process \u4e0e node \u6709\u5dee\u5f02\uff09\u3002</p>"},{"location":"web3/dapp/hardhat_tutorial_240415/#sepolia","title":"\u516d\u3001\u90e8\u7f72\u5230 Sepolia \u6d4b\u8bd5\u7f51","text":""},{"location":"web3/dapp/hardhat_tutorial_240415/#61-ignition-module","title":"6.1 \u7528 Ignition Module \u63cf\u8ff0\u90e8\u7f72","text":"<p>Ignition \u7684\u90e8\u7f72\u5165\u53e3\u662f Module\uff0c\u653e\u5728 <code>ignition/modules</code> \u76ee\u5f55\u4e0b\u3002</p> <p>\u521b\u5efa <code>ignition/modules/MiniToken.js</code> \u6587\u4ef6\u5982\u4e0b\uff1a</p> <pre><code>const { buildModule } = require(\"@nomicfoundation/hardhat-ignition/modules\");\n\nconst TokenModule = buildModule(\"TokenModule\", (m) =&gt; {\n  const token = m.contract(\"Token\");\n\n  return { token };\n});\n\nmodule.exports = TokenModule;\n</code></pre>"},{"location":"web3/dapp/hardhat_tutorial_240415/#62-sepolia-rpc","title":"6.2 \u914d\u7f6e Sepolia RPC \u4e0e\u79c1\u94a5","text":"<p>\u90e8\u7f72\u5230\u8fdc\u7a0b\u6d4b\u8bd5\u7f51\u7edc\u9700\u8981\u5728 <code>hardhat.config.js</code> \u4e2d\u914d\u7f6e RPC \u4fe1\u606f\uff0c\u7136\u540e\u5728\u90e8\u7f72\u6307\u4ee4\u4e2d\u4f7f\u7528 <code>--network</code>\u53c2\u6570\u544a\u77e5 Hardhat \u8fde\u63a5\u5230\u54ea\u4e2a\u7f51\u7edc\u3002</p> <p>\u6ce8\u518c\u4e00\u4e2a Alchemy \u8d26\u6237\uff0c \u7136\u540e\u521b\u5efa\u4e00\u4e2a Ethereum Sepolia \u7684 App\uff0c\u83b7\u53d6\u8be5 App \u7684 API key\u3002</p> <p>\u4ece\u865a\u62df\u94b1\u5305\u53d1\u51fa\u7684\u6bcf\u4e00\u7b14\u4ea4\u6613\u90fd\u9700\u8981\u4f7f\u7528<code>private key</code>\u6765\u7b7e\u540d\uff0c\u8be5\u6b65\u9aa4\u901a\u8fc7\u628a\u94b1\u5305\u5730\u5740\u7684 private key\u3001alchemy API key \u5b58\u50a8\u5728\u4e00\u4e2a environment file \u4e2d\uff0c\u6765\u4e3a\u7a0b\u5e8f\u63d0\u4f9b\u5fc5\u8981\u7684\u8bbf\u95ee\u6743\u9650\u3002</p> <p>\u901a\u8fc7<code>npm install dotenv</code>\u6307\u4ee4\u5b89\u88c5 dotenv \u6a21\u5757\uff0c\u4ee5\u4fbf\u8bfb\u53d6<code>.env</code>\u6587\u4ef6\uff1a</p> <pre><code>ALCHEMY_API_KEY = \"xxx\"\nSEPOLIA_PRIVATE_KEY = \"xxx\"\n</code></pre> <p>\u6ce8\uff1a\u6d4b\u8bd5\u7528\u7684\u94b1\u5305\u5730\u5740\u4e2d\u4e0d\u8981\u653e\u7f6e\u4efb\u4f55\u771f\u5b9e\u8d44\u4ea7\u3002</p> <p>\u5728<code>hardhat.config.js</code>\u6587\u4ef6\u4e2d\u6dfb\u52a0\u914d\u7f6e\uff0c\u4ee5\u4fbf\u90e8\u7f72\u5230 Sepolia \u6d4b\u8bd5\u7f51\uff1a</p> <pre><code>require(\"@nomicfoundation/hardhat-toolbox\");\nrequire(\"dotenv\").config();\n\nconst { ALCHEMY_API_KEY, SEPOLIA_PRIVATE_KEY } = process.env;\n\n/** @type import('hardhat/config').HardhatUserConfig */\nmodule.exports = {\n  solidity: \"0.8.28\",\n  networks: {\n    sepolia: {\n      url: `https://eth-sepolia.g.alchemy.com/v2/${ALCHEMY_API_KEY}`,\n      accounts: [SEPOLIA_PRIVATE_KEY],\n    },\n  },\n};\n</code></pre>"},{"location":"web3/dapp/hardhat_tutorial_240415/#63","title":"6.3 \u90e8\u7f72\u5408\u7ea6","text":"<p>\u5230\u76ee\u524d\u4e3a\u6b62\uff0c\u5df2\u7ecf\u53ef\u4ee5\u5b8c\u6210\u6700\u540e\u7684\u90e8\u7f72\u4e86\uff0c\u5728\u7ec8\u7aef\u4e2d\u6267\u884c\u5982\u4e0b\u6307\u4ee4\uff1a</p> <pre><code>$ npx hardhat ignition deploy ./ignition/modules/MiniToken.js --network sepolia\n[dotenv@17.2.3] injecting env (2) from .env -- tip: \ud83d\udd10 prevent committing .env to code: https://dotenvx.com/precommit\n\u2714 Confirm deploy to network sepolia (11155111)? \u2026 yes\n[ MiniTokenModule ] Nothing new to deploy based on previous execution stored in ./ignition/deployments/chain-11155111\n\nDeployed Addresses\n\nMiniTokenModule#MiniToken - 0x07831829b9F8182eE65B446adc7cD6Dc0Ba61b6D\n</code></pre> <p>Hardhat \u4e5f\u652f\u6301\u901a\u8fc7\u811a\u672c\u6765\u90e8\u7f72\u5408\u7ea6\u3002\u5728\u9879\u76ee\u6839\u76ee\u5f55\u4e0b\u65b0\u5efa<code>scripts/</code> \u76ee\u5f55\uff0c\u5c06 JS \u7f16\u5199\u7684\u90e8\u7f72\u811a\u672c <code>deploy.js</code> \u653e\u5728\u8be5<code>scripts/</code> \u76ee\u5f55\u4e2d\uff0c\u6700\u540e\u6267\u884c <code>npx hardhat run scripts/deploy.js --network sepolia</code>\u5c31\u53ef\u4ee5\u4e86\u3002</p> <pre><code>const hre = require(\"hardhat\");\n\nasync function main() {\n  const [deployer] = await hre.ethers.getSigners();\n\n  const balance = await hre.ethers.provider.getBalance(deployer.address);\n  console.log(\"Deployer:\", deployer.address);\n  console.log(\"Deployer balance:\", hre.ethers.formatEther(balance), \"ETH\");\n\n  // \u63a8\u8350\u5199\u6cd5\uff1ahardhat-ethers \u63d0\u4f9b ethers.deployContract\n  const token = await hre.ethers.deployContract(\"MiniToken\");\n  await token.waitForDeployment();\n\n  // ethers v6 \u5408\u7ea6\u5730\u5740\u5e38\u7528 token.target\uff08\u6216 await token.getAddress()\uff09\n  console.log(\"MiniToken deployed to:\", token.target);\n\n  const tx = token.deploymentTransaction();\n  console.log(\"Deployment tx hash:\", tx.hash);\n}\n\nmain().catch((err) =&gt; {\n  console.error(err);\n  process.exitCode = 1;\n});\n</code></pre> <p>\u6267\u884c\u7ed3\u679c\u5927\u81f4\u5982\u4e0b\uff1a</p> <pre><code>test@DESKTOP-958GQ8P:~/desktop/hardhat-tutorial$ npx hardhat run scripts/deploy.js --network sepolia\n[dotenv@17.2.3] injecting env (2) from .env -- tip: \u2699\ufe0f  load multiple .env files with { path: ['.env.local', '.env'] }\n[dotenv@17.2.3] injecting env (0) from .env -- tip: \ud83d\udee0\ufe0f  run anywhere with `dotenvx run -- yourcommand`\nDeployer: 0x84B62e4c0766414a867A5aCc7BCa14901B3c713C\nDeployer balance: 0.508237594610744345 ETH\nMiniToken deployed to: 0xEc2E9d1ddEb8d6b1F695c23512afaa70d716458e\nDeployment tx hash: 0x421c29757589388e092d52d48bf65d89060bb725cfc96a9b02497557b64bd8fa\n</code></pre> <p>\u53c2\u8003\u8d44\u6599\uff1aHardhat's tutorial for beginners</p>"},{"location":"web3/dapp/solidity_contract_call_part1_251221/","title":"Solidity \u5408\u7ea6\u95f4\u8c03\u7528\uff08\u4e00\uff09\uff1a\u56db\u79cd\u65b9\u5f0f\u8c03\u7528\u5df2\u90e8\u7f72\u5408\u7ea6","text":"<p>\u5f53\u4f60\u7684\u5408\u7ea6\u9700\u8981\u548c\u94fe\u4e0a\u5176\u4ed6\u5408\u7ea6\u4ea4\u4e92\u65f6\uff0c\u8be5\u600e\u4e48\u505a\uff1f\u672c\u7bc7\u4ecb\u7ecd\u6700\u5e38\u7528\u7684\u56db\u79cd\u65b9\u5f0f\u3002</p>"},{"location":"web3/dapp/solidity_contract_call_part1_251221/#receive-fallback","title":"\u524d\u7f6e\u77e5\u8bc6\uff1areceive \u548c fallback","text":"<p>\u5728\u8bb2\u8c03\u7528\u4e4b\u524d\uff0c\u5148\u8ba4\u8bc6\u4e24\u4e2a\u7279\u6b8a\u51fd\u6570\u3002\u5b83\u4eec\u662f\u5408\u7ea6\u7684\"\u540e\u95e8\u5165\u53e3\"\uff0c\u5728\u63a5\u6536 ETH \u548c\u5904\u7406\u5408\u7ea6\u4e2d\u4e0d\u5b58\u5728\u7684\u51fd\u6570\u8c03\u7528\u65f6\u975e\u5e38\u91cd\u8981\u3002</p>"},{"location":"web3/dapp/solidity_contract_call_part1_251221/#receive-eth","title":"receive\uff1a\u4e13\u95e8\u63a5\u6536 ETH","text":"<p>\u5f53\u5408\u7ea6\u6536\u5230\u7eaf ETH \u8f6c\u8d26\uff08\u6ca1\u6709\u9644\u5e26\u4efb\u4f55\u6570\u636e\uff09\u65f6\uff0c<code>receive</code> \u4f1a\u88ab\u89e6\u53d1\u3002</p> <pre><code>receive() external payable {\n    // \u5904\u7406\u6536\u5230\u7684 ETH\n}\n</code></pre> <p>\u8bed\u6cd5\u7279\u70b9\uff1a\u6ca1\u6709 <code>function</code> \u5173\u952e\u5b57\uff0c\u6ca1\u6709\u53c2\u6570\uff0c\u6ca1\u6709\u8fd4\u56de\u503c\uff0c\u5fc5\u987b\u662f <code>external payable</code>\u3002</p>"},{"location":"web3/dapp/solidity_contract_call_part1_251221/#fallback","title":"fallback\uff1a\u515c\u5e95\u51fd\u6570","text":"<p>\u5f53\u8c03\u7528\u5408\u7ea6\u65f6\uff0c\u5982\u679c\u627e\u4e0d\u5230\u5339\u914d\u7684\u51fd\u6570\uff0c\u5c31\u4f1a\u89e6\u53d1 <code>fallback</code>\u3002</p> <pre><code>// \u57fa\u7840\u5f62\u5f0f\nfallback() external payable {}\n\n// \u5e26\u53c2\u6570\u5f62\u5f0f\uff08\u53ef\u4ee5\u8bbf\u95ee calldata \u5e76\u8fd4\u56de\u6570\u636e\uff09\nfallback(bytes calldata input) external payable returns (bytes memory) {\n    return abi.encode(input.length);\n}\n</code></pre>"},{"location":"web3/dapp/solidity_contract_call_part1_251221/#_1","title":"\u89e6\u53d1\u903b\u8f91","text":"<pre><code>                     \u8c03\u7528\u5408\u7ea6\n                        \u2502\n                        \u25bc\n                 msg.data \u662f\u5426\u4e3a\u7a7a\uff1f\n                   /         \\\n                 \u662f            \u5426\n                /               \\\n              \u25bc                  \u25bc\n        receive \u5b58\u5728\uff1f      \u51fd\u6570\u7b7e\u540d\u5339\u914d\uff1f\n          /     \\            /       \\\n        \u662f       \u5426        \u662f         \u5426\n        /         \\        /           \\\n    receive    fallback  \u6267\u884c\u51fd\u6570    fallback\n</code></pre> <p>\u7b80\u5355\u8bb0\u5fc6\uff1a\u7eaf\u8f6c\u8d26\u8d70 receive\uff0c\u5176\u4ed6\u515c\u5e95\u8d70 fallback\u3002</p>"},{"location":"web3/dapp/solidity_contract_call_part1_251221/#_2","title":"\u8c03\u7528\u5df2\u90e8\u7f72\u5408\u7ea6\u9700\u8981\u4ec0\u4e48\uff1f","text":"<p>\u4e24\u6837\u4e1c\u897f\uff1a\u5408\u7ea6\u5730\u5740 + \u8c03\u7528\u63a5\u53e3\u3002</p> <p>\u63a5\u53e3\u544a\u8bc9\u7f16\u8bd1\u5668\uff1a\u8fd9\u4e2a\u5730\u5740\u4e0a\u7684\u5408\u7ea6\u6709\u54ea\u4e9b\u51fd\u6570\u53ef\u4ee5\u8c03\u7528\u3002</p> <pre><code>interface IERC20 {\n    function balanceOf(address account) external view returns (uint256);\n    function transfer(address to, uint256 amount) external returns (bool);\n    // ...\u5176\u4ed6\u51fd\u6570\n}\n</code></pre> <p>\u6709\u4e86\u63a5\u53e3\uff0c\u5c31\u53ef\u4ee5\u5f00\u59cb\u8c03\u7528\u4e86\u3002</p>"},{"location":"web3/dapp/solidity_contract_call_part1_251221/#_3","title":"\u65b9\u5f0f\u4e00\uff1a\u901a\u8fc7\u63a5\u53e3\u8c03\u7528\uff08\u63a8\u8350\uff09","text":"<p>\u8fd9\u662f\u6700\u5e38\u7528\u3001\u6700\u63a8\u8350\u7684\u65b9\u5f0f\uff0c\u7c7b\u578b\u5b89\u5168\uff0c\u4ee3\u7801\u6e05\u6670\u3002</p> <pre><code>import \"./IERC20.sol\";\n\ncontract MyContract {\n    function getBalance(address token, address account) public view returns (uint256) {\n        return IERC20(token).balanceOf(account);\n    }\n}\n</code></pre> <p>\u6838\u5fc3\u8bed\u6cd5\uff1a<code>IERC20(token)</code> \u628a\u5730\u5740\"\u5305\u88c5\"\u6210\u63a5\u53e3\u7c7b\u578b\uff0c\u7136\u540e\u5c31\u80fd\u50cf\u8c03\u7528\u672c\u5730\u51fd\u6570\u4e00\u6837\u8c03\u7528\u5b83\u3002</p>"},{"location":"web3/dapp/solidity_contract_call_part1_251221/#_4","title":"\u65b9\u5f0f\u4e8c\uff1a\u901a\u8fc7\u5408\u7ea6\u7c7b\u578b\u8c03\u7528","text":"<p>\u5982\u679c\u4f60\u6709\u76ee\u6807\u5408\u7ea6\u7684\u5b8c\u6574\u4ee3\u7801\uff0c\u53ef\u4ee5\u76f4\u63a5\u7528\u5408\u7ea6\u7c7b\u578b\u3002</p> <pre><code>import \"./ERC20.sol\";\n\ncontract MyContract {\n    function getBalance(address token, address account) public view returns (uint256) {\n        return ERC20(token).balanceOf(account);\n    }\n}\n</code></pre> <p>\u672c\u8d28\u4e0a\u548c\u63a5\u53e3\u8c03\u7528\u4e00\u6837\u2014\u2014\u90fd\u662f\u544a\u8bc9\u7f16\u8bd1\u5668\"\u8fd9\u4e2a\u5730\u5740\u6709\u54ea\u4e9b\u51fd\u6570\"\u3002</p> <p>\u533a\u522b\uff1a\u63a5\u53e3\u53ea\u58f0\u660e\u51fd\u6570\u7b7e\u540d\uff0c\u5408\u7ea6\u7c7b\u578b\u5305\u542b\u5b8c\u6574\u5b9e\u73b0\u3002\u5982\u679c\u53ea\u9700\u8981\u8c03\u7528\uff0c\u7528\u63a5\u53e3\u66f4\u8f7b\u91cf\u3002</p>"},{"location":"web3/dapp/solidity_contract_call_part1_251221/#_5","title":"\u65b9\u5f0f\u4e09\uff1a\u5b58\u50a8\u5408\u7ea6\u5f15\u7528","text":"<p>\u5f53\u4f60\u9700\u8981\u591a\u6b21\u8c03\u7528\u540c\u4e00\u4e2a\u5408\u7ea6\u65f6\uff0c\u53ef\u4ee5\u628a\u5f15\u7528\u5b58\u4e3a\u72b6\u6001\u53d8\u91cf\u3002</p> <pre><code>import \"./IERC20.sol\";\n\ncontract MyContract {\n    IERC20 public token;  // \u5b58\u50a8\u5408\u7ea6\u5f15\u7528\n\n    constructor(address _token) {\n        token = IERC20(_token);\n    }\n\n    function getBalance(address account) public view returns (uint256) {\n        return token.balanceOf(account);\n    }\n\n    function doTransfer(address to, uint256 amount) public {\n        token.transfer(to, amount);\n    }\n}\n</code></pre> <p>\u597d\u5904\uff1a\u4ee3\u7801\u66f4\u7b80\u6d01\uff0c\u4e0d\u7528\u6bcf\u6b21\u90fd\u4f20\u5730\u5740\u3002</p>"},{"location":"web3/dapp/solidity_contract_call_part1_251221/#call","title":"\u65b9\u5f0f\u56db\uff1a\u4f7f\u7528 call \u8c03\u7528","text":"<p>\u5f53\u4f60\u4e0d\u77e5\u9053\u76ee\u6807\u5408\u7ea6\u7684\u63a5\u53e3\u65f6\uff0c\u53ef\u4ee5\u7528\u5e95\u5c42\u7684 <code>call</code>\u3002</p> <pre><code>contract MyContract {\n    function getBalance(address token, address account) public returns (uint256) {\n        (bool success, bytes memory data) = token.call(\n            abi.encodeWithSignature(\"balanceOf(address)\", account)\n        );\n        require(success, \"Call failed\");\n        return abi.decode(data, (uint256));\n    }\n}\n</code></pre> <p><code>call</code> \u662f <code>address</code> \u7c7b\u578b\u7684\u5e95\u5c42\u65b9\u6cd5\uff0c\u7279\u70b9\u662f\uff1a</p> <ul> <li>\u9700\u8981\u81ea\u5df1\u6784\u9020 calldata</li> <li>\u9700\u8981\u81ea\u5df1\u68c0\u67e5 success</li> <li>\u9700\u8981\u81ea\u5df1\u89e3\u6790\u8fd4\u56de\u503c</li> </ul> <p>\u4ec0\u4e48\u65f6\u5019\u7528 call\uff1f</p> <ul> <li>\u76ee\u6807\u5408\u7ea6\u7684 ABI \u672a\u77e5</li> <li>\u9700\u8981\u66f4\u7075\u6d3b\u7684\u63a7\u5236\uff08\u5982\u6307\u5b9a gas\u3001\u9644\u5e26 ETH\uff09</li> </ul> <p>\u4e00\u822c\u60c5\u51b5\u4e0b\uff0c\u4f18\u5148\u7528\u63a5\u53e3\u8c03\u7528\uff0c\u66f4\u5b89\u5168\u66f4\u6e05\u6670\u3002</p>"},{"location":"web3/dapp/solidity_contract_call_part1_251221/#_6","title":"\u56db\u79cd\u65b9\u5f0f\u5bf9\u6bd4","text":"\u65b9\u5f0f \u9700\u8981\u63a5\u53e3/\u5408\u7ea6\u4ee3\u7801 \u7c7b\u578b\u5b89\u5168 \u4f7f\u7528\u573a\u666f \u63a5\u53e3\u8c03\u7528 \u9700\u8981\u63a5\u53e3 \u2705 \u65e5\u5e38\u5f00\u53d1\u9996\u9009 \u5408\u7ea6\u7c7b\u578b\u8c03\u7528 \u9700\u8981\u5b8c\u6574\u4ee3\u7801 \u2705 \u6709\u6e90\u7801\u65f6\u53ef\u7528 \u5b58\u50a8\u5f15\u7528 \u9700\u8981\u63a5\u53e3 \u2705 \u9891\u7e41\u8c03\u7528\u540c\u4e00\u5408\u7ea6 call \u8c03\u7528 \u4e0d\u9700\u8981 \u274c ABI \u672a\u77e5\u6216\u9700\u8981\u5e95\u5c42\u63a7\u5236"},{"location":"web3/dapp/solidity_contract_call_part1_251221/#_7","title":"\u5c0f\u7ed3","text":"<p>\u672c\u7bc7\u6211\u4eec\u5b66\u4e60\u4e86\uff1a</p> <ol> <li><code>receive</code> \u548c <code>fallback</code> \u7684\u89e6\u53d1\u903b\u8f91</li> <li>\u56db\u79cd\u8c03\u7528\u5df2\u90e8\u7f72\u5408\u7ea6\u7684\u65b9\u5f0f</li> <li>\u65e5\u5e38\u5f00\u53d1\u63a8\u8350\u4f7f\u7528\u63a5\u53e3\u8c03\u7528</li> </ol> <p>\u4e0b\u4e00\u7bc7\uff0c\u6211\u4eec\u6df1\u5165 <code>call</code> \u7684\u5e95\u5c42\u7ec6\u8282\uff1a\u5982\u4f55\u6784\u9020 calldata\u3001\u4e09\u79cd ABI \u7f16\u7801\u65b9\u5f0f\u7684\u533a\u522b\uff0c\u4ee5\u53ca\u5982\u4f55\u6b63\u786e\u5904\u7406\u8fd4\u56de\u503c\u3002</p> <p>\u7cfb\u5217\u5bfc\u822a</p> <ul> <li>\u7b2c\u4e00\u7bc7\uff1aSolidity \u5408\u7ea6\u95f4\u8c03\u7528\uff08\u4e00\uff09\uff1a\u56db\u79cd\u65b9\u5f0f\u8c03\u7528\u5df2\u90e8\u7f72\u5408\u7ea6\uff08\u672c\u7bc7\uff09</li> <li>\u7b2c\u4e8c\u7bc7\uff1aSolidity \u5408\u7ea6\u95f4\u8c03\u7528\uff08\u4e8c\uff09\uff1a\u5e95\u5c42\u8c03\u7528\u4e0e calldata \u8be6\u89e3</li> <li>\u7b2c\u4e09\u7bc7\uff1aSolidity \u5408\u7ea6\u95f4\u8c03\u7528\uff08\u4e09\uff09\uff1a\u521b\u5efa\u5408\u7ea6\u7684\u4e24\u79cd\u65b9\u5f0f\uff1acreate \u4e0e create2</li> </ul>"},{"location":"web3/dapp/solidity_contract_call_part2_251223/","title":"Solidity \u5408\u7ea6\u95f4\u8c03\u7528\uff08\u4e8c\uff09\uff1a\u5e95\u5c42\u8c03\u7528\u4e0e calldata \u8be6\u89e3","text":"<p>\u4e0a\u4e00\u7bc7\u6211\u4eec\u77e5\u9053\u4e86 call \u53ef\u4ee5\u5728\u4e0d\u77e5\u9053 ABI \u7684\u60c5\u51b5\u4e0b\u8c03\u7528\u5408\u7ea6\u3002\u672c\u7bc7\u6df1\u5165\u8bb2\u89e3 call \u7684\u5b8c\u6574\u7528\u6cd5\u3002</p>"},{"location":"web3/dapp/solidity_contract_call_part2_251223/#call","title":"call \u7684\u5b8c\u6574\u8bed\u6cd5","text":"<pre><code>(bool success, bytes memory data) = targetAddress.call{\n    value: 0.001 ether,  // \u9644\u5e26\u7684 ETH\uff08\u53ef\u9009\uff09\n    gas: 100000          // \u6307\u5b9a gas \u4e0a\u9650\uff08\u53ef\u9009\uff09\n}(\n    calldata              // \u8981\u53d1\u9001\u7684\u6570\u636e\n);\n</code></pre> <p>\u5404\u90e8\u5206\u542b\u4e49\uff1a</p> \u90e8\u5206 \u8bf4\u660e <code>targetAddress</code> \u76ee\u6807\u5408\u7ea6\u5730\u5740 <code>value</code> \u9644\u5e26\u7684 ETH\uff0c\u76ee\u6807\u51fd\u6570\u9700\u8981\u662f <code>payable</code> <code>gas</code> \u8f6c\u53d1\u7684 gas \u4e0a\u9650\uff0c\u4e0d\u5199\u5219\u8f6c\u53d1\u5927\u90e8\u5206\u5269\u4f59 gas <code>calldata</code> \u51fd\u6570\u9009\u62e9\u5668 + ABI \u7f16\u7801\u7684\u53c2\u6570 <code>success</code> \u8c03\u7528\u662f\u5426\u6210\u529f\uff08\u76ee\u6807\u6ca1\u6709 revert\uff09 <code>data</code> \u76ee\u6807\u51fd\u6570\u7684\u8fd4\u56de\u503c\uff08\u539f\u59cb bytes\uff09 <p>\u91cd\u8981\uff1a<code>call</code> \u6c38\u8fdc\u4e0d\u4f1a revert\u3002\u5373\u4f7f\u76ee\u6807\u5408\u7ea6\u51fa\u9519\uff0c\u4e5f\u53ea\u662f\u8fd4\u56de <code>success = false</code>\u3002\u4f60\u5fc5\u987b\u81ea\u5df1\u68c0\u67e5\u5e76\u5904\u7406\u5931\u8d25\u60c5\u51b5\u3002</p>"},{"location":"web3/dapp/solidity_contract_call_part2_251223/#calldata","title":"calldata \u662f\u4ec0\u4e48\uff1f","text":"<p>\u5f53\u4f60\u8c03\u7528 <code>token.transfer(to, amount)</code> \u65f6\uff0cEVM \u6536\u5230\u7684\u4e0d\u662f\u51fd\u6570\u540d\uff0c\u800c\u662f\u4e00\u4e32\u5b57\u8282\uff1a</p> <pre><code>0xa9059cbb                                                        \u2190 \u51fd\u6570\u9009\u62e9\u5668\uff084 \u5b57\u8282\uff09\n000000000000000000000000recipient_address_here                    \u2190 \u53c2\u65701: to\n0000000000000000000000000000000000000000000000000000000000000064  \u2190 \u53c2\u65702: amount\n</code></pre> <p>\u8fd9\u4e32\u5b57\u8282\u5c31\u662f calldata\uff0c\u7531\u4e24\u90e8\u5206\u7ec4\u6210\uff1a</p> <ol> <li>\u51fd\u6570\u9009\u62e9\u5668\uff084 \u5b57\u8282\uff09\uff1a<code>bytes4(keccak256(\"transfer(address,uint256)\"))</code></li> <li>ABI \u7f16\u7801\u7684\u53c2\u6570\uff1a\u6309\u987a\u5e8f\u7f16\u7801\u7684\u53c2\u6570\u503c</li> </ol>"},{"location":"web3/dapp/solidity_contract_call_part2_251223/#calldata_1","title":"\u4e09\u79cd\u6784\u9020 calldata \u7684\u65b9\u5f0f","text":""},{"location":"web3/dapp/solidity_contract_call_part2_251223/#1-abiencodewithsignature","title":"1. abi.encodeWithSignature","text":"<p>\u7528\u51fd\u6570\u7b7e\u540d\u5b57\u7b26\u4e32\u6784\u9020\uff1a</p> <pre><code>bytes memory data = abi.encodeWithSignature(\n    \"transfer(address,uint256)\",  // \u51fd\u6570\u7b7e\u540d\n    to,                           // \u53c2\u65701\n    amount                        // \u53c2\u65702\n);\n</code></pre> <p>\u6ce8\u610f\uff1a\u7b7e\u540d\u5b57\u7b26\u4e32\u4e2d\u53c2\u6570\u7c7b\u578b\u7528\u9017\u53f7\u5206\u9694\uff0c\u4e0d\u80fd\u6709\u7a7a\u683c\uff0c\u4e5f\u4e0d\u5305\u542b\u8fd4\u56de\u503c\u7c7b\u578b\u3002</p>"},{"location":"web3/dapp/solidity_contract_call_part2_251223/#2-abiencodewithselector","title":"2. abi.encodeWithSelector","text":"<p>\u7528\u51fd\u6570\u9009\u62e9\u5668\u6784\u9020\uff1a</p> <pre><code>bytes memory data = abi.encodeWithSelector(\n    IERC20.transfer.selector,  // 4 \u5b57\u8282\u9009\u62e9\u5668\n    to,\n    amount\n);\n</code></pre> <p>\u4e24\u8005\u672c\u8d28\u76f8\u540c\uff1a</p> <pre><code>abi.encodeWithSignature(sig, args...) \n\u2261 \nabi.encodeWithSelector(bytes4(keccak256(bytes(sig))), args...)\n</code></pre>"},{"location":"web3/dapp/solidity_contract_call_part2_251223/#3-abiencodecall","title":"3. abi.encodeCall\uff08\u63a8\u8350\uff09","text":"<p>Solidity 0.8.11 \u5f15\u5165\uff0c\u7c7b\u578b\u5b89\u5168\uff1a</p> <pre><code>bytes memory data = abi.encodeCall(\n    IERC20.transfer,    // \u51fd\u6570\u6307\u9488\uff0c\u901a\u5e38\u6765\u81ea\u63a5\u53e3\u3001\u5408\u7ea6\u540d\u7684\u51fd\u6570\u6210\u5458\n    (to, amount)        // \u53c2\u6570\u5143\u7ec4\n);\n</code></pre> <p>\u5173\u952e\u533a\u522b\uff1a\u7f16\u8bd1\u5668\u4f1a\u68c0\u67e5\u53c2\u6570\u7c7b\u578b\u662f\u5426\u5339\u914d\u51fd\u6570\u5b9a\u4e49\u3002\u5982\u679c\u4f60\u4f20\u9519\u7c7b\u578b\uff0c\u7f16\u8bd1\u65f6\u5c31\u4f1a\u62a5\u9519\u3002</p>"},{"location":"web3/dapp/solidity_contract_call_part2_251223/#_1","title":"\u4e09\u79cd\u65b9\u5f0f\u5bf9\u6bd4","text":"\u65b9\u5f0f \u7c7b\u578b\u68c0\u67e5 \u91cd\u6784\u53cb\u597d \u63a8\u8350\u573a\u666f <code>encodeWithSignature</code> \u274c \u274c \u5feb\u901f\u8c03\u8bd5\u3001\u5b9e\u9a8c <code>encodeWithSelector</code> \u274c \u274c \u53ea\u6709 selector \u65f6 <code>encodeCall</code> \u2705 \u2705 \u751f\u4ea7\u4ee3\u7801\u9996\u9009 <p>\u4e3a\u4ec0\u4e48 <code>encodeCall</code> \u66f4\u597d\uff1f</p> <pre><code>// \u5047\u8bbe\u63a5\u53e3\u6539\u4e86\uff1atransfer(address,uint256) \u2192 transfer(address,uint128)\n\n// encodeWithSignature\uff1a\u7f16\u8bd1\u901a\u8fc7\uff0c\u8fd0\u884c\u65f6\u9759\u9ed8\u5931\u8d25\nabi.encodeWithSignature(\"transfer(address,uint256)\", to, amount);\n\n// encodeCall\uff1a\u7f16\u8bd1\u62a5\u9519\uff0c\u7acb\u5373\u53d1\u73b0\u95ee\u9898\nabi.encodeCall(IERC20.transfer, (to, amount));\n</code></pre>"},{"location":"web3/dapp/solidity_contract_call_part2_251223/#_2","title":"\u5904\u7406\u8fd4\u56de\u503c","text":"<p><code>call</code> \u8fd4\u56de\u7684 <code>data</code> \u662f\u539f\u59cb bytes\uff0c\u9700\u8981\u7528 <code>abi.decode</code> \u89e3\u6790\uff1a</p> <pre><code>(bool success, bytes memory returnData) = token.call(data);\nrequire(success, \"Call failed\");\n\nbool result = abi.decode(returnData, (bool));\n</code></pre> <p>\u5b9e\u9645\u5f00\u53d1\u4e2d\u7684\u5751\uff1a\u6709\u4e9b\u975e\u6807\u51c6 ERC20 \u4ee3\u5e01\u7684 <code>transfer</code> \u4e0d\u8fd4\u56de\u503c\uff0c\u4f46\u6267\u884c\u6210\u529f\u3002\u76f4\u63a5 <code>abi.decode</code> \u4f1a\u5931\u8d25\u3002</p> <p>\u517c\u5bb9\u5199\u6cd5\uff1a</p> <pre><code>function _parseBoolReturn(bool success, bytes memory returnData) internal pure returns (bool) {\n    if (!success) return false;\n    if (returnData.length == 0) return true;  // \u517c\u5bb9\u975e\u6807\u51c6 ERC20\n    return abi.decode(returnData, (bool));\n}\n</code></pre>"},{"location":"web3/dapp/solidity_contract_call_part2_251223/#_3","title":"\u5904\u7406\u8c03\u7528\u5931\u8d25","text":"<p><code>call</code> \u8fd4\u56de <code>success = false</code> \u7684\u60c5\u51b5\uff1a</p> <ul> <li>\u76ee\u6807\u51fd\u6570 <code>revert</code></li> <li>gas \u4e0d\u8db3</li> <li>\u76ee\u6807\u5730\u5740\u6ca1\u6709\u4ee3\u7801</li> <li>\u5176\u4ed6\u6267\u884c\u9519\u8bef</li> </ul> <p>\u6ce8\u610f\uff1a\u8c03\u7528\u4e00\u4e2a\u4e0d\u5b58\u5728\u7684\u51fd\u6570\uff0c\u5982\u679c\u76ee\u6807\u5408\u7ea6\u6709 <code>fallback</code>\uff0c<code>success</code> \u53ef\u80fd\u662f <code>true</code>\uff01</p> <p>\u6b63\u786e\u7684\u9519\u8bef\u5904\u7406\uff1a</p> <pre><code>(bool success, bytes memory returnData) = target.call(data);\n\nif (!success) {\n    if (returnData.length &gt; 0) {\n        // \u8f6c\u53d1 revert \u539f\u56e0\n        assembly {\n            revert(add(returnData, 32), mload(returnData))\n        }\n    } else {\n        revert(\"Call failed without reason\");\n    }\n}\n</code></pre>"},{"location":"web3/dapp/solidity_contract_call_part2_251223/#call-eth","title":"\u7528 call \u53d1\u9001 ETH","text":"<p>\u9664\u4e86\u8c03\u7528\u51fd\u6570\uff0c<code>call</code> \u4e5f\u662f\u53d1\u9001 ETH \u7684\u63a8\u8350\u65b9\u5f0f\uff1a</p> <pre><code>// \u7eaf\u8f6c\u8d26\uff0c\u4e0d\u8c03\u7528\u4efb\u4f55\u51fd\u6570\n(bool success, ) = recipient.call{value: 1 ether}(\"\");\nrequire(success, \"Transfer failed\");\n</code></pre> <p>\u4e3a\u4ec0\u4e48\u4e0d\u7528 <code>transfer</code> \u6216 <code>send</code>\uff1f\u56e0\u4e3a\u5b83\u4eec\u6709 2300 gas \u9650\u5236\uff0c\u53ef\u80fd\u5bfc\u81f4\u63a5\u6536\u65b9\u7684 <code>receive</code> \u51fd\u6570\u6267\u884c\u5931\u8d25\u3002</p>"},{"location":"web3/dapp/solidity_contract_call_part2_251223/#transferviacall","title":"\u52a8\u624b\u5b9e\u9a8c\uff1aTransferViaCall","text":"<p>\u4e0b\u9762\u8fd9\u4e2a\u5408\u7ea6\u5b8c\u6574\u6f14\u793a\u4e86\u56db\u79cd\u8f6c\u8d26\u65b9\u5f0f\uff0c\u53ef\u4ee5\u90e8\u7f72\u540e\u5b9e\u9645\u5bf9\u6bd4\uff1a</p> <pre><code>// SPDX-License-Identifier: MIT\npragma solidity ^0.8.28;\n\nimport \"./IERC20.sol\";\n\ncontract TransferViaCall {\n    event LowLevelCall(bool success, bytes returnData);\n\n    // 1\uff09\u63a5\u53e3\u76f4\u63a5\u8c03\u7528\n    function transferViaInterface(address token, address recipient, uint256 amount) external returns (bool) {\n        return IERC20(token).transfer(recipient, amount);\n    }\n\n    // 2\uff09encodeWithSignature\n    function transferViaSignature(address token, address recipient, uint256 amount) external returns (bool) {\n        bytes memory data = abi.encodeWithSignature(\"transfer(address,uint256)\", recipient, amount);\n        (bool success, bytes memory returnData) = token.call(data);\n        emit LowLevelCall(success, returnData);\n        return _parseBoolReturn(success, returnData);\n    }\n\n    // 3\uff09encodeWithSelector\n    function transferViaSelector(address token, address recipient, uint256 amount) external returns (bool) {\n        bytes memory data = abi.encodeWithSelector(IERC20.transfer.selector, recipient, amount);\n        (bool success, bytes memory returnData) = token.call(data);\n        emit LowLevelCall(success, returnData);\n        return _parseBoolReturn(success, returnData);\n    }\n\n    // 4\uff09encodeCall\uff08\u63a8\u8350\uff09\n    function transferViaEncodeCall(address token, address recipient, uint256 amount) external returns (bool) {\n        bytes memory data = abi.encodeCall(IERC20.transfer, (recipient, amount));\n        (bool success, bytes memory returnData) = token.call(data);\n        emit LowLevelCall(success, returnData);\n        return _parseBoolReturn(success, returnData);\n    }\n\n    /// @dev \u517c\u5bb9\u6807\u51c6\u548c\u975e\u6807\u51c6 ERC20\n    function _parseBoolReturn(bool success, bytes memory returnData) internal pure returns (bool) {\n        if (!success) return false;\n        if (returnData.length == 0) return true;  // \u975e\u6807\u51c6 ERC20\n        return abi.decode(returnData, (bool));\n    }\n}\n</code></pre>"},{"location":"web3/dapp/solidity_contract_call_part2_251223/#_4","title":"\u5b9e\u9a8c\u6b65\u9aa4","text":"<ol> <li>\u90e8\u7f72\u4e00\u4e2a ERC20 \u4ee3\u5e01\u5408\u7ea6\uff08\u5408\u7ea6\u53ef\u53c2\u8003\uff1aIERC20.sol\uff0cERC20.sol\uff09</li> <li>\u7ed9\u81ea\u5df1 mint \u4e00\u4e9b\u4ee3\u5e01</li> <li>\u5411 <code>TransferViaCall</code> \u5408\u7ea6\u8f6c\u4e00\u4e9b\u4ee3\u5e01</li> <li>\u8c03\u7528\u56db\u4e2a transfer \u51fd\u6570\uff0c\u89c2\u5bdf\u4e8b\u4ef6\u65e5\u5fd7\u4e2d\u7684 <code>returnData</code></li> </ol>"},{"location":"web3/dapp/solidity_contract_call_part2_251223/#_5","title":"\u89c2\u5bdf\u7ed3\u679c","text":"<ul> <li>\u6807\u51c6 ERC20\uff1a<code>returnData</code> \u662f 32 \u5b57\u8282\uff0c\u89e3\u7801\u540e\u4e3a <code>true</code></li> <li>\u975e\u6807\u51c6 ERC20\uff1a<code>returnData</code> \u53ef\u80fd\u4e3a\u7a7a\uff08\u957f\u5ea6\u4e3a 0\uff09\uff0c\u4f46 <code>success = true</code></li> </ul> <p>\u8fd9\u5c31\u662f\u4e3a\u4ec0\u4e48 <code>_parseBoolReturn</code> \u8981\u5148\u68c0\u67e5\u957f\u5ea6\u2014\u2014\u76f4\u63a5 decode \u7a7a\u6570\u636e\u4f1a\u62a5\u9519\u3002</p>"},{"location":"web3/dapp/solidity_contract_call_part2_251223/#_6","title":"\u5c0f\u7ed3","text":"<p>\u672c\u7bc7\u6211\u4eec\u5b66\u4e60\u4e86\uff1a</p> <ol> <li><code>call</code> \u7684\u5b8c\u6574\u8bed\u6cd5\u548c\u5404\u53c2\u6570\u542b\u4e49</li> <li>calldata \u7684\u7ed3\u6784\uff1a\u9009\u62e9\u5668 + ABI \u7f16\u7801\u53c2\u6570</li> <li>\u4e09\u79cd\u6784\u9020 calldata \u7684\u65b9\u5f0f\uff0c\u63a8\u8350 <code>abi.encodeCall</code></li> <li>\u5982\u4f55\u6b63\u786e\u5904\u7406\u8fd4\u56de\u503c\u548c\u8c03\u7528\u5931\u8d25</li> <li>\u901a\u8fc7 <code>TransferViaCall</code> \u5b9e\u9a8c\u9a8c\u8bc1\u6240\u5b66</li> </ol> <p>\u4e0b\u4e00\u7bc7\uff0c\u6211\u4eec\u5b66\u4e60\u5982\u4f55\u521b\u5efa\u5408\u7ea6\uff1a<code>create</code> \u548c <code>create2</code> \u7684\u533a\u522b\uff0c\u4ee5\u53ca\u5982\u4f55\u9884\u6d4b\u5408\u7ea6\u5730\u5740\u3002</p> <p>\u7cfb\u5217\u5bfc\u822a</p> <ul> <li>\u7b2c\u4e00\u7bc7\uff1aSolidity \u5408\u7ea6\u95f4\u8c03\u7528\uff08\u4e00\uff09\uff1a\u56db\u79cd\u65b9\u5f0f\u8c03\u7528\u5df2\u90e8\u7f72\u5408\u7ea6</li> <li>\u7b2c\u4e8c\u7bc7\uff1aSolidity \u5408\u7ea6\u95f4\u8c03\u7528\uff08\u4e8c\uff09\uff1a\u5e95\u5c42\u8c03\u7528\u4e0e calldata \u8be6\u89e3\uff08\u672c\u7bc7\uff09</li> <li>\u7b2c\u4e09\u7bc7\uff1aSolidity \u5408\u7ea6\u95f4\u8c03\u7528\uff08\u4e09\uff09\uff1a\u521b\u5efa\u5408\u7ea6\u7684\u4e24\u79cd\u65b9\u5f0f\uff1acreate \u4e0e create2</li> </ul>"},{"location":"web3/dapp/solidity_contract_call_part3_251227/","title":"Solidity \u5408\u7ea6\u95f4\u8c03\u7528\uff08\u4e09\uff09\uff1a\u521b\u5efa\u5408\u7ea6\u7684\u4e24\u79cd\u65b9\u5f0f\uff1acreate \u4e0e create2","text":"<p>\u524d\u4e24\u7bc7\u8bb2\u4e86\u5982\u4f55\u8c03\u7528\u5408\u7ea6\uff0c\u672c\u7bc7\u8bb2\u5982\u4f55\u5728\u5408\u7ea6\u4e2d\u521b\u5efa\u65b0\u5408\u7ea6\u3002</p>"},{"location":"web3/dapp/solidity_contract_call_part3_251227/#_1","title":"\u4e24\u79cd\u521b\u5efa\u65b9\u5f0f","text":"<p>EVM \u63d0\u4f9b\u4e24\u4e2a\u64cd\u4f5c\u7801\u6765\u521b\u5efa\u5408\u7ea6\uff1a</p> \u64cd\u4f5c\u7801 \u5730\u5740\u8ba1\u7b97\u65b9\u5f0f \u7279\u70b9 <code>CREATE</code> \u90e8\u7f72\u8005\u5730\u5740 + nonce \u5730\u5740\u4e0d\u53ef\u9884\u6d4b <code>CREATE2</code> \u90e8\u7f72\u8005\u5730\u5740 + salt + initcode \u5730\u5740\u53ef\u9884\u6d4b"},{"location":"web3/dapp/solidity_contract_call_part3_251227/#create","title":"CREATE\uff1a\u57fa\u7840\u521b\u5efa","text":"<p>\u8bed\u6cd5\u5f88\u7b80\u5355\uff0c\u5c31\u662f <code>new</code> \u4e00\u4e2a\u5408\u7ea6\uff1a</p> <pre><code>Contract x = new Contract{value: _value}(params);\n</code></pre> <ul> <li><code>Contract</code>\uff1a\u8981\u521b\u5efa\u7684\u5408\u7ea6\u540d</li> <li><code>x</code>\uff1a\u8fd4\u56de\u7684\u5408\u7ea6\u5b9e\u4f8b\uff08\u672c\u8d28\u662f\u5730\u5740\uff09</li> <li><code>value</code>\uff1a\u9644\u5e26\u7684 ETH\uff08\u6784\u9020\u51fd\u6570\u9700\u8981\u662f <code>payable</code>\uff09</li> <li><code>params</code>\uff1a\u6784\u9020\u51fd\u6570\u53c2\u6570</li> </ul>"},{"location":"web3/dapp/solidity_contract_call_part3_251227/#pair","title":"\u793a\u4f8b\uff1a\u7b80\u6613 Pair \u5de5\u5382","text":"<pre><code>// Pair.sol\ncontract Pair {\n    address public factory;\n    address public token0;\n    address public token1;\n\n    constructor() {\n        factory = msg.sender;\n    }\n\n    function initialize(address _token0, address _token1) external {\n        require(msg.sender == factory, \"FORBIDDEN\");\n        token0 = _token0;\n        token1 = _token1;\n    }\n}\n</code></pre> <pre><code>// PairFactory.sol\nimport \"./Pair.sol\";\n\ncontract PairFactory {\n    mapping(address =&gt; mapping(address =&gt; address)) public getPair;\n\n    function createPair(address tokenA, address tokenB) external returns (address) {\n        Pair pair = new Pair();           // \u521b\u5efa\u65b0\u5408\u7ea6\n        pair.initialize(tokenA, tokenB);  // \u521d\u59cb\u5316\n\n        getPair[tokenA][tokenB] = address(pair);\n        getPair[tokenB][tokenA] = address(pair);\n\n        return address(pair);\n    }\n}\n</code></pre> <p>\u95ee\u9898\uff1a\u6bcf\u6b21\u8c03\u7528 <code>createPair</code>\uff0c\u5f97\u5230\u7684\u5730\u5740\u90fd\u4e0d\u540c\uff0c\u65e0\u6cd5\u63d0\u524d\u9884\u6d4b\u3002</p>"},{"location":"web3/dapp/solidity_contract_call_part3_251227/#create2","title":"CREATE2\uff1a\u786e\u5b9a\u6027\u521b\u5efa","text":"<p>CREATE2 \u7684\u5730\u5740\u7531\u56db\u4e2a\u56e0\u7d20\u51b3\u5b9a\uff1a</p> <pre><code>\u5730\u5740 = keccak256(0xff ++ deployer ++ salt ++ keccak256(initcode))[12:]\n</code></pre> \u56e0\u7d20 \u8bf4\u660e <code>0xff</code> \u56fa\u5b9a\u524d\u7f00 <code>deployer</code> \u90e8\u7f72\u8005\u5730\u5740\uff08\u901a\u5e38\u662f\u5de5\u5382\u5408\u7ea6\uff09 <code>salt</code> 32 \u5b57\u8282\u7684\u76d0\u503c\uff0c\u7531\u5f00\u53d1\u8005\u6307\u5b9a <code>initcode</code> \u521b\u5efa\u4ee3\u7801 + \u6784\u9020\u51fd\u6570\u53c2\u6570 <p>\u53ea\u8981\u8fd9\u56db\u4e2a\u56e0\u7d20\u76f8\u540c\uff0c\u5730\u5740\u5c31\u76f8\u540c\u2014\u2014\u53ef\u4ee5\u5728\u90e8\u7f72\u524d\u9884\u6d4b\u5730\u5740\u3002</p> <p>\u8bed\u6cd5</p> <pre><code>Contract x = new Contract{salt: salt}(params);\n</code></pre> <p>\u53ea\u9700\u52a0\u4e00\u4e2a <code>salt</code> \u53c2\u6570\u3002</p>"},{"location":"web3/dapp/solidity_contract_call_part3_251227/#pair_1","title":"\u793a\u4f8b\uff1a\u53ef\u9884\u6d4b\u5730\u5740\u7684 Pair \u5de5\u5382","text":"<pre><code>contract PairFactory {\n    mapping(address =&gt; mapping(address =&gt; address)) public getPair;\n\n    function createPair(address tokenA, address tokenB) external returns (address) {\n        // \u6392\u5e8f\uff0c\u786e\u4fdd\u540c\u4e00\u5bf9 token \u7684 salt \u4e00\u81f4\n        (address token0, address token1) = tokenA &lt; tokenB \n            ? (tokenA, tokenB) \n            : (tokenB, tokenA);\n\n        // \u7528 token \u5730\u5740\u751f\u6210 salt\n        bytes32 salt = keccak256(abi.encodePacked(token0, token1));\n\n        // \u4f7f\u7528 CREATE2 \u90e8\u7f72\n        Pair pair = new Pair{salt: salt}();\n        pair.initialize(tokenA, tokenB);\n\n        getPair[tokenA][tokenB] = address(pair);\n        getPair[tokenB][tokenA] = address(pair);\n\n        return address(pair);\n    }\n}\n</code></pre>"},{"location":"web3/dapp/solidity_contract_call_part3_251227/#_2","title":"\u9884\u6d4b\u5730\u5740","text":"<p>\u65e0\u9700\u8c03\u7528 <code>createPair</code>\uff0c\u5c31\u80fd\u8ba1\u7b97\u51fa Pair \u7684\u5730\u5740\uff1a</p> <pre><code>function predictPair(address tokenA, address tokenB) external view returns (address) {\n    (address token0, address token1) = tokenA &lt; tokenB \n        ? (tokenA, tokenB) \n        : (tokenB, tokenA);\n\n    bytes32 salt = keccak256(abi.encodePacked(token0, token1));\n\n    // initcode = \u521b\u5efa\u4ee3\u7801 + \u6784\u9020\u51fd\u6570\u53c2\u6570\n    bytes32 initCodeHash = keccak256(\n        abi.encodePacked(type(Pair).creationCode)  // Pair \u65e0\u6784\u9020\u53c2\u6570\n    );\n\n    // CREATE2 \u5730\u5740\u516c\u5f0f\n    return address(uint160(uint256(keccak256(abi.encodePacked(\n        bytes1(0xff),\n        address(this),  // deployer\n        salt,\n        initCodeHash\n    )))));\n}\n</code></pre> <p>\u4e3a\u4ec0\u4e48\u5730\u5740\u8f6c\u6362\u8981\u5199\u6210 <code>address(uint160(uint256(...)))</code>\uff1f</p> <p>CREATE2 \u8ba1\u7b97\u51fa\u7684\u662f 32 \u5b57\u8282\u54c8\u5e0c\uff08<code>bytes32</code>\uff09\uff0c\u4f46\u4ee5\u592a\u574a\u5730\u5740\u53ea\u6709 20 \u5b57\u8282\uff08160 bit\uff09\u3002\u5408\u7ea6\u5730\u5740\u53d6\u7684\u662f\u54c8\u5e0c\u7684\u4f4e 20 \u5b57\u8282\u3002</p> <p>Solidity \u4e0d\u5141\u8bb8\u76f4\u63a5\u628a <code>bytes32</code> \u5f3a\u8f6c\u6210 <code>address</code>\u2014\u2014\u8fd9\u6837\u505a\u4f1a\u6709\u6b67\u4e49\uff1a\u53d6\u9ad8 20 \u5b57\u8282\u8fd8\u662f\u4f4e 20 \u5b57\u8282\uff1f\u6240\u4ee5\u5fc5\u987b\u663e\u5f0f\u544a\u8bc9\u7f16\u8bd1\u5668\uff1a</p> <pre><code>bytes32 h = keccak256(...);\n\nuint256(h)              // \u7b2c\u4e00\u6b65\uff1a\u628a bytes32 \u5f53\u4f5c 256 \u4f4d\u6574\u6570\nuint160(uint256(h))     // \u7b2c\u4e8c\u6b65\uff1a\u622a\u65ad\u4e3a 160 \u4f4d\uff08\u81ea\u52a8\u4fdd\u7559\u4f4e 160 bit\uff09\naddress(uint160(...))   // \u7b2c\u4e09\u6b65\uff1a\u628a 160 \u4f4d\u6574\u6570\u89e3\u91ca\u4e3a address\n</code></pre> <p>\u8fd9\u662f Solidity \u4e2d\"\u622a\u65ad\u53d6\u4f4e\u4f4d\"\u7684\u6807\u51c6\u5199\u6cd5\uff0c\u5728\u5904\u7406\u54c8\u5e0c\u7ed3\u679c\u65f6\u7ecf\u5e38\u7528\u5230\u3002</p>"},{"location":"web3/dapp/solidity_contract_call_part3_251227/#initcode","title":"\u7406\u89e3 initcode","text":"<p>\u4e24\u4e2a\u5bb9\u6613\u6df7\u6dc6\u7684\u6982\u5ff5\uff1a</p> \u6982\u5ff5 \u8bf4\u660e \u83b7\u53d6\u65b9\u5f0f initcode \u90e8\u7f72\u65f6\u6267\u884c\u7684\u4ee3\u7801\uff0c\u5305\u542b\u6784\u9020\u51fd\u6570 <code>type(C).creationCode</code> runtime code \u90e8\u7f72\u540e\u5b58\u50a8\u5728\u94fe\u4e0a\u7684\u4ee3\u7801 <code>type(C).runtimeCode</code> <p>initcode \u6267\u884c\u5b8c\u6bd5\u540e\uff0c\u8fd4\u56de runtime code\uff0c\u540e\u8005\u624d\u662f\u7528\u6237\u5b9e\u9645\u8c03\u7528\u7684\u4ee3\u7801\u3002</p> <p>CREATE2 \u5730\u5740\u8ba1\u7b97\u7528\u7684\u662f initcode \u7684\u54c8\u5e0c\u3002</p> <p>\u5982\u679c\u5408\u7ea6\u6709\u6784\u9020\u51fd\u6570\u53c2\u6570\uff1a</p> <pre><code>bytes memory initcode = abi.encodePacked(\n    type(Pair).creationCode,\n    abi.encode(constructorArg1, constructorArg2)\n);\nbytes32 initCodeHash = keccak256(initcode);\n</code></pre>"},{"location":"web3/dapp/solidity_contract_call_part3_251227/#create2_1","title":"CREATE2 \u7684\u5e94\u7528\u573a\u666f","text":"<p>1.\u53cd\u4e8b\u5b9e\u90e8\u7f72</p> <p>\u5148\u8ba1\u7b97\u5730\u5740 \u2192 \u7528\u6237\u5411\u8be5\u5730\u5740\u8f6c\u8d26 \u2192 \u4e4b\u540e\u518d\u90e8\u7f72\u5408\u7ea6\u3002</p> <p>\u8d26\u6237\u62bd\u8c61\u94b1\u5305\u5e38\u7528\u8fd9\u79cd\u6a21\u5f0f\uff1a\u7528\u6237\u5148\u62ff\u5230\u94b1\u5305\u5730\u5740\u6536\u6b3e\uff0c\u771f\u6b63\u9700\u8981\u65f6\u624d\u90e8\u7f72\u94b1\u5305\u5408\u7ea6\u3002</p> <p>2.\u8de8\u94fe\u786e\u5b9a\u6027\u90e8\u7f72</p> <p>\u5728\u591a\u6761\u94fe\u4e0a\u7528\u76f8\u540c\u53c2\u6570\u90e8\u7f72\uff0c\u5f97\u5230\u76f8\u540c\u5730\u5740\u3002\u8de8\u94fe\u534f\u8bae\u9700\u8981\u8fd9\u4e2a\u7279\u6027\u3002</p> <p>3.\u5408\u7ea6\u91cd\u5efa</p> <p>\u9500\u6bc1\u5408\u7ea6\u540e\uff0c\u7528\u76f8\u540c\u53c2\u6570\u53ef\u4ee5\u5728\u540c\u4e00\u5730\u5740\u91cd\u65b0\u90e8\u7f72\uff08\u9700\u8981 <code>selfdestruct</code>\uff09\u3002</p>"},{"location":"web3/dapp/solidity_contract_call_part3_251227/#_3","title":"\u6ce8\u610f\u4e8b\u9879","text":"<p>1. \u540c\u5730\u5740\u53ea\u80fd\u90e8\u7f72\u4e00\u6b21</p> <p>\u540c\u6837\u7684 <code>deployer + salt + initcode</code> \u7ec4\u5408\uff0c\u7b2c\u4e8c\u6b21\u90e8\u7f72\u4f1a\u5931\u8d25\u3002</p> <p>2. value \u4e0d\u5f71\u54cd\u5730\u5740</p> <p><code>new Pair{salt: salt, value: 1 ether}()</code> \u4e2d\u7684 <code>value</code> \u4e0d\u53c2\u4e0e\u5730\u5740\u8ba1\u7b97\u3002</p> <p>3. deployer \u662f\u5de5\u5382\u5408\u7ea6</p> <p>\u5728 <code>PairFactory.createPair()</code> \u4e2d\u8c03\u7528 <code>new Pair{salt: ...}()</code>\uff0cdeployer \u662f <code>PairFactory</code> \u7684\u5730\u5740\uff0c\u800c\u4e0d\u662f\u8c03\u7528 <code>createPair</code> \u7684\u7528\u6237\u3002</p> <p>4. \u4efb\u4f55\u56e0\u7d20\u53d8\u5316\u90fd\u4f1a\u6539\u53d8\u5730\u5740</p> <p>\u5de5\u5382\u5730\u5740\u3001salt\u3001\u5408\u7ea6\u4ee3\u7801\u3001\u6784\u9020\u53c2\u6570\u2014\u2014\u4efb\u4f55\u4e00\u4e2a\u53d8\u5316\uff0c\u5730\u5740\u90fd\u4f1a\u4e0d\u540c\u3002</p>"},{"location":"web3/dapp/solidity_contract_call_part3_251227/#_4","title":"\u5e95\u5c42\u8c03\u7528\u65b9\u5f0f","text":"<p>\u5982\u679c\u9700\u8981\u90e8\u7f72\u4efb\u610f\u5b57\u8282\u7801\uff0c\u53ef\u4ee5\u7528 assembly\uff1a</p> <pre><code>// CREATE\nfunction rawCreate(bytes memory bytecode) external returns (address addr) {\n    assembly {\n        addr := create(0, add(bytecode, 0x20), mload(bytecode))\n        if iszero(addr) { revert(0, 0) }\n    }\n}\n\n// CREATE2\nfunction rawCreate2(bytes memory bytecode, bytes32 salt) external returns (address addr) {\n    assembly {\n        addr := create2(0, add(bytecode, 0x20), mload(bytecode), salt)\n        if iszero(addr) { revert(0, 0) }\n    }\n}\n</code></pre> <p>\u53c2\u6570\u542b\u4e49\uff1a<code>create(value, offset, size)</code> / <code>create2(value, offset, size, salt)</code></p>"},{"location":"web3/dapp/solidity_contract_call_part3_251227/#selfdestruct","title":"selfdestruct \u7684\u53d8\u5316","text":"<p>2024 \u5e74\u574e\u6606\u5347\u7ea7\uff08EIP-6780\uff09\u9650\u5236\u4e86 <code>selfdestruct</code>\uff1a</p> <ul> <li>\u540c\u4e00\u7b14\u4ea4\u6613\u5185\uff1a\u4ecd\u53ef\u5220\u9664\u4ee3\u7801\u548c\u5b58\u50a8</li> <li>\u4e4b\u540e\u7684\u4ea4\u6613\uff1a\u53ea\u8f6c\u79fb ETH\uff0c\u4ee3\u7801\u548c\u5b58\u50a8\u4fdd\u7559</li> </ul> <p>\u8fd9\u610f\u5473\u7740\"\u9500\u6bc1\u540e\u91cd\u5efa\"\u7684\u6a21\u5f0f\u57fa\u672c\u4e0d\u518d\u53ef\u884c\u3002</p>"},{"location":"web3/dapp/solidity_contract_call_part3_251227/#_5","title":"\u5c0f\u7ed3","text":"<p>\u672c\u7bc7\u6211\u4eec\u5b66\u4e60\u4e86\uff1a</p> <ol> <li><code>CREATE</code> \u548c <code>CREATE2</code> \u7684\u533a\u522b</li> <li>CREATE2 \u5730\u5740\u7684\u8ba1\u7b97\u516c\u5f0f</li> <li>\u5982\u4f55\u9884\u6d4b\u5408\u7ea6\u5730\u5740\uff08\u4ee5\u53ca\u4e3a\u4ec0\u4e48\u5730\u5740\u8f6c\u6362\u8981\u5199\u6210 <code>address(uint160(uint256(...)))</code>\uff09</li> </ol> <p>\u81f3\u6b64\uff0c\u5408\u7ea6\u95f4\u8c03\u7528\u7cfb\u5217\u5b8c\u7ed3\u3002\u4f60\u5df2\u7ecf\u638c\u63e1\u4e86\uff1a</p> <ul> <li>\u5982\u4f55\u8c03\u7528\u5176\u4ed6\u5408\u7ea6\uff08\u56db\u79cd\u65b9\u5f0f\uff09</li> <li>\u5e95\u5c42 call \u7684\u7528\u6cd5\u548c calldata \u6784\u9020</li> <li>\u5982\u4f55\u5728\u5408\u7ea6\u4e2d\u521b\u5efa\u65b0\u5408\u7ea6</li> </ul> <p>\u7cfb\u5217\u5bfc\u822a</p> <ul> <li>\u7b2c\u4e00\u7bc7\uff1aSolidity \u5408\u7ea6\u95f4\u8c03\u7528\uff08\u4e00\uff09\uff1a\u56db\u79cd\u65b9\u5f0f\u8c03\u7528\u5df2\u90e8\u7f72\u5408\u7ea6</li> <li>\u7b2c\u4e8c\u7bc7\uff1aSolidity \u5408\u7ea6\u95f4\u8c03\u7528\uff08\u4e8c\uff09\uff1a\u5e95\u5c42\u8c03\u7528\u4e0e calldata \u8be6\u89e3</li> <li>\u7b2c\u4e09\u7bc7\uff1aSolidity \u5408\u7ea6\u95f4\u8c03\u7528\uff08\u4e09\uff09\uff1a\u521b\u5efa\u5408\u7ea6\u7684\u4e24\u79cd\u65b9\u5f0f\uff1acreate \u4e0e create2\uff08\u672c\u7bc7\uff09</li> </ul>"},{"location":"web3/dapp/solidity_proxy_upgrade_series_part1_251229/","title":"Solidity \u4ee3\u7406\u5408\u7ea6\u4e0e\u53ef\u5347\u7ea7\u5408\u7ea6\u7cfb\u5217\uff08\u4e00\uff09\uff1a\u4e3a\u4ec0\u4e48\u9700\u8981\u53ef\u5347\u7ea7\uff1f","text":"<p>\u672c\u7cfb\u5217\u5171\u4e24\u7bc7\u6587\u7ae0\uff0c\u5c06\u5e26\u4f60\u4ece\u96f6\u5230\u4e00\u7406\u89e3 Solidity \u4ee3\u7406\u5408\u7ea6\u4e0e\u53ef\u5347\u7ea7\u5408\u7ea6\u7684\u6838\u5fc3\u539f\u7406\u3002</p>"},{"location":"web3/dapp/solidity_proxy_upgrade_series_part1_251229/#_1","title":"\u5f15\u8a00\uff1a\u4e0d\u53ef\u53d8\u6027\u7684\u4e24\u96be","text":"<p>\u4ee5\u592a\u574a\u667a\u80fd\u5408\u7ea6\u6709\u4e00\u4e2a\u6838\u5fc3\u7279\u6027\uff1a\u4e0d\u53ef\u53d8\u6027\uff08Immutability\uff09\u3002\u4e00\u65e6\u90e8\u7f72\uff0c\u5408\u7ea6\u7684\u5b57\u8282\u7801\u5c31\u65e0\u6cd5\u4fee\u6539\u3002</p> <p>\u8fd9\u662f\u4e00\u628a\u53cc\u5203\u5251\uff1a</p> <ul> <li>\u4f18\u70b9\uff1a\u7528\u6237\u53ef\u4ee5\u4fe1\u4efb\u5408\u7ea6\u903b\u8f91\u4e0d\u4f1a\u88ab\u7be1\u6539\uff0c\u8fd9\u662f\u53bb\u4e2d\u5fc3\u5316\u548c\u5b89\u5168\u6027\u7684\u57fa\u77f3</li> <li>\u7f3a\u70b9\uff1a\u5982\u679c\u5408\u7ea6\u5b58\u5728 bug \u6216\u9700\u8981\u65b0\u529f\u80fd\uff0c\u5f00\u53d1\u8005\u675f\u624b\u65e0\u7b56</li> </ul> <p>\u60f3\u8c61\u4e00\u4e0b\uff1a\u4f60\u7684 DeFi \u534f\u8bae\u4e0a\u7ebf\u540e\u53d1\u73b0\u4e86\u4e00\u4e2a\u4e25\u91cd\u6f0f\u6d1e\uff0c\u4f46\u4f60\u65e0\u6cd5\u4fee\u590d\u5b83\u2014\u2014\u7528\u6237\u8d44\u91d1\u9762\u4e34\u98ce\u9669\uff0c\u800c\u4f60\u53ea\u80fd\u773c\u7741\u7741\u770b\u7740\u3002</p> <p>\u8fd9\u5c31\u662f\u4e3a\u4ec0\u4e48\u793e\u533a\u53d1\u660e\u4e86\u4ee3\u7406\u5408\u7ea6\uff08Proxy Contract\uff09\u548c\u53ef\u5347\u7ea7\u5408\u7ea6\uff08Upgradeable Contract\uff09\u6a21\u5f0f\u3002</p>"},{"location":"web3/dapp/solidity_proxy_upgrade_series_part1_251229/#_2","title":"\u6838\u5fc3\u601d\u8def\uff1a\u6570\u636e\u4e0e\u903b\u8f91\u5206\u79bb","text":"<p>\u65e2\u7136\u5b57\u8282\u7801\u4e0d\u53ef\u53d8\uff0c\u90a3\u6211\u4eec\u6362\u4e2a\u601d\u8def\uff1a\u628a\u6570\u636e\u548c\u903b\u8f91\u5206\u5f00\u5b58\u50a8\u3002</p> <pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502        Proxy        \u2502                   \u2502    Implementation   \u2502\n\u2502      (\u4ee3\u7406\u5408\u7ea6)      \u2502                    \u2502      (\u903b\u8f91\u5408\u7ea6)      \u2502\n\u2502                     \u2502   delegatecall    \u2502                     \u2502\n\u2502  - \u5b58\u50a8\u72b6\u6001\u53d8\u91cf       \u2502 \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba  \u2502  - \u5b58\u50a8\u4e1a\u52a1\u903b\u8f91        \u2502\n\u2502  - \u5730\u5740\u4e0d\u53d8          \u2502                   \u2502  - \u53ef\u88ab\u66ff\u6362           \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre> <p>\u7528\u6237\u59cb\u7ec8\u4e0e\u4ee3\u7406\u5408\u7ea6\u4ea4\u4e92\uff0c\u4ee3\u7406\u5408\u7ea6\u8d1f\u8d23\uff1a</p> <p>1.\u4fdd\u5b58\u6240\u6709\u72b6\u6001\u6570\u636e</p> <p>2.\u5c06\u51fd\u6570\u8c03\u7528\u8f6c\u53d1\u7ed9\u903b\u8f91\u5408\u7ea6\u6267\u884c</p> <p>\u5f53\u9700\u8981\u5347\u7ea7\u65f6\uff0c\u53ea\u9700\u90e8\u7f72\u65b0\u7684\u903b\u8f91\u5408\u7ea6\uff0c\u7136\u540e\u66f4\u65b0\u4ee3\u7406\u5408\u7ea6\u4e2d\u4fdd\u5b58\u7684\u903b\u8f91\u5408\u7ea6\u5730\u5740\u5373\u53ef\u3002\u7528\u6237\u65e0\u9700\u8fc1\u79fb\uff0c\u5730\u5740\u4e0d\u53d8\uff0c\u6570\u636e\u4fdd\u7559\u3002</p>"},{"location":"web3/dapp/solidity_proxy_upgrade_series_part1_251229/#delegatecall","title":"delegatecall\uff1a\u4ee3\u7406\u6a21\u5f0f\u7684\u57fa\u77f3","text":"<p>\u8981\u7406\u89e3\u4ee3\u7406\u5408\u7ea6\uff0c\u5fc5\u987b\u5148\u7406\u89e3 delegatecall\u3002</p> <p>delegatecall \u4e0e call \u7c7b\u4f3c\uff0c\u662f Solidity \u4e2d\u5730\u5740\u7c7b\u578b\u7684\u4f4e\u7ea7\u6210\u5458\u51fd\u6570\uff0cdelegate \u662f\u59d4\u6258/\u4ee3\u8868\u7684\u610f\u601d\u3002</p> <p>delegatecall \u7684\u672c\u8d28\uff1a\u501f\u7528\u76ee\u6807\u5408\u7ea6\u7684\u4ee3\u7801\uff0c\u5728\u81ea\u5df1\u7684\u73af\u5883\u4e2d\u6267\u884c\u3002</p> <p>\u60f3\u8c61\u4e00\u4e0b\uff1a\u4f60\u8bf7\u4e86\u4e00\u4f4d\u53a8\u5e08\uff08\u903b\u8f91\u5408\u7ea6\uff09\u6765\u4f60\u5bb6\uff08\u4ee3\u7406\u5408\u7ea6\uff09\u505a\u996d\u3002\u53a8\u5e08\u7528\u7684\u662f\u4f60\u5bb6\u7684\u53a8\u623f\u3001\u4f60\u5bb6\u7684\u98df\u6750\u3001\u4f60\u5bb6\u7684\u9910\u5177\u3002\u505a\u5b8c\u996d\u540e\uff0c\u98df\u7269\u7559\u5728\u4f60\u5bb6\uff0c\u53a8\u5e08\u79bb\u5f00\u3002</p> <p>\u57fa\u672c\u5f62\u5f0f\uff1a</p> <pre><code>(bool success, bytes memory returnData) = implementation.delegatecall(calldata)\n</code></pre> <p>\u8fd9\u884c\u4ee3\u7801\u505a\u4e86\u4ec0\u4e48\uff1f</p> <ol> <li>\u53d6 <code>implementation</code> \u5730\u5740\u4e0a\u7684\u4ee3\u7801\uff08runtime bytecode\uff09</li> <li>\u7528\u4f60\u63d0\u4f9b\u7684 <code>calldata</code> \u4f5c\u4e3a\u8f93\u5165</li> <li>\u5728\u5f53\u524d\u5408\u7ea6\u7684\u4e0a\u4e0b\u6587\u4e2d\u6267\u884c\u90a3\u6bb5\u4ee3\u7801</li> <li>\u8fd4\u56de\u6267\u884c\u662f\u5426\u6210\u529f <code>success</code> \u4e0e\u8fd4\u56de\u6570\u636e <code>returnData</code></li> </ol> <p>\u300c\u5f53\u524d\u5408\u7ea6\u7684\u4e0a\u4e0b\u6587\u300d\u5177\u4f53\u6307\u4ec0\u4e48\uff1f</p> <ul> <li>\u5199\u5165/\u8bfb\u53d6\u7684 <code>storage</code> \u662f\u5f53\u524d\u5408\u7ea6\u7684 <code>storage</code></li> <li><code>address(this)</code> \u662f\u5f53\u524d\u5408\u7ea6\u5730\u5740</li> <li><code>balance</code> \u4e5f\u662f\u5f53\u524d\u5408\u7ea6\u7684\u4f59\u989d</li> <li>\u4e8b\u4ef6 <code>emit</code> \u7684\u53d1\u51fa\u8005\u5730\u5740\uff08log \u7684 address\uff09\u4e5f\u662f\u5f53\u524d\u5408\u7ea6</li> </ul>"},{"location":"web3/dapp/solidity_proxy_upgrade_series_part1_251229/#call-vs-delegatecall","title":"call vs delegatecall \u5bf9\u6bd4","text":"call delegatecall \u4ee3\u7801\u6267\u884c\u4f4d\u7f6e \u88ab\u8c03\u7528\u5408\u7ea6 \u8c03\u7528\u65b9\uff08\u5373\u5f53\u524d\u5408\u7ea6\uff09 \u5b58\u50a8\u4fee\u6539\u4f4d\u7f6e \u88ab\u8c03\u7528\u5408\u7ea6\u7684 storage \u8c03\u7528\u65b9\uff08\u5373\u5f53\u524d\u5408\u7ea6\uff09\u7684 storage msg.sender \u8c03\u7528\u65b9\uff08\u5373\u5f53\u524d\u5408\u7ea6\uff09\u5730\u5740 \u539f\u59cb\u5916\u90e8\u8c03\u7528\u8005 msg.value \u4f1a\u628a value \u8f6c\u7ed9\u76ee\u6807\uff08\u5982\u679c\u8bbe\u7f6e {value: ...}\uff09 \u4e0d\u4f1a\u628a ETH \u8f6c\u5230\u5b9e\u73b0\u5408\u7ea6\uff1bvalue \u4ecd\u5728\u5f53\u524d\u5408\u7ea6\uff0c\u4f46\u5b9e\u73b0\u4ee3\u7801\u80fd\"\u770b\u5230\"\u8fd9\u7b14 msg.value address(this) \u88ab\u8c03\u7528\u5408\u7ea6\u5730\u5740 \u8c03\u7528\u65b9\uff08\u5373\u5f53\u524d\u5408\u7ea6\uff09\u5730\u5740 \u4e8b\u4ef6 emitter \u5730\u5740 \u88ab\u8c03\u7528\u5408\u7ea6\u5730\u5740 \u8c03\u7528\u65b9\uff08\u5373\u5f53\u524d\u5408\u7ea6\uff09\u5730\u5740"},{"location":"web3/dapp/solidity_proxy_upgrade_series_part1_251229/#call-delegatecall","title":"\u52a8\u624b\u5b9e\u9a8c\uff1a\u9a8c\u8bc1 call \u4e0e delegatecall \u7684\u533a\u522b","text":"<p>\u4e0b\u9762\u7684\u5b9e\u9a8c\u5c06\u9a8c\u8bc1\uff1a</p> <ul> <li>call\uff1a\u4fee\u6539\u7684\u662f\u88ab\u8c03\u7528\u5408\u7ea6\uff08Logic\uff09\u7684\u5b58\u50a8\uff0c\u4e8b\u4ef6\u4ece Logic \u53d1\u51fa</li> <li>delegatecall\uff1a\u4fee\u6539\u7684\u662f\u8c03\u7528\u65b9\uff08Caller\uff09\u7684\u5b58\u50a8\uff0c\u4e8b\u4ef6\u4ece Caller \u53d1\u51fa</li> </ul> <p>Logic.sol - \u88ab\u8c03\u7528\u7684\u903b\u8f91\u5408\u7ea6\uff1a</p> <pre><code>// SPDX-License-Identifier: MIT\npragma solidity ^0.8.28;\n\ncontract Logic {\n    uint256 public value;\n\n    event ValueChanged(address indexed caller, uint256 indexed newValue);\n\n    function setValue(uint256 newValue) external returns (bool) {\n        value = newValue;\n        emit ValueChanged(msg.sender, value);\n        return true;\n    }\n}\n</code></pre> <p>Caller.sol - \u53d1\u8d77\u8c03\u7528\u7684\u5408\u7ea6\uff1a</p> <pre><code>// SPDX-License-Identifier: MIT\npragma solidity ^0.8.28;\n\nimport \"./Logic.sol\";\n\ncontract Caller {\n    uint256 public value;\n\n    event LowLevelCall(bool success, bytes returnData, bool parsedOk);\n\n    function callSetValue(address logic, uint256 _value) external {\n        (bool success, bytes memory returnData) = logic.call(\n            abi.encodeCall(Logic.setValue, (_value))\n        );\n        bool parsedOk = _parseBoolReturn(success, returnData);\n        emit LowLevelCall(success, returnData, parsedOk);\n        require(parsedOk, \"Call failed\");\n    }\n\n    function delegateSetValue(address logic, uint256 _value) external {\n        (bool success, bytes memory returnData) = logic.delegatecall(\n            abi.encodeCall(Logic.setValue, (_value))\n        );\n        bool parsedOk = _parseBoolReturn(success, returnData);\n        emit LowLevelCall(success, returnData, parsedOk);\n        require(parsedOk, \"Delegatecall failed\");\n    }\n\n    /// @dev \u517c\u5bb9\u4e24\u7c7b\u8fd4\u56de\uff1a\n    /// - \u65e0\u8fd4\u56de\u503c\uff1areturnData.length == 0\uff0c\u4f46 success == true\n    /// - \u8fd4\u56de bool\uff1areturnData \u7f16\u7801\u4e86 bool\uff0832 bytes\uff09\n    /// \u6ce8\u610f\uff1a\u5982\u679c\u76ee\u6807\u51fd\u6570\u8fd4\u56de\u7684\u662f\u5176\u4ed6\u7c7b\u578b\uff08\u4f8b\u5982 uint256\uff09\uff0c\u8fd9\u91cc\u4e0d\u9002\u7528\u3002\n    function _parseBoolReturn(bool success, bytes memory returnData) internal pure returns (bool) {\n        if (!success) return false;\n        // \u76ee\u6807\u51fd\u6570\u6ca1\u6709\u8fd4\u56de\u503c\u7684\u5e38\u89c1\u60c5\u51b5\uff1a\u6210\u529f\u65f6 returnData \u4e3a\u7a7a\n        if (returnData.length == 0) return true;\n        // \u5982\u679c\u786e\u5b9e\u8fd4\u56de\u4e86\u6570\u636e\uff0c\u4e14\u957f\u5ea6\u7b26\u5408 bool ABI \u7f16\u7801\uff0832 bytes\uff09\uff0c\u5c1d\u8bd5 decode\n        if (returnData.length == 32) {\n            return abi.decode(returnData, (bool));\n        }\n        // \u5176\u4ed6\u957f\u5ea6\uff1a\u65e0\u6cd5\u6309 bool \u89e3\u6790\uff0c\u4fdd\u5b88\u5904\u7406\u4e3a\u5931\u8d25\uff08\u4e5f\u53ef\u4ee5\u9009\u62e9\u76f4\u63a5 return true\uff09\n        return false;\n    }\n}\n</code></pre> <p>\u5b9e\u9a8c\u6b65\u9aa4\uff1a</p> <ol> <li>\u90e8\u7f72 Logic \u5408\u7ea6\uff0c\u8c03\u7528 setValue(123)\uff0c\u6b64\u65f6 Logic.value = 123</li> <li>\u90e8\u7f72 Caller \u5408\u7ea6</li> <li>\u8c03\u7528 Caller.callSetValue(Logic\u5730\u5740, 456)</li> <li>\u8c03\u7528 Caller.delegateSetValue(Logic\u5730\u5740, 789)</li> </ol> <p>\u9884\u671f\u7ed3\u679c\uff1a</p> \u64cd\u4f5c Logic.value Caller.value ValueChanged \u4e8b\u4ef6\u6765\u6e90 \u521d\u59cb 123 0 - callSetValue(456) 456 0 Logic \u5408\u7ea6 delegateSetValue(789) 456\uff08\u4e0d\u53d8\uff09 789 Caller \u5408\u7ea6 <p>\u4ee5\u4e0b\u662f\u67d0\u6b21\u5b9e\u9a8c\u7684\u90e8\u7f72\u4fe1\u606f\uff1a</p> <ul> <li>\u90e8\u7f72\u8005\u5730\u5740\uff1a0x1d477b7733Fe1347eE91e8D15f8c7f203E147AA0</li> <li>Logic \u5408\u7ea6\u5730\u5740\uff1a0x6e84C52c6fE239AB2288C07cA2E5b4bF09fBD894</li> <li>Caller \u5408\u7ea6\u5730\u5740\uff1a0xcCe7de7ae33b8C5721e5777f0237D273111F7F2a</li> </ul> <p>\u8c03\u7528 callSetValue \u540e\uff0cLogic.value \u53d8\u6210 456\uff0c\u4e8b\u4ef6\u4ece Logic \u5408\u7ea6\u53d1\u51fa\uff1a</p> <p></p> <p>\u6765\u6e90\uff1ahttps://sepolia.etherscan.io/address/0x6e84c52c6fe239ab2288c07ca2e5b4bf09fbd894#events</p> <p>\u8c03\u7528 delegateSetValue \u540e\uff0cLogic.value \u4e0d\u53d8\uff0c\u4f46 Caller.value \u53d8\u6210 789\uff0c\u4e8b\u4ef6\u4ece Caller \u5408\u7ea6\u53d1\u51fa\uff1a</p> <p></p> <p>\u6765\u6e90\uff1ahttps://sepolia.etherscan.io/address/0xcce7de7ae33b8c5721e5777f0237d273111f7f2a#events</p>"},{"location":"web3/dapp/solidity_proxy_upgrade_series_part1_251229/#bug","title":"\u5b58\u50a8\u69fd\u51b2\u7a81\uff1a\u4e00\u4e2a\u707e\u96be\u6027\u7684 bug","text":"<p>delegatecall \u6709\u4e00\u4e2a\u5173\u952e\u7ec6\u8282\uff1a\u5b83\u6309\u5b58\u50a8\u69fd\u4f4d\u7f6e\u64cd\u4f5c\uff0c\u800c\u975e\u53d8\u91cf\u540d\u79f0\u3002</p> <p>\u770b\u8fd9\u4e2a\u6709\u95ee\u9898\u7684\u4f8b\u5b50\uff1a</p> <pre><code>contract Called {\n    uint256 public number;  // slot 0\n\n    function increment() public {\n        number++;\n    }\n}\n\ncontract Caller {\n    address public implementation;  // slot 0  \u2190 \u5371\u9669\uff01\n    uint256 public myNumber;        // slot 1\n\n    function callIncrement() public {\n        implementation.delegatecall(\n            abi.encodeWithSignature(\"increment()\")\n        );\n    }\n}\n</code></pre> <p>\u95ee\u9898\u5728\u4e8e\uff1aCalled.number \u548c Caller.implementation \u90fd\u5728 slot 0\u3002</p> <p>\u5f53\u6267\u884c increment() \u65f6\uff0c\u5b83\u4f1a\u9012\u589e slot 0 \u7684\u503c\u2014\u2014\u4f46\u5728 Caller \u4e2d\uff0cslot 0 \u5b58\u50a8\u7684\u662f implementation \u5730\u5740\uff0c\u800c\u4e0d\u662f <code>myNumber</code>\uff01</p> <p>\u7ed3\u679c\uff1a\u903b\u8f91\u5408\u7ea6\u5730\u5740\u88ab\u610f\u5916\u4fee\u6539\uff0c\u4ee3\u7406\u5408\u7ea6\u53ef\u80fd\u5f7b\u5e95\u635f\u574f\u3002</p>"},{"location":"web3/dapp/solidity_proxy_upgrade_series_part1_251229/#_3","title":"\u5b58\u50a8\u69fd\u7684\u672c\u8d28","text":"<p>EVM \u7684\u5b58\u50a8\u662f\u4e00\u4e2a\u5de8\u5927\u7684 key-value \u6620\u5c04\uff1a</p> <ul> <li>key\uff1a0 \u5230 2\u00b2\u2075\u2076-1 \u7684\u6574\u6570\uff08\u5b58\u50a8\u69fd\u7f16\u53f7\uff09</li> <li>value\uff1a32 \u5b57\u8282\u7684\u6570\u636e</li> </ul> <p></p> <p>Solidity \u7f16\u8bd1\u5668\u9ed8\u8ba4\u4ece slot 0 \u5f00\u59cb\u5206\u914d\u53d8\u91cf\uff0c\u8fd9\u5c31\u662f\u51b2\u7a81\u7684\u6839\u6e90\u3002</p>"},{"location":"web3/dapp/solidity_proxy_upgrade_series_part1_251229/#eip-1967","title":"\u89e3\u51b3\u65b9\u6848\uff1aEIP-1967","text":"<p>\u6838\u5fc3\u601d\u60f3\uff1a\u628a\u4ee3\u7406\u5408\u7ea6\u7684\u5173\u952e\u53d8\u91cf\u653e\u5230\u300c\u4e0d\u53ef\u80fd\u51b2\u7a81\u300d\u7684\u4f4d\u7f6e\u3002</p> <p>2\u00b2\u2075\u2076 \u662f\u4e00\u4e2a\u5929\u6587\u6570\u5b57\uff0c\u5982\u679c\u6211\u4eec\u968f\u673a\u9009\u4e00\u4e2a\u69fd\u4f4d\uff0c\u5b9e\u73b0\u5408\u7ea6\u51e0\u4e4e\u4e0d\u53ef\u80fd\u78b0\u5de7\u7528\u5230\u540c\u4e00\u4e2a\u69fd\u3002</p> <p>EIP-1967 \u5b9a\u4e49\u4e86\u4e24\u4e2a\u7279\u6b8a\u69fd\u4f4d\uff1a</p> <pre><code>// \u903b\u8f91\u5408\u7ea6\u5730\u5740\u5b58\u50a8\u69fd\nbytes32 constant IMPLEMENTATION_SLOT = \n    bytes32(uint256(keccak256(\"eip1967.proxy.implementation\")) - 1);\n// = 0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc\n\n// \u7ba1\u7406\u5458\u5730\u5740\u5b58\u50a8\u69fd  \nbytes32 constant ADMIN_SLOT = \n    bytes32(uint256(keccak256(\"eip1967.proxy.admin\")) - 1);\n// = 0xb53127684a568b3173ae13b9f8a6016e243e63b6e8ee1178d6a717850b5d6103\n</code></pre> <p>\u4e3a\u4ec0\u4e48\u8981\u51cf 1\uff1f</p> <p><code>keccak256(\"...\") - 1</code> \u7684\u8bbe\u8ba1\u5f88\u5de7\u5999\uff1a</p> <ul> <li><code>keccak256</code> \u751f\u6210\u4f2a\u968f\u673a\u6570</li> <li>\u51cf 1 \u4f7f\u5f97\u7ed3\u679c\u6ca1\u6709\u5df2\u77e5\u7684\u54c8\u5e0c\u539f\u50cf</li> </ul> <p>\u8fd9\u610f\u5473\u7740\u6ca1\u6709\u4efb\u4f55\u5408\u7ea6\u80fd\u901a\u8fc7 Solidity \u7684\u6b63\u5e38\u8bed\u6cd5\u300c\u7b97\u51fa\u300d\u8fd9\u4e2a\u69fd\u4f4d\u2014\u2014\u9664\u975e\u6545\u610f\u786c\u7f16\u7801\u3002</p> <p>EIP-1967 \u53ea\u89c4\u5b9a\u4e86\u4e24\u4ef6\u4e8b\uff1a</p> <ol> <li>\u5173\u952e\u53d8\u91cf\u5b58\u5728\u54ea\u91cc</li> <li>\u53d8\u91cf\u53d8\u5316\u65f6\u53d1\u51fa\u4ec0\u4e48\u4e8b\u4ef6</li> </ol> <p>\u5b83\u4e0d\u89c4\u5b9a\uff1a\u8c01\u80fd\u4fee\u6539\u8fd9\u4e9b\u53d8\u91cf\u3001\u5982\u4f55\u5347\u7ea7\u5408\u7ea6\u3001\u5982\u4f55\u5904\u7406\u51fd\u6570\u9009\u62e9\u5668\u51b2\u7a81\u3002\u8fd9\u4e9b\u95ee\u9898\u7531\u5176\u4ed6\u6807\u51c6\u89e3\u51b3\uff08\u900f\u660e\u4ee3\u7406\u3001UUPS \u7b49\uff09\u3002</p> <p>Etherscan \u5982\u4f55\u8bc6\u522b\u4ee3\u7406\uff1f</p> <p>\u5f53 Etherscan \u68c0\u6d4b\u5230\u5408\u7ea6\u5728 EIP-1967 \u69fd\u4f4d\u5b58\u6709\u975e\u96f6\u503c\u65f6\uff0c\u5b83\u4f1a\uff1a</p> <ol> <li>\u6807\u8bb0\u8be5\u5408\u7ea6\u4e3a\u4ee3\u7406\u5408\u7ea6</li> <li>\u663e\u793a\u5b9e\u73b0\u5408\u7ea6\u5730\u5740</li> <li>\u63d0\u4f9b\u300cRead as Proxy\u300d\u548c\u300cWrite as Proxy\u300d\u9009\u9879</li> </ol> <p>\u8fd9\u5c31\u662f EIP-1967 \u5e26\u6765\u7684\u6807\u51c6\u5316\u597d\u5904\u2014\u2014\u5de5\u5177\u94fe\u53ef\u4ee5\u81ea\u52a8\u8bc6\u522b\u4ee3\u7406\u6a21\u5f0f\u3002</p>"},{"location":"web3/dapp/solidity_proxy_upgrade_series_part1_251229/#_4","title":"\u4e00\u4e2a\u6700\u7b80\u4ee3\u7406\u5408\u7ea6","text":"<p>\u7406\u89e3\u4e86\u539f\u7406\uff0c\u6211\u4eec\u6765\u770b\u4e00\u4e2a\u57fa\u7840\u5b9e\u73b0\uff1a</p> <p>SimpleProxy.sol\uff1a</p> <pre><code>// SPDX-License-Identifier: MIT\npragma solidity ^0.8.20;\n\ncontract SimpleProxy {\n    bytes32 private constant IMPLEMENTATION_SLOT = \n        0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc;\n\n    constructor(address _implementation) {\n        assembly {\n            sstore(IMPLEMENTATION_SLOT, _implementation)\n        }\n    }\n\n    fallback(bytes calldata data) external payable returns (bytes memory) {\n        address impl;\n        assembly {\n            impl := sload(IMPLEMENTATION_SLOT)\n        }\n\n        (bool success, bytes memory result) = impl.delegatecall(data);\n        require(success, \"Delegatecall failed\");\n        return result;\n    }\n}\n</code></pre> <p>User.sol - \u6a21\u62df\u7528\u6237\u8c03\u7528\u6d41\u7a0b\u6838\u5fc3\u4ee3\u7801\uff1a</p> <pre><code>// SPDX-License-Identifier: MIT\npragma solidity ^0.8.28;\n\n/// @notice \u7528 Logic \u7684 ABI \u53bb\u8c03\u7528 Proxy\ninterface ILogic {\n    function setValue(uint256 newValue) external returns (bool);\n    function value() external view returns (uint256);\n}\n\n/// @notice \u6a21\u62df\u5b8c\u6574\u7684\u4ee3\u7406\u8c03\u7528\u6d41\u7a0b\ncontract User {\n    /// @notice \u6f14\u793a\uff1a\u7528\u6237 -&gt; Proxy -&gt; delegatecall -&gt; Logic \u4ee3\u7801 -&gt; \u5199 Proxy \u5b58\u50a8\n    function demo(address proxy, address logic, uint256 newValue) \n        public\n        returns (uint256 proxyValue, uint256 logicValue, bool success)\n    {\n        // \u901a\u8fc7 Proxy \u8c03\u7528 setValue\uff08\u4f1a\u89e6\u53d1 fallback -&gt; delegatecall\uff09\n        success = ILogic(proxy).setValue(newValue);\n\n        // \u8bfb\u53d6 Proxy \u7684 value\uff08delegatecall \u5199\u5165\u7684\u662f Proxy \u7684\u5b58\u50a8\uff09\n        proxyValue = ILogic(proxy).value();\n\n        // \u5bf9\u6bd4 Logic \u81ea\u8eab\u7684 value\uff08\u5e94\u8be5\u4e0d\u53d8\uff09\n        logicValue = ILogic(logic).value();\n    }\n}\n</code></pre> <p>\u5b8c\u6574\u4ee3\u7801\u5730\u5740\uff1a\u6700\u7b80\u4ee3\u7406\u5408\u7ea6\u6f14\u793a\u7a0b\u5e8f</p> <p>\u5de5\u4f5c\u6d41\u7a0b\uff1a</p> <ol> <li>\u7528\u6237\u8c03\u7528\u4ee3\u7406\u5408\u7ea6\u7684\u67d0\u4e2a\u51fd\u6570\uff08\u5982 <code>setValue()</code>\uff09</li> <li>\u4ee3\u7406\u5408\u7ea6\u6ca1\u6709\u8fd9\u4e2a\u51fd\u6570\uff0c\u89e6\u53d1 <code>fallback</code></li> <li><code>fallback</code> \u4ece EIP-1967 \u5b58\u50a8\u69fd\u8bfb\u53d6\u903b\u8f91\u5408\u7ea6\u5730\u5740</li> <li>\u4f7f\u7528 <code>delegatecall</code> \u5c06\u8c03\u7528\u8f6c\u53d1\u7ed9\u903b\u8f91\u5408\u7ea6</li> <li>\u903b\u8f91\u5408\u7ea6\u7684\u4ee3\u7801\u5728\u4ee3\u7406\u5408\u7ea6\u7684\u5b58\u50a8\u4e0a\u6267\u884c</li> </ol>"},{"location":"web3/dapp/solidity_proxy_upgrade_series_part1_251229/#_5","title":"\u5c0f\u7ed3","text":"<p>\u672c\u7bc7\u6211\u4eec\u4ecb\u7ecd\u4e86\uff1a</p> <ol> <li>\u4e3a\u4ec0\u4e48\u9700\u8981\u53ef\u5347\u7ea7\u5408\u7ea6\uff1a\u5e73\u8861\u4e0d\u53ef\u53d8\u6027\u4e0e\u53ef\u7ef4\u62a4\u6027</li> <li>delegatecall \u7684\u5de5\u4f5c\u539f\u7406\uff1a\u501f\u7528\u4ee3\u7801\uff0c\u672c\u5730\u6267\u884c</li> <li>\u5b58\u50a8\u69fd\u51b2\u7a81\u95ee\u9898\uff1a\u4ee5\u53ca EIP-1967 \u7684\u89e3\u51b3\u65b9\u6848</li> <li>\u6700\u7b80\u4ee3\u7406\u5408\u7ea6\uff1a\u57fa\u7840\u5b9e\u73b0\u6846\u67b6</li> </ol> <p>\u4f46\u8fd9\u4e2a\u7b80\u5355\u5b9e\u73b0\u8fd8\u6709\u4e00\u4e2a\u4e25\u91cd\u95ee\u9898\uff1a\u51fd\u6570\u9009\u62e9\u5668\u51b2\u7a81\uff08Function Selector Clash\uff09\u3002</p> <p>\u4e3e\u4e2a\u4f8b\u5b50\uff1a\u5982\u679c\u4ee3\u7406\u5408\u7ea6\u6709\u4e00\u4e2a <code>upgrade()</code> \u51fd\u6570\u7528\u4e8e\u5347\u7ea7\uff0c\u800c\u903b\u8f91\u5408\u7ea6\u6070\u597d\u4e5f\u6709\u4e1a\u52a1\u51fd\u6570\u53eb <code>upgrade()</code>\uff0c\u4f1a\u53d1\u751f\u4ec0\u4e48\uff1f\u7528\u6237\u8c03\u7528\u65f6\uff0cEVM \u4f1a\u4f18\u5148\u5339\u914d\u4ee3\u7406\u5408\u7ea6\u7684\u51fd\u6570\uff0c\u903b\u8f91\u5408\u7ea6\u7684\u540c\u540d\u51fd\u6570\u5c06\u6c38\u8fdc\u65e0\u6cd5\u88ab\u8c03\u7528\uff01</p> <p>\u4e0b\u4e00\u7bc7\uff0c\u6211\u4eec\u5c06\u6df1\u5165\u63a2\u8ba8\u4e24\u5927\u4e3b\u6d41\u4ee3\u7406\u6a21\u5f0f\uff1a\u900f\u660e\u4ee3\u7406\uff08Transparent Proxy\uff09\u548c UUPS\uff0c\u770b\u5b83\u4eec\u5982\u4f55\u4f18\u96c5\u5730\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\u3002</p> <p>\u7cfb\u5217\u5bfc\u822a</p> <ul> <li>\u7b2c\u4e00\u7bc7\uff1aSolidity \u4ee3\u7406\u5408\u7ea6\u4e0e\u53ef\u5347\u7ea7\u5408\u7ea6\u7cfb\u5217\uff08\u4e00\uff09\uff1a\u4e3a\u4ec0\u4e48\u9700\u8981\u53ef\u5347\u7ea7\uff1f\uff08\u672c\u7bc7\uff09</li> <li>\u7b2c\u4e8c\u7bc7\uff1aSolidity \u4ee3\u7406\u5408\u7ea6\u4e0e\u53ef\u5347\u7ea7\u5408\u7ea6\u7cfb\u5217\uff08\u4e8c\uff09\uff1a\u900f\u660e\u4ee3\u7406 vs UUPS</li> </ul>"},{"location":"web3/dapp/solidity_proxy_upgrade_series_part2_251230/","title":"Solidity \u4ee3\u7406\u5408\u7ea6\u4e0e\u53ef\u5347\u7ea7\u5408\u7ea6\u7cfb\u5217\uff08\u4e8c\uff09\uff1a\u900f\u660e\u4ee3\u7406 vs UUPS","text":"<p>\u4e0a\u4e00\u7bc7\u6211\u4eec\u7406\u89e3\u4e86 delegatecall \u548c\u5b58\u50a8\u69fd\u51b2\u7a81\u95ee\u9898\u3002\u672c\u7bc7\u5c06\u6df1\u5165\u4e24\u5927\u4e3b\u6d41\u4ee3\u7406\u6a21\u5f0f\u3002</p>"},{"location":"web3/dapp/solidity_proxy_upgrade_series_part2_251230/#_1","title":"\u51fd\u6570\u9009\u62e9\u5668\u51b2\u7a81","text":"<p>\u5728\u5b9e\u73b0\u53ef\u5347\u7ea7\u4ee3\u7406\u65f6\uff0c\u6211\u4eec\u9047\u5230\u4e86\u65b0\u95ee\u9898\u3002</p> <p>\u5047\u8bbe\u4ee3\u7406\u5408\u7ea6\u9700\u8981\u4e00\u4e2a <code>upgrade()</code> \u51fd\u6570\u6765\u66f4\u65b0\u903b\u8f91\u5408\u7ea6\u5730\u5740\uff1a</p> <pre><code>contract Proxy {\n    address public implementation;\n\n    function upgrade(address newImpl) public {\n        implementation = newImpl;\n    }\n\n    fallback() external payable {\n        // delegatecall to implementation\n    }\n}\n</code></pre> <p>\u95ee\u9898\u6765\u4e86\uff1a\u5982\u679c\u903b\u8f91\u5408\u7ea6\u4e5f\u6709\u4e00\u4e2a <code>upgrade()</code> \u51fd\u6570\u5462\uff1f</p> <pre><code>contract Implementation {\n    function upgrade(address) public {\n        // \u4e1a\u52a1\u903b\u8f91...\n    }\n}\n</code></pre> <p>\u5f53\u7528\u6237\u8c03\u7528 <code>upgrade()</code> \u65f6\uff0cEVM \u4f1a\u5148\u68c0\u67e5\u4ee3\u7406\u5408\u7ea6\u662f\u5426\u6709\u5339\u914d\u7684\u51fd\u6570\u3002\u5982\u679c\u6709\uff0c\u5c31\u76f4\u63a5\u6267\u884c\u4ee3\u7406\u5408\u7ea6\u7684\u51fd\u6570\uff0c\u6c38\u8fdc\u4e0d\u4f1a\u89e6\u53d1 fallback\u3002</p> <p>\u7ed3\u679c\uff1a\u903b\u8f91\u5408\u7ea6\u7684 <code>upgrade()</code> \u51fd\u6570\u65e0\u6cd5\u88ab\u8c03\u7528\u3002</p> <p>\u66f4\u5371\u9669\u7684\u662f\uff1a\u4e0d\u540c\u51fd\u6570\u53ef\u80fd\u6709\u76f8\u540c\u7684\u51fd\u6570\u9009\u62e9\u5668\u3002\u51fd\u6570\u9009\u62e9\u5668\u53ea\u6709 4 \u5b57\u8282\uff0c\u5b58\u5728\u7ea6 1/43 \u4ebf\u7684\u78b0\u649e\u6982\u7387\u3002\u6bd4\u5982 <code>clash550254402()</code> \u548c <code>proxyAdmin()</code> \u7684\u9009\u62e9\u5668\u5b8c\u5168\u76f8\u540c\u3002</p>"},{"location":"web3/dapp/solidity_proxy_upgrade_series_part2_251230/#transparent-proxy","title":"\u89e3\u51b3\u65b9\u6848\u4e00\uff1a\u900f\u660e\u4ee3\u7406\uff08Transparent Proxy\uff09","text":"<p>\u900f\u660e\u4ee3\u7406\u7684\u6838\u5fc3\u601d\u8def\u5f88\u7b80\u5355\uff1a\u4ee3\u7406\u5408\u7ea6\u9664\u4e86 fallback\uff0c\u4e0d\u66b4\u9732\u4efb\u4f55\u516c\u5f00\u51fd\u6570\u3002</p> <p>\u4f46\u6ca1\u6709\u516c\u5f00\u51fd\u6570\uff0c\u600e\u4e48\u5347\u7ea7\uff1f\u7b54\u6848\u662f\uff1a\u901a\u8fc7 msg.sender \u6765\u533a\u5206\u8c03\u7528\u8005\u3002</p> <pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502              \u900f\u660e\u4ee3\u7406\u7684\u8def\u7531\u89c4\u5219                 \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502  \u8c03\u7528\u8005 = \u7ba1\u7406\u5458?                              \u2502\n\u2502     \u2502                                        \u2502\n\u2502     \u251c\u2500\u2500 \u662f \u2192 \u6267\u884c\u4ee3\u7406\u5408\u7ea6\u81ea\u8eab\u7684\u7ba1\u7406\u51fd\u6570           \u2502\n\u2502     \u2502        (upgrade\u3001changeAdmin \u7b49)        \u2502\n\u2502     \u2502                                        \u2502\n\u2502     \u2514\u2500\u2500 \u5426 \u2192 \u5168\u90e8 delegatecall \u5230\u5b9e\u73b0\u5408\u7ea6       \u2502\n\u2502              (\u5373\u4f7f\u8c03\u7528\u7684\u662f upgrade)            \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre> <p>\u4e3a\u4ec0\u4e48\u53eb\u300c\u900f\u660e\u300d\uff1f</p> <p>\u5bf9\u4e8e\u666e\u901a\u7528\u6237\u6765\u8bf4\uff0c\u4ee3\u7406\u5408\u7ea6\u662f\u300c\u900f\u660e\u300d\u7684\u2014\u2014\u4ed6\u4eec\u770b\u4e0d\u5230\u4efb\u4f55\u4ee3\u7406\u76f8\u5173\u7684\u51fd\u6570\uff0c\u6240\u6709\u8c03\u7528\u90fd\u4f1a\u88ab\u8f6c\u53d1\u3002\u4ee3\u7406\u5408\u7ea6\u7684\u7ba1\u7406\u529f\u80fd\u53ea\u5bf9\u7ba1\u7406\u5458\u300c\u53ef\u89c1\u300d\u3002</p> <pre><code>contract TransparentProxy {\n    address immutable admin;\n\n    constructor(address _admin) {\n        admin = _admin;\n    }\n\n    fallback() external payable {\n        if (msg.sender == admin) {\n            // \u6267\u884c\u5347\u7ea7\u903b\u8f91\n        } else {\n            // delegatecall \u5230\u903b\u8f91\u5408\u7ea6\n        }\n    }\n}\n</code></pre> <p>\u89c4\u5219\uff1a - admin \u8c03\u7528\uff1a\u8def\u7531\u5230\u5347\u7ea7\u903b\u8f91 - \u666e\u901a\u7528\u6237\u8c03\u7528\uff1a\u8def\u7531\u5230\u903b\u8f91\u5408\u7ea6</p> <p>\u8fd9\u5b8c\u5168\u6d88\u9664\u4e86\u51fd\u6570\u9009\u62e9\u5668\u51b2\u7a81\u2014\u2014\u56e0\u4e3a\u4ee3\u7406\u5408\u7ea6\u6839\u672c\u6ca1\u6709\u516c\u5f00\u51fd\u6570\u3002</p>"},{"location":"web3/dapp/solidity_proxy_upgrade_series_part2_251230/#openzeppelin","title":"OpenZeppelin \u7684\u5b9e\u73b0\u7ed3\u6784","text":"<p>\u4f46\u4e0a\u8ff0\u8bbe\u8ba1\u6709\u4e2a\u95ee\u9898\uff1aadmin \u65e0\u6cd5\u76f4\u63a5\u4f7f\u7528\u5408\u7ea6\u529f\u80fd\uff0c\u56e0\u4e3a\u5b83\u7684\u8c03\u7528\u4f1a\u88ab\u8def\u7531\u5230\u5347\u7ea7\u903b\u8f91\u3002</p> <p>OpenZeppelin \u7684\u89e3\u51b3\u65b9\u6848\u662f\u5f15\u5165 ProxyAdmin \u5408\u7ea6\uff1a</p> <pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510       \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510       \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 Owner (EOA)  \u2502\u2500\u2500\u2500\u2500\u2500\u2500\u25ba\u2502   ProxyAdmin   \u2502\u2500\u2500\u2500\u2500\u2500\u2500\u25ba\u2502 TransparentProxy\u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518       \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518       \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre> <ul> <li>\u4ee3\u7406\u5408\u7ea6\u7684 admin \u662f ProxyAdmin \u5408\u7ea6\uff08\u5730\u5740\u56fa\u5b9a\uff09</li> <li>ProxyAdmin \u7684 owner \u662f\u771f\u6b63\u7684\u7ba1\u7406\u5458</li> <li>owner \u901a\u8fc7 ProxyAdmin \u95f4\u63a5\u5347\u7ea7\u4ee3\u7406</li> <li>owner \u4e5f\u53ef\u4ee5\u76f4\u63a5\u8c03\u7528\u4ee3\u7406\u4f7f\u7528\u5408\u7ea6\u529f\u80fd\uff08\u56e0\u4e3a msg.sender \u662f owner\uff0c\u4e0d\u662f admin\uff09</li> </ul> <p>OpenZeppelin \u5408\u7ea6\u7ee7\u627f\u7ed3\u6784\uff1a</p> <pre><code>Proxy.sol (\u62bd\u8c61\u57fa\u7c7b)\n    \u2502\n    \u2514\u2500\u2500 ERC1967Proxy.sol (\u5b9e\u73b0 EIP-1967 \u69fd\u4f4d)\n            \u2502\n            \u2514\u2500\u2500 TransparentUpgradeableProxy.sol\n                    \u2502\n                    \u2514\u2500\u2500 \u914d\u5408 ProxyAdmin.sol \u4f7f\u7528\n</code></pre> <pre><code>contract ProxyAdmin {\n    address public owner;\n\n    function upgradeAndCall(\n        ITransparentUpgradeableProxy proxy,\n        address implementation,\n        bytes memory data\n    ) public onlyOwner {\n        proxy.upgradeToAndCall(implementation, data);\n    }\n}\n</code></pre> <p>\u5173\u952e\u8bbe\u8ba1\uff1a</p> <ul> <li>\u4ee3\u7406\u5408\u7ea6\u53ea\u6709 <code>fallback()</code> \u51fd\u6570</li> <li>\u6240\u6709\u7ba1\u7406\u529f\u80fd\u901a\u8fc7 ProxyAdmin \u8c03\u7528</li> <li>\u7ba1\u7406\u5458\u5730\u5740\u5b58\u50a8\u5728 EIP-1967 \u69fd\u4f4d</li> </ul> <p>\u4f18\u70b9\uff1a</p> <ul> <li>\u5f7b\u5e95\u6d88\u9664\u51fd\u6570\u9009\u62e9\u5668\u51b2\u7a81</li> <li>\u5347\u7ea7\u903b\u8f91\u5728\u4ee3\u7406\u5408\u7ea6\u4e2d\uff0c\u903b\u8f91\u5408\u7ea6\u4e0d\u9700\u8981\u5305\u542b\u5347\u7ea7\u4ee3\u7801</li> </ul> <p>\u7f3a\u70b9\uff1a</p> <ul> <li>\u9700\u8981\u989d\u5916\u90e8\u7f72 ProxyAdmin \u5408\u7ea6</li> <li>\u6bcf\u6b21\u8c03\u7528\u90fd\u8981\u68c0\u67e5 <code>msg.sender == admin</code>\uff0c\u589e\u52a0 gas \u6d88\u8017</li> </ul>"},{"location":"web3/dapp/solidity_proxy_upgrade_series_part2_251230/#uups","title":"\u89e3\u51b3\u65b9\u6848\u4e8c\uff1aUUPS\uff08\u901a\u7528\u53ef\u5347\u7ea7\u4ee3\u7406\u6807\u51c6\uff09","text":"<p>UUPS\uff08ERC-1822\uff09\u91c7\u7528\u4e86\u4e0d\u540c\u7684\u7b56\u7565\uff1a\u628a\u5347\u7ea7\u903b\u8f91\u653e\u5728\u903b\u8f91\u5408\u7ea6\u4e2d\u3002</p> <pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510            \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502    UUPSProxy      \u2502            \u2502    Implementation \u2502\n\u2502                   \u2502            \u2502                   \u2502\n\u2502 - \u53ea\u6709 fallback    \u2502\u25c4\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba \u2502  - \u4e1a\u52a1\u903b\u8f91        \u2502\n\u2502 - \u65e0\u5347\u7ea7\u903b\u8f91        \u2502delegatecall\u2502  - upgrade() \u51fd\u6570  \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518            \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"web3/dapp/solidity_proxy_upgrade_series_part2_251230/#_2","title":"\u5347\u7ea7\u662f\u5982\u4f55\u5de5\u4f5c\u7684\uff1f","text":"<p>UUPS \u7684\u5347\u7ea7\u8fc7\u7a0b\uff1a</p> <ol> <li>\u7ba1\u7406\u5458\u8c03\u7528 Proxy \u7684 <code>upgradeTo(newImpl)</code></li> <li>Proxy \u901a\u8fc7 <code>fallback()</code> \u5c06\u8c03\u7528 delegatecall \u7ed9\u5f53\u524d\u5b9e\u73b0\u5408\u7ea6</li> <li>\u5b9e\u73b0\u5408\u7ea6\u7684 <code>upgradeTo()</code> \u88ab\u6267\u884c</li> <li>\u7531\u4e8e\u662f delegatecall\uff0c\u4fee\u6539\u7684\u662f Proxy \u7684\u5b58\u50a8</li> <li>Proxy \u7684\u5b9e\u73b0\u5730\u5740\u88ab\u66f4\u65b0\u4e3a <code>newImpl</code></li> </ol> <pre><code>Admin \u2500\u2500upgradeTo(V2)\u2500\u2500\u25ba Proxy \u2500delegatecall\u2500\u25ba Impl V1\n                           \u2502                      \u2502\n                           \u2502    upgradeTo() \u4fee\u6539   \u2502\n                           \u2502    Proxy \u7684\u5b58\u50a8       \u2502\n                           \u25bc                      \u2502\n                    implementation = V2  \u25c4\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"web3/dapp/solidity_proxy_upgrade_series_part2_251230/#_3","title":"\u4ee3\u7801\u7ed3\u6784","text":"<p>\u4ee3\u7406\u5408\u7ea6\u6781\u5176\u7b80\u5355\uff1a</p> <pre><code>contract UUPSProxy {\n    constructor(address _implementation) {\n        assembly {\n            sstore(\n                0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc,\n                _implementation\n            )\n        }\n    }\n\n    fallback() external payable {\n        // \u8bfb\u53d6\u5b9e\u73b0\u5730\u5740\u5e76 delegatecall\n    }\n}\n</code></pre> <p>\u903b\u8f91\u5408\u7ea6\u9700\u8981\u7ee7\u627f OpenZeppelin \u7684 <code>UUPSUpgradeable</code>\uff1a</p> <pre><code>import \"@openzeppelin/contracts-upgradeable/proxy/utils/UUPSUpgradeable.sol\";\n\ncontract MyContract is UUPSUpgradeable {\n    // \u4e1a\u52a1\u903b\u8f91...\n\n    function _authorizeUpgrade(address newImplementation) \n        internal \n        override \n        onlyOwner \n    {}\n}\n</code></pre>"},{"location":"web3/dapp/solidity_proxy_upgrade_series_part2_251230/#proxiableuuid","title":"proxiableUUID\uff1a\u5b89\u5168\u68c0\u67e5","text":"<p>UUPS \u6709\u4e2a\u5de7\u5999\u7684\u5b89\u5168\u673a\u5236\uff1a\u5347\u7ea7\u524d\u4f1a\u68c0\u67e5\u65b0\u5408\u7ea6\u662f\u5426\u517c\u5bb9\u3002</p> <pre><code>function proxiableUUID() external view returns (bytes32) {\n    return IMPLEMENTATION_SLOT;\n}\n</code></pre> <p>\u5347\u7ea7\u65f6\uff0c\u4f1a\u8c03\u7528\u65b0\u5408\u7ea6\u7684 <code>proxiableUUID()</code>\uff1a - \u5982\u679c\u8fd4\u56de\u6b63\u786e\u7684\u5b58\u50a8\u69fd\u5730\u5740\uff0c\u8bf4\u660e\u65b0\u5408\u7ea6\u662f UUPS \u517c\u5bb9\u7684 - \u5982\u679c\u8c03\u7528\u5931\u8d25\u6216\u8fd4\u56de\u503c\u9519\u8bef\uff0c\u5347\u7ea7\u88ab\u62d2\u7edd</p> <p>\u8fd9\u9632\u6b62\u4e86\u610f\u5916\u5347\u7ea7\u5230\u4e00\u4e2a\u6ca1\u6709\u5347\u7ea7\u80fd\u529b\u7684\u5408\u7ea6\u2014\u2014\u90a3\u5c06\u5bfc\u81f4\u5408\u7ea6\u6c38\u8fdc\u65e0\u6cd5\u518d\u5347\u7ea7\u3002</p>"},{"location":"web3/dapp/solidity_proxy_upgrade_series_part2_251230/#uups_1","title":"UUPS \u7684\u98ce\u9669","text":"<p>\u98ce\u9669\u4e00\uff1a\u5fd8\u8bb0\u5b9e\u73b0\u5347\u7ea7\u51fd\u6570</p> <p>\u5982\u679c\u65b0\u7248\u672c\u7684\u5b9e\u73b0\u5408\u7ea6\u6ca1\u6709 <code>upgradeTo()</code> \u51fd\u6570\uff0c\u5408\u7ea6\u5c06\u6c38\u4e45\u5931\u53bb\u5347\u7ea7\u80fd\u529b\uff1a</p> <pre><code>// \u274c \u707e\u96be\uff1a\u5fd8\u4e86\u7ee7\u627f UUPSUpgradeable\ncontract ImplV2 {\n    // \u6ca1\u6709 upgradeTo() \u51fd\u6570 \u2192 \u6c38\u8fdc\u65e0\u6cd5\u518d\u5347\u7ea7\uff01\n}\n</code></pre> <p>\u9632\u62a4\u63aa\u65bd\uff1aOpenZeppelin \u8981\u6c42\u5b9e\u73b0\u5408\u7ea6\u7ee7\u627f <code>UUPSUpgradeable</code>\uff0c\u5e76\u5b9e\u73b0 <code>_authorizeUpgrade()</code> \u94a9\u5b50\u3002</p> <p>\u98ce\u9669\u4e8c\uff1a\u672a\u521d\u59cb\u5316\u7684\u5b9e\u73b0\u5408\u7ea6</p> <p>\u5982\u679c\u6709\u4eba\u76f4\u63a5\u8c03\u7528\u5b9e\u73b0\u5408\u7ea6\u7684 <code>initialize()</code>\uff0c\u4ed6\u53ef\u4ee5\u6210\u4e3a\u5b9e\u73b0\u5408\u7ea6\u7684 owner\uff0c\u7136\u540e\u8c03\u7528 <code>upgradeTo()</code> \u6307\u5411\u4e00\u4e2a\u5305\u542b <code>selfdestruct</code> \u7684\u5408\u7ea6\u3002\u8fd9\u66fe\u7ecf\u662f\u771f\u5b9e\u7684\u653b\u51fb\u5411\u91cf\uff08Wormhole \u4e8b\u4ef6\uff09\u3002</p> <p>\u9632\u62a4\uff1a\u5728\u6784\u9020\u51fd\u6570\u4e2d\u8c03\u7528 <code>_disableInitializers()</code>\uff1a</p> <pre><code>constructor() {\n    _disableInitializers();\n}\n</code></pre>"},{"location":"web3/dapp/solidity_proxy_upgrade_series_part2_251230/#vs-uups","title":"\u900f\u660e\u4ee3\u7406 vs UUPS\uff1a\u5982\u4f55\u9009\u62e9\uff1f","text":"\u7279\u6027 \u900f\u660e\u4ee3\u7406 UUPS \u5347\u7ea7\u903b\u8f91\u4f4d\u7f6e \u4ee3\u7406\u5408\u7ea6 \u903b\u8f91\u5408\u7ea6 Gas \u6210\u672c \u8f83\u9ad8\uff08\u6bcf\u6b21\u68c0\u67e5 admin\uff09 \u8f83\u4f4e \u4ee3\u7406\u5408\u7ea6\u5927\u5c0f \u8f83\u5927 \u6700\u5c0f \u903b\u8f91\u5408\u7ea6\u5927\u5c0f \u8f83\u5c0f \u8f83\u5927\uff08\u542b\u5347\u7ea7\u4ee3\u7801\uff09 \u98ce\u9669 \u8f83\u4f4e \u8f83\u9ad8\uff08\u53ef\u80fd\u4e22\u5931\u5347\u7ea7\u80fd\u529b\uff09 \u9002\u7528\u573a\u666f \u901a\u7528\u573a\u666f\u3001\u5b89\u5168\u4f18\u5148 \u9ad8\u9891\u8c03\u7528\u3001gas \u654f\u611f <p>\u9009\u62e9\u5efa\u8bae\uff1a</p> <ul> <li>\u903b\u8f91\u5408\u7ea6\u63a5\u8fd1 24KB \u9650\u5236 \u2192 \u900f\u660e\u4ee3\u7406</li> <li>\u9700\u8981\u6781\u81f4 gas \u4f18\u5316 \u2192 UUPS</li> <li>\u8ffd\u6c42\u7b80\u5355\u5b89\u5168 \u2192 \u900f\u660e\u4ee3\u7406</li> </ul> <p>OpenZeppelin \u5f53\u524d\u63a8\u8350\u4f7f\u7528 UUPS\uff0c\u56e0\u4e3a\u5b83\u66f4\u8f7b\u91cf\u4e14\u7075\u6d3b\u3002</p>"},{"location":"web3/dapp/solidity_proxy_upgrade_series_part2_251230/#_4","title":"\u67b6\u6784\u5bf9\u6bd4\u56fe","text":"<pre><code>\u3010\u900f\u660e\u4ee3\u7406\u67b6\u6784\u3011\n\n  \u7528\u6237                    Owner\n   \u2502                        \u2502\n   \u25bc                        \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 TransparentProxy\u2502\u25c4\u2500\u2500 \u2502 ProxyAdmin \u2502\n\u2502                 \u2502    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\u2502  \u68c0\u67e5 msg.sender \u2502\n\u2502  \u251c\u2500 admin \u2192 \u5347\u7ea7 \u2502\n\u2502  \u2514\u2500 \u5176\u4ed6 \u2192 \u8f6c\u53d1   \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n         \u2502 delegatecall\n         \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 Implementation  \u2502  \u2190 \u7eaf\u4e1a\u52a1\u903b\u8f91\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\n\n\u3010UUPS \u67b6\u6784\u3011\n\n  \u7528\u6237 / Admin\n       \u2502\n       \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502   UUPSProxy     \u2502  \u2190 \u6781\u7b80\uff0c\u53ea\u6709 fallback\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n        \u2502 delegatecall\n        \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  Implementation \u2502  \u2190 \u4e1a\u52a1\u903b\u8f91 + \u5347\u7ea7\u903b\u8f91\n\u2502                 \u2502\n\u2502  upgradeTo()    \u2502\n\u2502  _authorizeUpgrade()\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"web3/dapp/solidity_proxy_upgrade_series_part2_251230/#_5","title":"\u5176\u4ed6\u4ee3\u7406\u6a21\u5f0f\u7b80\u4ecb","text":"<p>\u9664\u4e86\u900f\u660e\u4ee3\u7406\u548c UUPS\uff0c\u8fd8\u6709\u51e0\u79cd\u5e38\u89c1\u6a21\u5f0f\uff0c\u8fd9\u91cc\u7b80\u5355\u4e86\u89e3\u5373\u53ef\uff1a</p>"},{"location":"web3/dapp/solidity_proxy_upgrade_series_part2_251230/#beacon-proxy","title":"Beacon Proxy","text":"<p>\u591a\u4e2a\u4ee3\u7406\u5171\u4eab\u540c\u4e00\u4e2a\u903b\u8f91\u5408\u7ea6\u5730\u5740\uff0c\u901a\u8fc7 Beacon \u5408\u7ea6\u7edf\u4e00\u7ba1\u7406\u3002\u66f4\u65b0 Beacon \u4e00\u6b21\uff0c\u6240\u6709\u4ee3\u7406\u540c\u65f6\u5347\u7ea7\u3002</p> <p>\u9002\u7528\u573a\u666f\uff1a\u9700\u8981\u6279\u91cf\u90e8\u7f72\u548c\u6279\u91cf\u5347\u7ea7\uff0c\u5982 NFT \u5de5\u5382\u3002</p>"},{"location":"web3/dapp/solidity_proxy_upgrade_series_part2_251230/#diamond-proxyeip-2535","title":"Diamond Proxy\uff08EIP-2535\uff09","text":"<p>\u4e00\u4e2a\u4ee3\u7406\u53ef\u4ee5\u6307\u5411\u591a\u4e2a\u903b\u8f91\u5408\u7ea6\uff0c\u901a\u8fc7\u51fd\u6570\u9009\u62e9\u5668\u8def\u7531\u5230\u4e0d\u540c\u7684 Facet\u3002</p> <p>\u9002\u7528\u573a\u666f\uff1a\u8d85\u5927\u578b\u5408\u7ea6\uff0c\u9700\u8981\u7a81\u7834 24KB \u9650\u5236\u3002</p>"},{"location":"web3/dapp/solidity_proxy_upgrade_series_part2_251230/#minimal-proxyeip-1167","title":"Minimal Proxy\uff08EIP-1167\uff09","text":"<p>\u6781\u7b80\u514b\u9686\u6a21\u5f0f\uff0c\u6240\u6709\u514b\u9686\u5171\u4eab\u540c\u4e00\u4efd\u903b\u8f91\u4ee3\u7801\uff0c\u90e8\u7f72\u6210\u672c\u6781\u4f4e\uff08\u7ea6 45 \u5b57\u8282\uff09\uff0c\u4f46\u4e0d\u53ef\u5347\u7ea7\u3002</p> <p>\u9002\u7528\u573a\u666f\uff1a\u9700\u8981\u5927\u91cf\u90e8\u7f72\u76f8\u540c\u903b\u8f91\u7684\u5408\u7ea6\uff0c\u5982\u7528\u6237\u94b1\u5305\u3002</p>"},{"location":"web3/dapp/solidity_proxy_upgrade_series_part2_251230/#_6","title":"\u5c0f\u7ed3","text":"<p>\u672c\u7bc7\u6211\u4eec\u5b66\u4e60\u4e86\uff1a</p> <ol> <li>\u51fd\u6570\u9009\u62e9\u5668\u51b2\u7a81\u95ee\u9898\uff1a\u4ee3\u7406\u5408\u7ea6\u7684\u516c\u5f00\u51fd\u6570\u4f1a\u906e\u853d\u903b\u8f91\u5408\u7ea6\u7684\u540c\u540d\u51fd\u6570</li> <li>\u900f\u660e\u4ee3\u7406\uff1a\u901a\u8fc7\u68c0\u67e5 msg.sender \u533a\u5206\u8c03\u7528\u8005\uff0c\u6d88\u9664\u51b2\u7a81</li> <li>UUPS\uff1a\u5c06\u5347\u7ea7\u903b\u8f91\u653e\u5165\u903b\u8f91\u5408\u7ea6\uff0c\u4ee3\u7406\u5408\u7ea6\u6781\u7b80\u5316</li> <li>\u5982\u4f55\u9009\u62e9\uff1a\u6839\u636e gas \u4f18\u5316\u9700\u6c42\u3001\u5408\u7ea6\u5927\u5c0f\u9650\u5236\u3001\u5b89\u5168\u6027\u9700\u6c42\u51b3\u5b9a</li> <li>\u5176\u4ed6\u4ee3\u7406\u6a21\u5f0f\uff1aBeacon\u3001Diamond\u3001Minimal Proxy</li> </ol> <p>\u6700\u540e\u7684\u5efa\u8bae\uff1a</p> <p>\u53ef\u5347\u7ea7\u5408\u7ea6\u662f\u4e00\u628a\u53cc\u5203\u5251\u3002\u5b83\u89e3\u51b3\u4e86\u4e0d\u53ef\u53d8\u6027\u7684\u56f0\u5883\uff0c\u4f46\u4e5f\u5f15\u5165\u4e86\u65b0\u7684\u4fe1\u4efb\u5047\u8bbe\u548c\u5b89\u5168\u98ce\u9669\u3002</p> <p>\u5728\u4f7f\u7528\u53ef\u5347\u7ea7\u6a21\u5f0f\u524d\uff0c\u8bf7\u8ba4\u771f\u601d\u8003\uff1a</p> <ul> <li>\u4f60\u7684\u5408\u7ea6\u771f\u7684\u9700\u8981\u5347\u7ea7\u80fd\u529b\u5417\uff1f</li> <li>\u7528\u6237\u662f\u5426\u4fe1\u4efb\u4f60\uff08\u6216 DAO\uff09\u4e0d\u4f1a\u6076\u610f\u5347\u7ea7\uff1f</li> <li>\u4f60\u662f\u5426\u6709\u5b8c\u5584\u7684\u5347\u7ea7\u6cbb\u7406\u6d41\u7a0b\uff1f</li> </ul> <p>\u5982\u679c\u7b54\u6848\u90fd\u662f\u80af\u5b9a\u7684\uff0c\u90a3\u4e48\u8bf7\u9009\u62e9\u9002\u5408\u7684\u6a21\u5f0f\uff0c\u9075\u5faa\u6700\u4f73\u5b9e\u8df5\uff0c\u8ba9\u53ef\u5347\u7ea7\u6027\u6210\u4e3a\u4f60\u7684\u4f18\u52bf\u800c\u975e\u8d1f\u62c5\u3002</p> <p>\u53c2\u8003\u8d44\u6599</p> <ul> <li>RareSkills: Book of Proxy Patterns</li> <li>Ethereum.org: \u5347\u7ea7\u667a\u80fd\u5408\u7ea6</li> <li>OpenZeppelin Upgrades Plugins</li> <li>EIP-1967: Standard Proxy Storage Slots</li> <li>EIP-1822: Universal Upgradeable Proxy Standard</li> </ul> <p>\u7cfb\u5217\u5bfc\u822a</p> <ul> <li>\u7b2c\u4e00\u7bc7\uff1aSolidity \u4ee3\u7406\u5408\u7ea6\u4e0e\u53ef\u5347\u7ea7\u5408\u7ea6\u7cfb\u5217\uff08\u4e00\uff09\uff1a\u4e3a\u4ec0\u4e48\u9700\u8981\u53ef\u5347\u7ea7\uff1f</li> <li>\u7b2c\u4e8c\u7bc7\uff1aSolidity \u4ee3\u7406\u5408\u7ea6\u4e0e\u53ef\u5347\u7ea7\u5408\u7ea6\u7cfb\u5217\uff08\u4e8c\uff09\uff1a\u900f\u660e\u4ee3\u7406 vs UUPS\uff08\u672c\u7bc7\uff09</li> </ul>"},{"location":"web3/defi/uniswap_v2_price_precision_240710/","title":"Uniswap V2 \u4ef7\u683c\u7cbe\u5ea6\u89e3\u6790","text":"<p>\u4ece DeFi \u5f00\u53d1\u8005\u7684\u89d2\u5ea6\uff0c\u6df1\u5165\u89e3\u6790 Uniswap V2 \u767d\u76ae\u4e66\u4e2d\u5173\u4e8e\u4ef7\u683c\u7cbe\u5ea6\u7684\u5185\u5bb9\u3002\u8fd9\u662f Uniswap V2 \u5de5\u7a0b\u8bbe\u8ba1\u7684\u7cbe\u534e\u4e4b\u4e00\uff0c\u4f53\u73b0\u4e86\u5728 EVM \u7ea6\u675f\u4e0b\u7684\u6781\u81f4\u4f18\u5316\u601d\u7ef4\u3002</p> <p>Uniswap V2 \u767d\u76ae\u4e66 2.2.1 \u8fd9\u7ae0\u8282\u4e3b\u8981\u5728\u56de\u7b54\u4e09\u4e2a\u95ee\u9898\uff1a</p> <ol> <li>\u94fe\u4e0a\u600e\u4e48\u8868\u793a\u201c\u4ef7\u683c\u201d\u8fd9\u79cd\u5c0f\u6570\uff1f</li> <li>\u4e3a\u4ec0\u4e48\u662f 112+112\uff0c\u8ddf 224 / 256 \u4f4d\u3001gas\u3001\u5b58\u50a8\u5e03\u5c40\u6709\u4ec0\u4e48\u5173\u7cfb\uff1f</li> <li>\u4e3a\u4ec0\u4e48\u8981\u628a\u65f6\u95f4\u6233\u538b\u6210 32 \u4f4d\u3001\u6ea2\u51fa\u4e4b\u540e\u600e\u4e48\u8fd8\u80fd\u6b63\u786e\u7b97 TWAP\uff1f</li> </ol>"},{"location":"web3/defi/uniswap_v2_price_precision_240710/#uq112112","title":"\u4e00\u3001UQ112.112 \u662f\u4ec0\u4e48\uff1f","text":""},{"location":"web3/defi/uniswap_v2_price_precision_240710/#11-q","title":"1.1 Q\u683c\u5f0f\u7684\u901a\u7528\u5b9a\u4e49","text":"<p><code>Qm.n</code> \u662f\u4e00\u79cd\u8868\u793a\u5b9a\u70b9\u6570\u7684\u683c\u5f0f\uff0c\u201cQ\u201d \u4ee3\u8868\u201c\u4e8c\u8fdb\u5236\u5c0f\u6570\u70b9\u4f4d\u7f6e\u201d\uff08binary point position\uff09\u3002\u5b83\u662f\u4e00\u79cd\u547d\u540d\u60ef\u4f8b\uff0c\u7528\u4e8e\u660e\u786e\u6307\u793a\u5728\u4e00\u4e2a\u6574\u6570\u4e2d\uff0c\u54ea\u91cc\u662f\u6574\u6570\u90e8\u5206\u548c\u5c0f\u6570\u90e8\u5206\u7684\u5206\u754c\u7ebf\u3002\u5176\u4e2d\uff1a</p> <ul> <li>m\uff1a\u4ee3\u8868\u6574\u6570\u90e8\u5206\uff08\u5728\u5c0f\u6570\u70b9\u5de6\u8fb9\uff09\u5360\u7528\u7684\u4f4d\u6570\uff1b</li> <li>n\uff1a\u4ee3\u8868\u5c0f\u6570\u90e8\u5206\uff08\u5728\u5c0f\u6570\u70b9\u53f3\u8fb9\uff09\u5360\u7528\u7684\u4f4d\u6570\uff1b</li> <li>\u603b\u6570\uff1a<code>m + n</code> \u4f4d\uff0c\u901a\u5e38\u5bf9\u5e94\u4e00\u4e2a\u6807\u51c6\u6574\u6570\u7c7b\u578b\uff08\u5982 int32, uint16 \u7b49\uff09\u3002</li> </ul>"},{"location":"web3/defi/uniswap_v2_price_precision_240710/#12","title":"1.2 \u4e3a\u4ec0\u4e48\u9700\u8981\u5b9a\u70b9\u6570\u683c\u5f0f\uff1f","text":"<p>Solidity\uff08\u4ee5\u53caEVM\uff09\u539f\u751f\u53ea\u652f\u6301\u6574\u6570\u8fd0\u7b97\uff0c\u6ca1\u6709\u6d6e\u70b9\u6570\u7c7b\u578b\uff0c\u4f46\u4ef7\u683c\u5929\u7136\u662f\u5c0f\u6570\uff0c\u4f8b\u5982\uff1a1 ETH = 3049.5 USDC\u3002</p> <p>\u4f20\u7edf\u65b9\u6848\u7684\u95ee\u9898\uff1a\u5982\u679c\u76f4\u63a5\u7528 <code>reserve_a / reserve_b</code> \u8ba1\u7b97\u4ef7\u683c\uff0cSolidity \u4f1a\u505a\u6574\u6570\u9664\u6cd5\uff0c\u4e22\u5931\u6240\u6709\u5c0f\u6570\u90e8\u5206\uff0c\u6bd4\u5982 <code>1 / 2000 = 0</code>\uff08\u6574\u6570\u9664\u6cd5\uff09\u3002</p> <p>Uniswap V2 \u7684\u89e3\u51b3\u65b9\u6848\uff1a\u4f7f\u7528\u5b9a\u70b9\u6570\uff08Fixed Point\uff09\u683c\u5f0f <code>UQ112.112</code>\u3002 <code>UQ112.112</code> \u662f<code>Qm.n</code> \u683c\u5f0f\u7684\u4e00\u4e2a\u53d8\u4f53\uff1a</p> <ul> <li>U\uff1a\u4ee3\u8868 Unsigned\uff08\u65e0\u7b26\u53f7\uff09\uff0c\u8fd9\u4e2a\u6570\u6c38\u8fdc\u662f\u6b63\u7684\uff0c\u56e0\u4e3a\u4ef7\u683c\u4e0d\u53ef\u80fd\u4e3a\u8d1f\uff1b</li> <li> <p>Q112.112\uff1a\u8868\u793a\u8fd9\u662f\u4e00\u4e2a\u5b9a\u70b9\u6570\uff0c\u5176\u4e2d\uff1a</p> </li> <li> <ul> <li>\u5c0f\u6570\u70b9\u5de6\u8fb9\u6709 112 \u4f4d\uff08\u7528\u4e8e\u8868\u793a\u6574\u6570\u90e8\u5206\uff09\uff1b</li> </ul> </li> <li>\u5c0f\u6570\u70b9\u53f3\u8fb9\u6709 112 \u4f4d\uff08\u7528\u4e8e\u8868\u793a\u5c0f\u6570\u90e8\u5206\uff09\uff1b</li> <li>\u603b\u8ba1 224 \u4f4d (<code>112 + 112</code>)\u3002</li> </ul> <p>Uniswap V2 \u767d\u76ae\u4e66\u539f\u6587\uff1a</p> <p>prices at a given moment are stored as UQ112.112 numbers, meaning that 112 fractional bits of precision are specified on either side of the decimal point, with no sign. These numbers have a range of [0, 2\u00b9\u00b9\u00b2 \u2212 1] and a precision of 1 / 2\u00b9\u00b9\u00b2. </p> <p>\u7ffb\u8bd1\u4e00\u4e0b\uff0c\u5c31\u662f\uff1a\u201c\u6211\u4eec\u6ca1\u6709\u6d6e\u70b9\u6570\uff0c\u53ea\u597d\u81ea\u5df1\u9020\u4e00\u4e2a\u4e8c\u8fdb\u5236\u5b9a\u70b9\u5c0f\u6570\u683c\u5f0f\uff1a\u628a\u4e00\u4e2a\u6570\u62c6\u6210\u4e24\u90e8\u5206\uff1a</p> <ul> <li>\u524d 112 \u4f4d\uff1a\u6574\u6570\u90e8\u5206\uff080 ~ 2\u00b9\u00b9\u00b2 \u2212 1\uff09</li> <li>\u540e 112 \u4f4d\uff1a\u5c0f\u6570\u90e8\u5206\uff08\u7cbe\u5ea6 2\u207b\u00b9\u00b9\u00b2\uff09</li> <li>\u4e0d\u5e26\u7b26\u53f7\uff08unsigned\uff09\uff0c\u53ea\u8868\u793a\u975e\u8d1f\u3002\u201d</li> </ul>"},{"location":"web3/defi/uniswap_v2_price_precision_240710/#13-0-2112-1","title":"1.3 \u8303\u56f4\u4e3a\u4ec0\u4e48\u662f [0, 2\u00b9\u00b9\u00b2 \u2212 1]\uff1f","text":"<p>\u8fd9\u91cc\u6307\u7684\u662f\u4ef7\u683c\u7684\u6574\u6570\u90e8\u5206\u7684\u8303\u56f4\uff0c\u4e0d\u662f\u6574\u4e2a 224 \u4f4d\u6570\u503c\u6574\u4f53\u7684\u8303\u56f4\u3002</p> <p>\u767d\u76ae\u4e66\u811a\u6ce8\u89e3\u91ca\u5f97\u5f88\u6e05\u695a\uff1aUniswap \u91cc\u8fd9\u4e2a UQ112.112 \u7684\u4ef7\u683c\u6c38\u8fdc\u6765\u81ea\u4e24\u4e2a uint112 \u50a8\u5907\u7684\u6bd4\u503c\uff1a</p> <p>UQ112.112 numbers in Uniswap are always generated from the ratio of two uint112s. The largest such ratio is (2\u00b9\u00b9\u00b2\u22121) / 1 = 2\u00b9\u00b9\u00b2 \u2212 1.</p> <p>\u5728 UniswapV2Pair.sol \u5408\u7ea6\u4e2d\uff0c<code>reserve0</code>\u3001<code>reserve1</code> \u88ab\u5b9a\u4e49\u4e3a <code>uint112</code> \u7c7b\u578b\uff0c\u6700\u5927\u4ef7\u683c\u60c5\u51b5\u662f\uff1a\u4e00\u8fb9\u50a8\u5907\u63a5\u8fd1 <code>2\u00b9\u00b9\u00b2\u22121</code>\uff0c\u53e6\u4e00\u8fb9\u63a5\u8fd1 1\uff0c\u6240\u4ee5\u4ef7\u683c\u6700\u5927 \u2248 <code>(2\u00b9\u00b9\u00b2\u22121) / 1 \u2248 2\u00b9\u00b9\u00b2\u22121</code>\u3002</p> <p>\u8865\u5145\uff1a\u50a8\u5907\u91d1 <code>reserve0</code>\u3001<code>reserve1</code> \u662f\u6574\u6570\u8ba1\u6570\uff08<code>uint112</code>\uff09\uff0c\u6ca1\u6709\u5c0f\u6570\u4f4d\uff0c\u8868\u793a\u6c60\u5b50\u91cc\u771f\u5b9e\u5b58\u5728\u7684 Token \u6570\u91cf\uff0c\u662f\u4e0d\u53ef\u518d\u7ec6\u5206\u7684\u6700\u5c0f\u5355\u4f4d\uff08wei\u3001\u6700\u5c0f ERC20 \u5355\u4f4d\uff09\uff0c\u7406\u8bba\u4e0a\u50a8\u5907\u6700\u5c0f\u80fd\u5230 1\uff0c\u6700\u5927\u4e3a <code>2\u00b9\u00b9\u00b2\u22121</code>\u3002</p> <p>\u8fd9\u4fdd\u8bc1\u4e86\u6574\u6570\u90e8\u5206\u6700\u591a\u9700\u8981 112 \u4f4d\u5c31\u591f\u4e86\uff080 ~ 2\u00b9\u00b9\u00b2\u22121\uff09\uff0c\u5c0f\u6570\u90e8\u5206\u518d\u7ed9 112 \u4f4d\uff0c\u6574\u4f53 224 \u4f4d\uff0c\u521a\u597d\u653e\u8fdb <code>uint224</code>\u3002</p> \u6982\u5ff5 \u503c\u8303\u56f4 \u6570\u636e\u7c7b\u578b \u7528\u9014 reserve0, reserve1 0 ~ 2\u00b9\u00b9\u00b2\u22121 uint112 \u50a8\u5907\u6570\u91cf\uff08\u6574\u6570\uff09 price = reserve1/reserve0 0 ~ 2\u00b9\u00b9\u00b2\u22121.xxx UQ112.112 \u4ef7\u683c\uff08\u5c0f\u6570 + \u9ad8\u7cbe\u5ea6\uff09 UQ112.112 \u5c0f\u6570\u4f4d 2\u207b\u00b9\u00b9\u00b2 \u5e95\u5c42\u4f4d\u79fb \u8868\u793a\u4ef7\u683c\u7684\u5c0f\u6570\u90e8\u5206 <p>\u7cbe\u5ea6\u4e0a\uff0c\u4e00\u4e2a UQ112.112 \u7684\u6700\u5c0f\u5355\u4f4d\u662f <code>1 / 2\u00b9\u00b9\u00b2</code>\uff0c\u5927\u7ea6 10\u207b\u00b3\u2074 \u91cf\u7ea7\uff0c\u8fdc\u8fdc\u6bd4 1e-18 \u8fd8\u7ec6\uff0c\u5bf9\u4e8e\u73b0\u5b9e\u4e2d token 18 decimals\u3001\u4ef7\u683c\u51e0\u4f4d\u5c0f\u6570\u7684\u5e94\u7528\uff0c\u8fd9\u4e2a\u7cbe\u5ea6\u5b8c\u5168\u591f\u7528\u4e14\u6d6a\u8d39\u4e00\u70b9\u6ca1\u5173\u7cfb\uff0c\u91cd\u70b9\u662f\u65b9\u4fbf\u6570\u5b66\u548c\u5b58\u50a8\u5e03\u5c40\u3002</p>"},{"location":"web3/defi/uniswap_v2_price_precision_240710/#112112","title":"\u4e8c\u3001 \u4e3a\u4ec0\u4e48\u662f 112+112\uff1f\u5b58\u50a8\u69fd\u7684\u7cbe\u5999\u8bbe\u8ba1","text":"<p>\u8fd9\u662f\u6574\u4e2a\u8bbe\u8ba1\u6700\u5de7\u5999\u7684\u5730\u65b9\uff0c\u6d89\u53ca\u5230Gas\u4f18\u5316\u548c\u5b58\u50a8\u5e03\u5c40\u3002</p> <p>EVM \u5b58\u50a8\u69fd\u57fa\u7840\uff1aEVM \u7684\u4e00\u4e2a\u5b58\u50a8\u69fd\uff08storage slot\uff09= 256\u4f4d\uff0c\u6bcf\u6b21 <code>SSTORE</code> \u64cd\u4f5c\uff08\u5199\u5165\u5b58\u50a8\uff09\u6d88\u8017\u5927\u91cf Gas\uff08~20,000 gas\uff09\uff0c\u6253\u5305\u5b58\u50a8\uff08packing\uff09\u53ef\u4ee5\u5728\u4e00\u4e2a\u69fd\u5185\u5b58\u591a\u4e2a\u53d8\u91cf\uff0c\u8282\u7701 Gas\u3002</p> <p>\u767d\u76ae\u4e66\u5173\u952e\u53e5\uff1a</p> <p>The UQ112.112 format was chosen for a pragmatic reason \u2014 because these numbers can be stored in a uint224, this leaves 32 bits of a 256 bit storage slot free. It also happens that the reserves, each stored in a uint112, also leave 32 bits free in a (packed) 256 bit storage slot.</p> <p>\u4ece\u4ee5\u592a\u574a\u5408\u7ea6\u5b58\u50a8\u89c6\u89d2\u6765\u770b\u5c31\u662f\uff1a</p> <ul> <li>\u50a8\u5907\u91d1\u5b58\u50a8\uff1a\u6bcf\u4e2a\u50a8\u5907\u91d1\uff08<code>uint112</code>\uff09\u7528\u4e86 112 \u4f4d\uff0c\u4e24\u4e2a <code>uint112</code> \u53ef\u4ee5\u7d27\u5bc6\u6253\u5305\u5728\u4e00\u4e2a 256 \u4f4d\u7684\u5b58\u50a8\u69fd\u91cc\uff0c\u7559\u4e0b <code>256 - 2*112 = 32</code> \u4f4d\u7a7a\u95f2\u3002</li> <li>\u4ef7\u683c\u5b58\u50a8\uff1a\u4ef7\u683c\u4f5c\u4e3a\u4e24\u4e2a <code>uint112</code> \u50a8\u5907\u91d1\u7684\u6bd4\u7387\uff0c\u81ea\u7136\u53ef\u4ee5\u8868\u793a\u4e3a\u4e00\u4e2a <code>UQ112.112</code> \u6570\uff0c\u5b83\u521a\u597d\u80fd\u88c5\u8fdb\u4e00\u4e2a <code>uint224</code>\uff08224\u4f4d\uff09\u3002</li> <li> <p>\u7a7a\u95f2\u4f4d\u7684\u5229\u7528\uff1a\u6838\u5fc3\u6765\u4e86\uff01\u90a3\u4e2a\u7a7a\u95f2\u7684 32 \u4f4d\uff08\u6765\u81ea\u50a8\u5907\u91d1\u5b58\u50a8\u69fd\uff09\u548c\u4ef7\u683c\u5b58\u50a8\u69fd\u672b\u5c3e\u7684 32 \u4f4d\uff0c\u88ab\u5de7\u5999\u5730\u7528\u6765\uff1a</p> </li> <li> <ul> <li>\u5b58\u50a8\u65f6\u95f4\u6233\uff08\u6a21 <code>2^32</code>\uff0c\u521a\u597d 32 \u4f4d\uff09\uff1b</li> </ul> </li> <li>\u5b58\u50a8\u4ef7\u683c\u7d2f\u52a0\u8fc7\u7a0b\u4e2d\u7684\u6ea2\u51fa\u4f4d\uff08\u56e0\u4e3a\u8fde\u7eed\u7d2f\u52a0\u53ef\u80fd\u8d85\u8fc7 224 \u4f4d\uff09\u3002</li> </ul> <p>\u5728\u4e0d\u652f\u6301\u6d6e\u70b9\u6570\u7684 EVM \u4e2d\uff0c\u7528\u6574\u6570\u8fd0\u7b97\u6765\u6a21\u62df\u9ad8\u7cbe\u5ea6\u7684\u5c0f\u6570\u8fd0\u7b97\uff0c\u540c\u65f6\u5b8c\u7f8e\u5951\u5408\u5b58\u50a8\u5e03\u5c40\uff0c\u5c06\u9884\u8a00\u673a\u66f4\u65b0\u7684 Gas \u6210\u672c\u964d\u81f3\u6700\u4f4e\uff08\u4ec5\u9996\u6b21\u4ea4\u6613\u589e\u52a0\u7ea6 15,000 gas\uff09\u3002</p>"},{"location":"web3/defi/uniswap_v2_price_precision_240710/#21-uniswap-v2","title":"2.1 Uniswap V2\u7684\u5b58\u50a8\u5e03\u5c40","text":"<p>\u5b9e\u9645\u4ee3\u7801\u7ed3\u6784\uff08\u7b80\u5316\u7248\uff09\uff1a</p> <pre><code>contract UniswapV2Pair {\n    uint112 private reserve0;           // 112\u4f4d\n    uint112 private reserve1;           // 112\u4f4d  \n    uint32  private blockTimestampLast; // 32\u4f4d\n    // \u603b\u5171: 112 + 112 + 32 = 256\u4f4d = 1\u4e2a\u5b58\u50a8\u69fd\uff01\n\n    uint224 public price0CumulativeLast; // 224\u4f4d\n    uint32  private overflowBits0;       // 32\u4f4d\uff08\u6ea2\u51fa\u90e8\u5206\uff09\n    // \u603b\u5171: 224 + 32 = 256\u4f4d = 1\u4e2a\u5b58\u50a8\u69fd\uff01\n\n    uint224 public price1CumulativeLast; // 224\u4f4d\n    uint32  private overflowBits1;       // 32\u4f4d\uff08\u6ea2\u51fa\u90e8\u5206\uff09\n    // \u603b\u5171: 224 + 32 = 256\u4f4d = 1\u4e2a\u5b58\u50a8\u69fd\uff01\n}\n</code></pre> <p>Solidity \u7684 storage packing \u89c4\u5219\uff1a\u5728\u540c\u4e00\u4e2a <code>slot(256bit)</code> \u91cc\u5c3d\u91cf\u585e\u6ee1\u7d27\u6328\u7740\u7684\u5c0f\u7c7b\u578b\uff1a</p> <ul> <li>112 + 112 + 32 = 256</li> <li>\u521a\u597d\u585e\u6ee1\u4e00\u4e2a 256 \u4f4d\u69fd\uff0c\u4e0d\u6d6a\u8d39\u3001\u4e0d\u591a\u7528 gas\u3002</li> </ul> <p>\u8fd9\u5c31\u662f\u201cpacked 256 bit storage slot\u201d\u7684\u542b\u4e49\uff1a\u4e24\u4e2a\u50a8\u5907 + 1 \u4e2a 32bit \u65f6\u95f4\u6233\uff0c\u6574\u6574\u9f50\u9f50\u653e\u5728\u4e00\u4e2a\u69fd\u91cc\u3002</p>"},{"location":"web3/defi/uniswap_v2_price_precision_240710/#22-32","title":"2.2 \u7d2f\u79ef\u4ef7\u683c\u5e03\u5c40\uff1a\u4e3a\u4ec0\u4e48\u9700\u8981\u989d\u5916\u768432\u4f4d\uff1f","text":"<p>\u767d\u76ae\u4e66\u63a5\u7740\u8bf4\uff1a</p> <p>although the price at any given moment (stored as a UQ112.112 number) is guaranteed to fit in 224 bits, the accumulation of this price over an interval is not. The extra 32 bits on the end of the storage slots for the accumulated price of A/B and B/A are used to store overflow bits resulting from repeated summations of prices.</p> <p>\u767d\u76ae\u4e66\u8bf4\uff1a\"\u867d\u7136\u4efb\u4f55\u7ed9\u5b9a\u65f6\u523b\u7684\u4ef7\u683c\u4fdd\u8bc1\u9002\u5408224\u4f4d\uff0c\u4f46\u8be5\u4ef7\u683c\u5728\u4e00\u4e2a\u533a\u95f4\u5185\u7684\u7d2f\u79ef\u5219\u4e0d\u7136\u3002\"</p> <ul> <li>\u77ac\u65f6\u4ef7\u683c\uff1aUQ112.112\uff0c\u7528 <code>uint224</code> \u5c31\u591f\u5b58\uff1b</li> <li>\u7d2f\u79ef\u4ef7\u683c\uff1a<code>priceCumulativeLast += price * timeElapsed</code>\uff0c<code>price</code> \u662f UQ112.112\uff08224 \u4f4d\uff09\uff0c<code>timeElapsed</code> \u662f <code>uint32</code> \u79d2\u6570\uff0c\u6bcf\u6b21\u4e58\u6cd5\u7ed3\u679c\u53ef\u80fd\u9700\u8981 224 + 32 = 256 \u4f4d\uff0c\u518d\u4e0d\u65ad\u7d2f\u52a0\uff0c\u80af\u5b9a\u4f1a\u201c\u7406\u8bba\u4e0a\u6ea2\u51fa 224 \u4f4d\u201d\u3002</li> </ul> <pre><code>if (timeElapsed &gt; 0 &amp;&amp; _reserve0 != 0 &amp;&amp; _reserve1 != 0) {\n    price0CumulativeLast += uint(\n        UQ112x112.encode(_reserve1).uqdiv(_reserve0)\n    ) * timeElapsed;\n    price1CumulativeLast += uint(\n        UQ112x112.encode(_reserve0).uqdiv(_reserve1)\n    ) * timeElapsed;\n}\n</code></pre> <p>\u6ce8\u610f\u51e0\u70b9\uff1a</p> <ul> <li><code>UQ112x112.encode(...).uqdiv(...)</code> \u8fd4\u56de\u7684\u662f\u4e00\u4e2a <code>uint224</code> \u7684 UQ112.112 \u6570\u3002</li> <li><code>uint(...)</code> \u8f6c\u6210 <code>uint256</code>\uff0c\u518d\u4e58 <code>timeElapsed (uint32)</code>\uff0c\u6574\u4f53\u7528 256 \u4f4d\u505a\u7b97\u672f\u3002</li> <li>\u6ea2\u51fa\u884c\u4e3a\u662f\u6309 <code>mod 2\u00b2\u2075\u2076</code> \u6765\u7684\uff08Solidity 0.5/0.6 \u4e0b\uff0c\u9ed8\u8ba4 wrap around\uff09\u3002</li> </ul> <p>\u76f4\u89c9\u7406\u89e3\uff1a\u201c\u6211\u7528 224 \u4f4d\u5b58\u4ef7\u683c\u5c0f\u6570\uff0c\u989d\u5916\u5f00\u4e86 32 \u4f4d\u5f53\u7f13\u51b2\u533a\uff0c\u7ed9\u957f\u671f\u7d2f\u52a0\u7559\u7a7a\u95f4\u3002\u771f\u6b63\u62ff\u6765\u7b97 TWAP \u662f\u7528\u5dee\u503c\u9664\u4ee5\u65f6\u95f4\u95f4\u9694\uff0c\u6240\u4ee5\u53ea\u8981\u4e0b\u6e38\u7528\u540c\u6837\u7684 \u2018\u53d6\u6a21 + \u6ea2\u51fa\u5b89\u5168\u7b97\u672f\u2019\uff0c\u5c31\u80fd\u6b63\u786e\u6062\u590d\u5e73\u5747\u503c\u3002\u201d</p>"},{"location":"web3/defi/uniswap_v2_price_precision_240710/#32","title":"\u4e09\u3001\u65f6\u95f4\u6233\u768432\u4f4d\u9650\u5236\u4e0e\u6ea2\u51fa\u5b89\u5168","text":"<p>\u767d\u76ae\u4e66\u8fd9\u6bb5\u8bdd\u662f\u5bb9\u6613\u7591\u60d1\u7684\u5730\u65b9\uff1a</p> <p>The primary downside is that 32 bits isn't quite enough to store timestamp values that will reasonably never overflow. In fact, the date when the Unix timestamp overflows a uint32 is 02/07/2106. To ensure that this system continues to function properly after this date, and every multiple of 2\u00b3\u00b2 - 1 seconds thereafter, oracles are simply required to check prices at least once per interval (approximately 136 years). This is because the core method of accumulation (and modding of timestamp), is actually overflow-safe, meaning that trades across overflow intervals can be appropriately accounted for given that oracles are using the proper (simple) overflow arithmetic to compute deltas.</p> <p>\u7ffb\u8bd1\u6210\u4e2d\u6587\u6765\u7406\u89e3\uff1a</p> <p>32 \u4f4d\u7684\u4e3b\u8981\u7f3a\u70b9\u5728\u4e8e\uff1a\u5b83\u4e0d\u8db3\u4ee5\u5b58\u50a8\u201c\u6c38\u8fdc\u4e0d\u4f1a\u6ea2\u51fa\u201d\u7684\u65f6\u95f4\u6233\u503c\u3002\u4e8b\u5b9e\u4e0a\uff0cUnix \u65f6\u95f4\u6233\u5728 <code>uint32</code> \u4e2d\u6ea2\u51fa\u7684\u65e5\u671f\u662f 2106 \u5e74 2 \u6708 7 \u65e5\u3002\u4e3a\u4e86\u786e\u4fdd\u8fd9\u4e2a\u7cfb\u7edf\u5728\u8be5\u65e5\u671f\u4e4b\u540e\u4ecd\u80fd\u6b63\u5e38\u8fd0\u884c\uff0c\u5e76\u5728\u4e4b\u540e\u6bcf\u7ecf\u8fc7 <code>2\u00b3\u00b2 - 1</code> \u79d2\uff08\u5927\u7ea6 136 \u5e74\uff09\u518d\u6b21\u6ea2\u51fa\u65f6\u7ee7\u7eed\u6b63\u5e38\u5de5\u4f5c\uff0c\u9884\u8a00\u673a\uff08oracles\uff09\u53ea\u9700\u8981\u505a\u5230\u4e00\u4ef6\u4e8b\uff1a\u5728\u6bcf\u4e2a\u5468\u671f\u91cc\u81f3\u5c11\u68c0\u67e5\u4e00\u6b21\u4ef7\u683c\uff08\u4e5f\u5c31\u662f\u5927\u7ea6\u6bcf 136 \u5e74\u68c0\u67e5\u4e00\u6b21\uff09\u3002</p> <p>\u8fd9\u662f\u56e0\u4e3a\u7d2f\u79ef\uff08accumulation\uff09\u4ee5\u53ca\u5bf9\u65f6\u95f4\u6233\u8fdb\u884c\u53d6\u6a21\uff08modding of timestamp\uff09\u7684\u6838\u5fc3\u65b9\u6cd5\u672c\u8eab\u662f\u6ea2\u51fa\u5b89\u5168\u7684\u3002\u53ea\u8981\u9884\u8a00\u673a\u5728\u8ba1\u7b97\u65f6\u95f4\u5dee\uff08delta\uff09\u65f6\u4f7f\u7528\u6b63\u786e\u7684\uff08\u7b80\u5355\u7684\uff09\u6ea2\u51fa\u7b97\u672f\uff0c\u5373\u4f7f\u4ea4\u6613\u8de8\u8d8a\u4e86\u65f6\u95f4\u6233\u6ea2\u51fa\u7684\u95f4\u9694\uff0c\u4e5f\u4ecd\u7136\u80fd\u591f\u88ab\u6b63\u786e\u8bb0\u8d26\u3002</p>"},{"location":"web3/defi/uniswap_v2_price_precision_240710/#31-mod-232","title":"3.1 \u4e3a\u4ec0\u4e48\u65f6\u95f4\u6233\u8981 mod 2\u00b3\u00b2\uff1f","text":"<p>\u8fd9\u8ddf\u524d\u9762\u8bf4\u7684\u201c\u4e24\u4e2a <code>uint112</code> + \u4e00\u4e2a <code>uint32</code> \u62fc\u5728\u540c\u4e00\u69fd\u201d\u662f\u540c\u4e00\u4e2a\u8bbe\u8ba1\uff1a</p> <p><code>block.timestamp</code> \u662f\u4e00\u4e2a\u4e0d\u65ad\u589e\u5927\u7684 Unix \u65f6\u95f4\u6233\uff08\u79d2\uff09\uff0c\u4e3a\u4e86\u585e\u8fdb 32 \u4f4d\uff0c\u8981\u505a\uff1a<code>uint32 blockTimestamp = uint32(block.timestamp % 2**32)</code>\uff0c\u5b58\u7684\u65f6\u5019\u53ea\u4fdd\u7559\u4f4e 32 \u4f4d\uff08\u5bf9 2\u00b3\u00b2 \u53d6\u6a21\uff09\u3002</p> <p>\u66f4\u65b0\u65f6 <code>_update()</code> \u7684\u6d41\u7a0b\uff08\u7b80\u5316\uff09\uff1a</p> <pre><code>uint32 blockTimestamp = uint32(block.timestamp % 2**32);\nuint32 timeElapsed = blockTimestamp - blockTimestampLast; // \u6ce8\u610f\uff1a\u8fd9\u662f uint32 \u51cf\u6cd5\n// timeElapsed \u5c31\u662f\u201c\u81ea\u4e0a\u6b21\u66f4\u65b0\u4ee5\u6765\u7ecf\u8fc7\u7684\u79d2\u6570\u201d\uff0c\u4f46\u6709\u6ea2\u51fa\u8bed\u4e49\n</code></pre> <p>\u8fd9\u4e00\u6b65\u7684\u5173\u952e\uff1a<code>uint32</code> \u7684\u51cf\u6cd5\u5728\u6ea2\u51fa\u65f6\u81ea\u52a8\u6309 2\u00b3\u00b2 \u53d6\u6a21\u3002</p> <p>\u5728\u6ca1\u6ea2\u51fa\u7684\u4e00\u822c\u60c5\u51b5\u4e0b\uff1a<code>timeElapsed = current - last</code></p> <p>\u5728\u7ecf\u5386\u8fc7\u4e00\u6b21 2\u00b3\u00b2 \u6ea2\u51fa\uff08\u65f6\u95f4\u6233\u7ed5\u4e86\u4e00\u5708\uff09\uff1a\u5047\u8bbe <code>last = 2\u00b3\u00b2 - 10</code>\uff0c<code>current = 5</code>\uff08\u7ed5\u4e86\u4e00\u5708 +5 \u79d2\uff09\uff0c<code>timeElapsed = 5 - (2\u00b3\u00b2 - 10)</code>\uff0c\u5728 <code>uint32</code> \u4e0b\u7b49\u4ef7\u4e8e\uff1a<code>timeElapsed = 5 + 10 = 15</code>\uff0c\u4e5f\u5c31\u662f\uff1a\u5b9e\u9645\u7ecf\u8fc7\u7684\u65f6\u95f4\uff0810 \u79d2\u5230\u5708\u5c3e + 5 \u79d2\u5230\u5f53\u524d\uff09\u3002</p> <p>\u8fd9\u5c31\u662f\u767d\u76ae\u4e66\u6240\u8bf4\u7684\u201coverflow-safe accumulation\u201d\uff1a\u53ea\u8981\u59cb\u7ec8\u7528\u540c\u6837\u7684 32 \u4f4d\u53d6\u6a21 + \u6ea2\u51fa\u8bed\u4e49\uff0c\u4e0d\u9700\u8981\u5173\u5fc3\u65f6\u95f4\u6233\u201c\u7ed5\u4e86\u51e0\u5708\u201d\uff0c\u6bcf\u6b21 delta \u90fd\u662f\u6b63\u786e\u7684\u3002</p>"},{"location":"web3/defi/uniswap_v2_price_precision_240710/#32_1","title":"3.2 \u4e3a\u4ec0\u4e48\u8bf4\u201c\u6ea2\u51fa\u5b89\u5168\u201d\uff1f","text":"<p>2\u00b3\u00b2 \u79d2 \u2248 4,294,967,296 \u79d2 \u2248 136 \u5e74\u3002</p> <p>\u6838\u5fc3\u95ee\u9898\u5728\u4e8e\uff1aTWAP \u7684\u8c03\u7528\u65b9\u4e5f\u8981\u7528\u540c\u6837\u7684\u6ea2\u51fa\u7b97\u672f\u3002</p> <p>\u8c03\u7528\u65b9\u901a\u5e38\u8fd9\u6837\u7b97\u4ef7\u683c\uff08\u6765\u81ea\u767d\u76ae\u4e66 2.2\uff09\uff1a</p> <ul> <li>\u5728 t1 \u65f6\u523b\u8bfb\u53d6\u4e00\u6b21 priceCumulativeLast\uff0c\u8bb0\u4f5c a1</li> <li>\u5728 t2 \u65f6\u523b\u518d\u8bfb\u4e00\u6b21 a2</li> <li>TWAP \u2248 (a2 - a1) / (t2 - t1)</li> </ul> <p>\u5982\u679c\uff1a</p> <ul> <li>t1 \u548c t2 \u4e4b\u95f4\u8de8\u8d8a\u4e86\u591a\u6b21 2\u00b3\u00b2 \u6ea2\u51fa\u5468\u671f\uff08\u6bd4\u5982\u9694\u4e86 300 \u5e74\uff0c\u7ed5\u4e86\u4e24\u5708\u591a\uff09\uff0c\u90a3\u4e48\u5355\u7eaf\u7528 32 \u4f4d\u65f6\u95f4\u6233\u5dee\u503c\u5c31\u4e0d\u591f\u533a\u5206\u4e86\u3002</li> <li>\u4f46\u53ea\u8981\u6bcf\u4e2a 2\u00b3\u00b2 \u79d2\uff08\u7ea6 136 \u5e74\uff09\u5185\u81f3\u5c11\u8bfb\u4e00\u6b21\uff0c\u4f60\u4e0d\u4f1a\u8de8\u8d8a\u8d85\u8fc7\u4e00\u5708\u7684\u6a21\u6570\uff0ct2 - t1 \u7684 32 \u4f4d\u6ea2\u51fa\u8bed\u4e49\u4ecd\u80fd\u6b63\u786e\u4ee3\u8868\u771f\u5b9e\u7ecf\u8fc7\u7684\u79d2\u6570\u3002</li> </ul> <p>\u4e3e\u4e2a\u4f8b\u5b50\uff1a\u5047\u8bbe</p> <ul> <li>t1 =2^32-100\uff08\u6ea2\u51fa\u524d100\u79d2\uff09</li> <li>t2 =50\uff08\u6ea2\u51fa\u540e50\u79d2\uff0c\u5b9e\u9645\u65f6\u95f4\u6233\uff09</li> </ul> <p>\u76f4\u63a5\u76f8\u51cf\u4f1a\u51fa\u9519\uff1a<code>50 - (2^32 - 100) = \u8d1f\u6570</code>\uff0c\u4f46\u4f7f\u7528 <code>uint32</code> \u7684\u6a21\u8fd0\u7b97\uff1a</p> <p>\u65f6\u95f4\u5dee = <code>uint32(t2 - t1) = uint32(50-(2^32-100)) = uint32(-2^32+150)</code> = 150 \u79d2</p> <p>\u53ea\u8981\u4e24\u6b21\u91c7\u6837\u95f4\u9694 &lt; 2^32\u79d2\uff08136\u5e74\uff09\uff0c\u8ba1\u7b97\u5c31\u662f\u6b63\u786e\u7684\u3002</p>"}]}