## 1. Solidity åœ°å€ç±»å‹

åœ°å€ç±»å‹ï¼ˆ`address`ï¼‰ç”¨äºå­˜å‚¨ä¸€ä¸ª 20 å­—èŠ‚çš„å€¼ï¼ˆä»¥å¤ªåŠåœ°å€çš„å¤§å°ï¼‰ã€‚å®ƒä¸ä»…ä»…æ˜¯ä¸€ä¸ªå­˜å‚¨å•ä½ï¼Œè¿˜æä¾›äº†ä¸ä»¥å¤ªåŠè´¦æˆ·äº¤äº’çš„å¤šç§æ–¹å¼ï¼Œå¯¹äºç¼–å†™æ™ºèƒ½åˆçº¦è‡³å…³é‡è¦ã€‚

> æ³¨ï¼šè¿™äº›è´¦æˆ·å¯ä»¥æ˜¯å¤–éƒ¨è´¦æˆ·ï¼ˆç”±ç”¨æˆ·æ§åˆ¶çš„è´¦æˆ·ï¼Œæ‹¥æœ‰ç§é’¥ï¼‰æˆ–åˆçº¦è´¦æˆ·ï¼ˆç”±åˆçº¦ä»£ç æ§åˆ¶çš„è´¦æˆ·ï¼‰ã€‚

Solidity ä¸­æœ‰ä¸¤ç§åœ°å€ç±»å‹ï¼š

- **address**ï¼šæ™®é€šåœ°å€ï¼Œä¸èƒ½æ¥æ”¶ ETHï¼Œå³ä¸èƒ½è°ƒç”¨ `transfer` / `send` / `call{value: ...}` ç­‰æ–¹æ³•ï¼›
- **address payable**ï¼šèƒ½æ¥æ”¶ ETHï¼Œæ”¯æŒè°ƒç”¨ `transfer` / `send` / `call{value: ...}` ç­‰æ–¹æ³•ï¼›

> æ³¨ï¼šä¸ ETH ç›¸å…³çš„æ“ä½œï¼ˆè½¬è´¦ã€æ”¶æ¬¾ï¼‰ï¼Œéƒ½å¿…é¡»ä½¿ç”¨ address payableã€‚

å¯¹äº `address` ç±»å‹ï¼Œå¸¸ç”¨çš„å±æ€§åŒ…æ‹¬ï¼š

- `balance`ï¼šè·å–åœ°å€ä¸­çš„ ETH ä½™é¢ï¼›
- `code`ï¼ˆSolidity ^0.8.0ï¼‰ï¼šè·å–åœ°å€ä¸­å­˜å‚¨çš„åˆçº¦ä»£ç ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰ï¼Œæ­¤å±æ€§åœ¨ Solidity 0.8.0 ä»¥åç‰ˆæœ¬ä¸­æ–°å¢ï¼›
- `codehash`ï¼ˆSolidity ^0.8.0ï¼‰ï¼šè·å–åœ°å€çš„åˆçº¦ä»£ç çš„å“ˆå¸Œå€¼ï¼ˆå¦‚æœåœ°å€ä¸ºåˆçº¦åœ°å€ï¼‰ï¼Œå¦‚æœåœ°å€æ˜¯å¤–éƒ¨è´¦æˆ·æˆ–åˆçº¦ä¸­æ²¡æœ‰ä»£ç ï¼Œåˆ™è¿”å›é›¶å“ˆå¸Œï¼›

å¯¹äº `address payable` ç±»å‹ï¼Œé™¤ `address` ç±»å‹çš„å±æ€§å¤–ï¼Œè¿˜åŒ…æ‹¬ä¸‰ç§ä¸ ETH è½¬è´¦ç›¸å…³çš„æ–¹æ³•ï¼š

- `transfer(uint256 amount)`ï¼šå›ºå®š 2300 gas ä¾›å¯¹æ–¹ fallback/receive ä½¿ç”¨ï¼Œå¤±è´¥ä¼šç›´æ¥ `revert`ï¼Œæ–°ç‰ˆæœ¬é‡Œå› ä¸º gas æ”¿ç­–ä¸ç¨³å®šï¼Œ**å®˜æ–¹å·²ç»ä¸æ¨èç”¨ `transfer` å’Œ `send` äº†**ï¼›
- `send(uint256 amount) returns (bool)`ï¼š2300 gas é™åˆ¶ï¼Œè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼è¡¨ç¤ºæˆåŠŸä¸å¦ï¼Œä¸ä¼šåœ¨å¤±è´¥æ—¶ `revert`ï¼Œè‡ªå·±å†³å®šè¦ä¸è¦ `require`ï¼›
- `call(bytes memory data) returns (bool, bytes memory)`ï¼šå‘åœ°å€å‘é€ ETHï¼Œå¯åŒæ—¶è°ƒç”¨å…¶åˆçº¦å‡½æ•°ï¼Œè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼è¡¨ç¤ºæˆåŠŸä¸å¦å’Œè¿”å›æ•°æ®ã€‚

| å‡½æ•°              | æ˜¯å¦æ¨è   | å¤±è´¥æ˜¯å¦ revert  | Gas é™åˆ¶ |
| ----------------- | ---------- | ---------------- | -------- |
| `transfer`        | âŒ ä¸æ¨è   | âœ”ï¸ è‡ªåŠ¨ revert    | 2300 gas |
| `send`            | âŒ ä¸æ¨è   | âŒ è¿”å› false     | 2300 gas |
| `call{value:...}` | âœ”ï¸ æ¨èæ ‡å‡† | âŒ éœ€æ‰‹åŠ¨ require | æ— é™åˆ¶   |

éœ€è¦è½¬è´¦æ—¶ï¼Œå»ºè®®ä½¿ç”¨ `call` æ–¹æ³•ï¼Œå› ä¸º `transfer` ä¸ `send` æ–¹æ³•å­˜åœ¨ Gas é™åˆ¶ï¼ˆåªæä¾›2300 Gasï¼Œè¿™è¶³ä»¥è®°å½•äº‹ä»¶ï¼Œä½†ä¸è¶³ä»¥è¿›è¡Œæ›´å¤æ‚çš„æ“ä½œï¼‰ï¼Œè€Œ `call` æ¯”è¾ƒçµæ´»ã€‚

## 2. åœ°å€ä¸å¤–éƒ¨åˆçº¦äº¤äº’ï¼ˆæ¥å£ç±»å‹è½¬æ¢ï¼‰

### 2.1 ä¸ºä»€ä¹ˆè½¬æ¢æˆæ¥å£ç±»å‹ï¼Ÿ

ä»¥å¤ªåŠä¸–ç•Œé‡Œï¼š

- æ¯ä¸ªåˆçº¦ = ä¸€æ®µéƒ¨ç½²åœ¨é“¾ä¸Šçš„ä»£ç 
- æ¯ä¸ªåˆçº¦ = ä¸€ä¸ªç‹¬ç«‹çš„åœ°å€ï¼ˆaddressï¼‰

ä½† `address` æœ¬è´¨åªæ˜¯ **20 å­—èŠ‚æ•°å­—**ï¼Œå¹¶æ²¡æœ‰â€œå‡½æ•°ä¿¡æ¯â€ï¼Œå› æ­¤ï¼š

âŒ address ä¸çŸ¥é“è¿™ä¸ªåœ°å€å¯¹åº”å“ªç§åˆçº¦

âŒ address ä¸çŸ¥é“é‡Œé¢æœ‰å“ªäº›å‡½æ•°

âŒ address ä¸èƒ½ç›´æ¥è°ƒç”¨ transferã€approveã€swap ç­‰å‡½æ•°

ä¾‹å¦‚ï¼š

```solidity
address token = 0x...;
token.transfer(to, amount); // âŒ ç¼–è¯‘é”™è¯¯
```

å› ä¸º `address` ç±»å‹æ²¡æœ‰ `transfer` æ–¹æ³•ã€‚

Solidity æ˜¯å¼ºç±»å‹è¯­è¨€ï¼Œå¿…é¡»æ˜ç¡®å‘Šè¯‰å®ƒï¼šè¿™ä¸ª address æ˜¯ä»€ä¹ˆç±»å‹çš„åˆçº¦ï¼

æ‰€ä»¥æˆ‘ä»¬æ‰éœ€è¦ï¼š

âœ… å…ˆå®šä¹‰æ¥å£ï¼ˆInterfaceï¼‰â€”â€”æè¿°åˆçº¦å‡½æ•°

âœ… å†æŠŠ `address` å¼ºåˆ¶è½¬æ¢æˆæ¥å£ç±»å‹

âœ… æœ€åç”¨æ¥å£æ¥è°ƒç”¨å‡½æ•°

### 2.2 åœ°å€è½¬æ¥å£å¹¶è°ƒç”¨å‡½æ•°ï¼ˆæ ¸å¿ƒè¯­æ³•ï¼‰

å…¸å‹å†™æ³•ï¼š`IERC20(tokenAddress).transfer(to, amount)`

ä»£ç å«ä¹‰ï¼š

1. `tokenAddress` â€”â€” è¿™æ˜¯ ERC20 åˆçº¦éƒ¨ç½²åœ¨é“¾ä¸Šçš„åœ°å€ï¼›
2. `IERC20(tokenAddress)` â€”â€” å‘Šè¯‰ Solidityï¼šæŒ‰ ERC20 æ¥å£çš„è§„èŒƒè®¿é—®è¿™ä¸ª `address`ï¼›
3. `.transfer(...)` â€”â€” ç¼–è¯‘å™¨æ£€æŸ¥å‚æ•°ç±»å‹ã€è¿”å›å€¼ï¼›
4. ç¼–è¯‘åæ‰§è¡Œä½çº§ callï¼ˆABI ç¼–ç ï¼ŒEVM æ‰§è¡Œï¼‰ï¼›

### 2.3 æœ€å¸¸ç”¨åœºæ™¯ï¼šæŠŠ address å‚¨å­˜èµ·æ¥ï¼Œç„¶åäº¤äº’

ä¾‹å¦‚ DEXã€Vaultã€Staking åˆçº¦éƒ½è¿™ä¹ˆå†™ï¼š

```solidity
contract Test {
  address public token; // ä¿å­˜ä»£å¸åˆçº¦åœ°å€

  function setToken(address _token) external {
    token = _token;
  }

  function transferOut(address to, uint256 amount) external {
    // address â†’ IERC20
    bool ok = IERC20(token).transfer(to, amount);
    require(ok, "transfer failed");
  }
}
```

ä¸ºä»€ä¹ˆä¸èƒ½ç›´æ¥ç”¨ `address`ï¼Ÿå› ä¸º `address` æ²¡æœ‰ `transfer` å‡½æ•°ã€‚

### 2.4 å®‰å…¨æ³¨æ„äº‹é¡¹

**1ï¼‰ç¡®ä¿è½¬æ¢çš„ `address` æ˜¯æœŸæœ›çš„åˆçº¦åœ°å€**

å¦‚æœç”¨æˆ·ä¼ å…¥æ¶æ„åœ°å€ï¼š`IERC20(fakeAddress).transfer(...)`ï¼Œä¼šè°ƒåˆ°é”™è¯¯é€»è¾‘ æˆ– fallbackï¼Œè§¦å‘æ¶æ„ä»£ç ã€‚

æ‰€ä»¥å¸¸è§åšæ³•ï¼š

- âœ” ç™½åå•ï¼›
- âœ” constructor é‡Œå†™æ­»åœ°å€ï¼›
- âœ” ä½¿ç”¨ immutable å¸¸é‡ï¼›
- âœ” ä»… owner å¯ä¿®æ”¹ token åœ°å€ï¼›

**2ï¼‰ä½¿ç”¨ `try/catch`ï¼ˆé€‚åˆå¤–éƒ¨åˆçº¦ä¸ç¨³å®šæ—¶ï¼‰**

```solidity
try IERC20(token).transfer(to, amount) returns (bool ok) {
  require(ok, "failed");
} catch {
  revert("token call failed");
}
```

**3ï¼‰æ°¸è¿œä¸è¦ç”¨ `address` å†å»è°ƒç”¨æœªçŸ¥åˆçº¦çš„ send/transferï¼ˆæ—§å†™æ³•ï¼‰**

æ—§å†™æ³•æœ‰é£é™©ï¼š`payable(addr).transfer(amount);` // å¯èƒ½å¤±è´¥

æ”¹ç”¨ï¼š

```solidity
(bool ok,) = payable(addr).call{value: amount}("");
require(ok);
```

æ€»ç»“ï¼š

| æ­¥éª¤                        | ç›®çš„                             |
| --------------------------- | -------------------------------- |
| ğŸ”¹ å†™æ¥å£ Interface          | å‘Šè¯‰ Solidity è¿™ä¸ªåˆçº¦æœ‰å“ªäº›å‡½æ•° |
| ğŸ”¹ ç”¨ `IERC20(tokenAddress)` | æŠŠ address è½¬æˆæ¥å£ç±»å‹          |
| ğŸ”¹ ç”¨æ¥å£è®¿é—®å‡½æ•°            | å®‰å…¨ã€ç±»å‹æ£€æŸ¥ã€è‡ªåŠ¨ ABI ç¼–ç     |
| ğŸ”¹ ç”¨åœ°å€ä¿å­˜åˆçº¦åœ°å€        | åˆçº¦é—´äº¤äº’                       |

## 3. åœ°å€ + æ˜ å°„ / æ•°ç»„ï¼šè®°è´¦ & å…³ç³»

### 3.1 åœ°å€ + æ˜ å°„

`mapping(address => uint256)` æ˜¯æœ€å¸¸è§çš„ç”¨æ³•ä¹‹ä¸€ï¼Œä¾‹å¦‚ ERC20 çš„ä½™é¢è¡¨ï¼š

```solidity
mapping(address => uint256) public balanceOf;

function mint(uint256 amount) external {
    balanceOf[msg.sender] += amount;
}
```

å¤šå±‚ mappingï¼ˆæ¯”å¦‚ allowanceï¼‰ï¼š

```solidity
mapping(address => mapping(address => uint256)) public allowance;

function approve(address spender, uint256 amount) external {
    allowance[msg.sender][spender] = amount;
}
```

 `mapping` é‡Œçš„ key ç”¨ `address` éå¸¸è‡ªç„¶ï¼Œè€Œä¸”ä¼šè‡ªåŠ¨åˆå§‹åŒ–ä¸º 0ï¼Œä¸å­˜åœ¨åˆ™è¿”å›é»˜è®¤å€¼ã€‚

### 3.2 åœ°å€ + æ•°ç»„

`address[]`ï¼Œæ•°ç»„é‡Œçš„å…ƒç´ å¯ä»¥æ˜¯ `address` æˆ– `address payable`ï¼Œçœ‹ä½ è¦ä¸è¦ç»™ä»–ä»¬è½¬è´¦ã€‚

æ¯”å¦‚è®°å½•æ‰€æœ‰å­˜æ¬¾è¿‡çš„ç”¨æˆ·ï¼š

```solidity
address[] public users;
mapping(address => bool) public hasDeposited;

function deposit() external payable {
    if (!hasDeposited[msg.sender]) {
        hasDeposited[msg.sender] = true;
        users.push(msg.sender);
    }
}
```

## 4. ç‰¹æ®Šåœ°å€

`msg.sender` â€“ å½“å‰åˆçº¦çš„è°ƒç”¨è€…ï¼Œå¯èƒ½æ˜¯å¤–éƒ¨è´¦æˆ·ï¼Œä¹Ÿå¯èƒ½æ˜¯å¦ä¸€ä¸ªåˆçº¦ã€‚

`tx.origin` â€“ äº¤æ˜“æœ€åŸå§‹å‘èµ·äººï¼Œå®¹æ˜“è¢«ã€Œä¸­é—´åˆçº¦ã€éª—è°ƒç”¨ï¼Œå¯¼è‡´é’“é±¼æ”»å‡»ï¼Œæƒé™æ§åˆ¶ç”¨ `msg.sender` å°±å¤Ÿäº†ã€‚

`address(this)` - åˆçº¦è‡ªå·±çš„åœ°å€ã€‚
